<!DOCTYPE html>
<html layout:decorate="~{layouts/main_staff}">
<head>
<script th:src="@{/resources/bootpag/js/bootpag.min.js}">
</script>
<script th:inline="javascript">

function base64ToArrayBuffer(base64) {
    var binaryString = window.atob(base64);
    var binaryLen = binaryString.length;
    var bytes = new Uint8Array(binaryLen);
    for (var i = 0; i < binaryLen; i++) {
       var ascii = binaryString.charCodeAt(i);
       bytes[i] = ascii;
    }
    return bytes;
 }

function saveByteArray(reportName, byte) {

 var fileType = "application/zip";
    var blob = new Blob([byte], {type: fileType});
    var link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    var fileName = reportName;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
};

	function triggerDownload() {
		
		const validateResponse = (result) => {
			if(result.status== 200)
				console.log(result);
				console.log(result.body);
				console.log(result.data);
							
				var data = result.body;
/* 	 			var sampleArr = base64ToArrayBuffer(result.body); 
 */	         	var fileName = "nme.zip";
	        	console.log(fileName)
	        	saveByteArray(fileName, sampleArr);
				return true;
			return false;
		}
		
		const triggerExhibitionDownload = () => {
		
			maxAttempts = 10;
			interval= 3000;
			  console.log('Start poll...');
			  let attempts = 0;

			  const executePoll = async (resolve, reject) => {
				    console.log('- poll');
				    const result = await fetch([[@{/staff/exhibit/download/trigger?}]]+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]]);
				    console.log("attemps");
				    attempts++;

				    if ( validateResponse(result)  ) {
				    	console.log("succes");
				    	
				    	
				      return resolve(result);
				    } else if (maxAttempts && attempts === maxAttempts) {
		
				      return reject(new Error('Exceeded max attempts'));
				    } else {
      					setTimeout( executePoll, interval, resolve, reject  );

 
 			    }
				  };

				  return new Promise(executePoll);
		
		};
		
		triggerExhibitionDownload()
		.then(value => console.log("then " + value.data))
		.catch(err => console.error(err))
	

/* 		triggerExhibitionDownload.then((value) => {
			  console.log(value);
			  // expected output: "Success!"
			});

		
	/* 	const triggerExhibitionDownload = async () => {
			console.log("trigger")
			    const request = await fetch("@{/staff/exhibit/download/trigger}");
			    
			    const data = await request.json();
			    return data;
			  }; 
			  const getExhibitionDownload = async (newUrl) => {
			      const request = await fetch(newUrl);
			      const data = await request.json();
			      return data;
			    }
		console.log("in")
		triggerExhibitionDownload.then(response => {
			  console.log(response);
			  getExhibitionDownload.then(resource  => {
				  console.log(resource);
			  })
			  
		}) */
	}
  


  
  
</script>
<style>
.pagination>li>a {
    border: 1px solid var(--primary);
    padding: 5px;
    color: var(--primary);
    font-size: 15px;
}

.pagination>li.active>a {
    background: var(--primary);
    color: #fff;
    font-size: 15px;
}

.img-thumbnail {
    height: 100px;
    width: 140px;
}
</style>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
<div layout:fragment="content" class="main-content">
	<span class = "errorAdd"></span>

<!-- 	<a th:href="@{/staff/exhibit/download}" class="download btn primary-btn" style="float: right" >Download</a>
 -->	
 	<button class="download btn primary-btn" onclick="triggerDownload()">Download</button>
 	 <h2>Downloads</h2>
	 <table class="table">
	  <thead>
                <tr>
                    <th scope="col" sort-prop="filename"><a
                        href="#">Creation date</a></th>
                    <th scope="col" sort-prop="name"><a href="#">Created by</a></th>
                
                     <th scope="col" >View</th>


                </tr>
            </thead>
	 <tbody class="tableBody">
                <tr th:each="exhibitionDownload:  ${downloadsList}">
                    <th scope="row">[[${exhibitionDownload.creationDate}]]</th>
                 
                    <td>[[${exhibitionDownload.createdBy}]]</td>
                    <td><a th:href="@{'/staff/exhibit/download/'+${exhibitionDownload.id}(folderName=${exhibitionDownload.folderName})}" ><span class="btn primary-btn btn-sm">Download</span></a></td>
               </tr>
            </tbody>
	 
</table>
</div>
</body>
</html>