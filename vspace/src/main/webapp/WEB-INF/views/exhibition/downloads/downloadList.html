<!DOCTYPE html>
<html layout:decorate="~{layouts/main_staff}">
<head>
<script th:src="@{/resources/bootpag/js/bootpag.min.js}">
</script>
<script th:inline="javascript">

	function triggerExhibitionDownload()
	{ 
			
	

		 $.ajax({
				type : "GET",
				url : "[(@{'/staff/exhibit/download/trigger?'+ ${_csrf.parameterName}+'='+${_csrf.token} })] ",
				cache : false,
				
				contentType : false,
				processData : false,
				
				success : function(data) {
					console.log(data.id);
 					downloadExhibitionFolder(data.id, data.folderName);
 		

				
				},
				error : function(data) {
	
				}
			});
	/* 	 $.ajax({
			    type: "GET",
		        url: "[[@{/staff/exhibit/download/trigger}]]",       
		        cache: false,
		        contentType : false,
		        success: function(data) {
		        	console.log(data);
		        	downloadExhibitionFolder(data);
		        },
		        error: function(data) {
					console.log("error");
		        }
		    }); */
		
	}
	function base64ToArrayBuffer(base64) {
	    var binaryString = window.atob(base64);
	    var binaryLen = binaryString.length;
	    var bytes = new Uint8Array(binaryLen);
	    for (var i = 0; i < binaryLen; i++) {
	       var ascii = binaryString.charCodeAt(i);
	       bytes[i] = ascii;
	    }
	    return bytes;
	 }

	function saveByteArray(reportName, byte) {

	 var fileType = "application/zip";
	    var blob = new Blob([byte], {type: fileType});
	    var link = document.createElement('a');
	    link.href = window.URL.createObjectURL(blob);
	    var fileName = reportName;
	    link.download = fileName;
	    document.body.appendChild(link);
	    link.click();
	}
	function downloadExhibitionFolder(id, folderName) {
		
		
		const validateResponse = (result) => {
			console.log("in validate" + result);
			if(result.status == 200) {
				var data = result.body;
 	 			var sampleArr = base64ToArrayBuffer(result.body); 
          	    var fileName = "nme.zip";
	        	console.log(fileName)
	        	saveByteArray(fileName, sampleArr);
				return true;

			}
			return false;
		}
		
		
		 const download = (id, folderName) => {

				
				maxAttempts = 2;
				interval= 3000;
				  console.log('Start poll...');
				  let attempts = 0;

				  const executePoll = async (resolve, reject) => {
					    console.log('- poll');
						console.log("id" + id);
						console.log("folderName" + folderName);
					  	const  url = "[(@{'/staff/exhibit/download/'})]"+id+"?folderName="+folderName+','+ [[${_csrf.parameterName}]]+'='+[[${_csrf.token}]];			  
						const result = await fetch(url);
						console.log("attemps" + attempts);
					    attempts++;

					    if ( validateResponse(result)  ) {
					    	console.log("succes");
					    	
					    	
					      return resolve(result);
					    } else if (maxAttempts && attempts === maxAttempts) {
			
					      return reject(new Error('Exceeded max attempts'));
					    } else {
		  					setTimeout( executePoll, interval, resolve, reject  );


					    }
					  };

					  return new Promise(executePoll);
			
			};
			
			download(id, folderName)
			.then(value => console.log("then " + value))
			.catch(err => console.error(err)) 
		 
	}

</script>
<style>
.pagination>li>a {
    border: 1px solid var(--primary);
    padding: 5px;
    color: var(--primary);
    font-size: 15px;
}

.pagination>li.active>a {
    background: var(--primary);
    color: #fff;
    font-size: 15px;
}

.img-thumbnail {
    height: 100px;
    width: 140px;
}
</style>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
<div layout:fragment="content" class="main-content">
	<span class = "errorAdd"></span>
 	<button class="download btn primary-btn" onClick="triggerExhibitionDownload()">Download</button>
 	 <h2>Downloads</h2>
	 <table class="table">
	  <thead>
                <tr>
                    <th scope="col" sort-prop="filename"><a
                        href="#">Creation date</a></th>
                    <th scope="col" sort-prop="name"><a href="#">Created by</a></th>
                
                     <th scope="col" >View</th>


                </tr>
            </thead>
	 <tbody class="tableBody">
                <tr th:each="exhibitionDownload:  ${downloadsList}">
                    <th scope="row">[[${exhibitionDownload.creationDate}]]</th>
                 
                    <td>[[${exhibitionDownload.createdBy}]]</td>
                    <td><a th:href="@{'/staff/exhibit/download/'+${exhibitionDownload.id}(folderName=${exhibitionDownload.folderName})}" ><span class="btn primary-btn btn-sm">Download</span></a></td>
               </tr>
            </tbody>
	 
</table>
</div>
</body>
</html>