<!DOCTYPE html>
<html layout:decorate="~{layouts/main_staff}">
<head>
<script th:src="@{/resources/bootpag/js/bootpag.min.js}">
</script>
<script th:inline="javascript">
$(document).ready(function($) {
	$("#downloads").addClass("active");	
	$('.downloadPage-selection').bootpag({
	total: [[${downloadsTotalPages}]],
	page: [[${downloadsCurrentPageNumber}]],
	maxVisible: 10,
	leaps: true,
	firstLastUse: true,
	first: '|<',
	last: '>|',
	wrapClass: 'pagination',
	activeClass: 'active',
	disabledClass: 'disabled',
	nextClass: 'next',
	prevClass: 'prev',
	lastClass: 'last',
	firstClass: 'first'
	}).on("page", function(event, num){
		console.log(num);
		window.location.assign("[(@{'/staff/downloads/list'})]"+'?'+"downloadsPagenum="+num);
	});
	
	 $.ajax({
			type : "GET",
			url : "[(@{'/staff/exhibit/snapshotTask/status?'+ ${_csrf.parameterName}+'='+${_csrf.token} })] ",
			cache : false,
			
			contentType : false,
			processData : false,
			
			success : function(data) {
				console.log(data.id);
				downloadExhibitionFolder(data.id, data.folderName);
				
			},
			error : function(data) {
				var loader = document.getElementById('downloadLoader');
				loader.style.visibility="hidden";
				
				var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>Snapshot could not be downloaded</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
				$('.errorAdd').append(alert);
				
				var errorAlert = document.getElementById('downloadError');
				errorAlert.style.visibility="visible";
			}
		});
	
	 
})
	function triggerExhibitionDownload()
	{ 
	
	var infoSection = document.getElementById('infoSection');
	infoSection.style.display= "inline";
	 	var downloadProgress = document.getElementById('downloadInProgress');
	 	downloadProgress.style.visibility="visible"; 
	 	
	 	
/* 	 	var loader = document.getElementById('downloadLoader');
	 	loader.style.visibility="visible";  */
		 $.ajax({
				type : "GET",
				url : "[(@{'/staff/exhibit/download/trigger?'+ ${_csrf.parameterName}+'='+${_csrf.token} })] ",
				cache : false,
				
				contentType : false,
				processData : false,
				
				success : function(data) {
					console.log(data);
					if(data == "false") {
	 					pollForExhibitionDownload(data.id, data.folderName);

					}
 					
				},
				error : function(data) {
					var loader = document.getElementById('downloadLoader');
					loader.style.visibility="hidden";
					
					var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>Snapshot could not be downloaded</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
					$('.errorAdd').append(alert);
					
					var errorAlert = document.getElementById('downloadError');
					errorAlert.style.visibility="visible";
				}
			});
		
	}
/* 	function base64ToArrayBuffer(base64) {
 	    var binaryString = window.atob(base64);
 	    var binaryLen = base64.length;
	    var bytes = new Uint8Array(binaryLen);
	    for (var i = 0; i < binaryLen; i++) {
	       var ascii = binaryString.charCodeAt(i);
	       bytes[i] = ascii;
	    }
	    return bytes;
	 }
	 
	function saveByteArray(reportName, byte) {
		var fileType = "application/x-zip-compressed";
	    var blob = new Blob([byte], {type: fileType});
	    var link = document.createElement('a');
	    link.href = window.URL.createObjectURL(blob);
	    var fileName = reportName;
	    link.download = fileName;
	    link.click();
	}; */
	
	function pollForExhibitionDownload(id, folderName) {
		
		
		 const poll = (id, folderName) => {

				
				maxAttempts = 10;
				interval= 3000;
				  console.log('Start poll...');
				  let attempts = 0;

				  const executePoll = async (resolve, reject) => {
					    console.log('- poll');
						console.log("id" + id);
						console.log("folderName" + folderName);
					  	const  url = "[(@{'/staff/exhibit/download/checkStatus/'})]"+id+"?folderName="+folderName+','+ [[${_csrf.parameterName}]]+'='+[[${_csrf.token}]];			  
						const result = await fetch(url);
						console.log("attemps" + attempts);
					    attempts++;
					    var text = await result.text();
					    console.log("text", text);
					    if ( text == "true") {
					    	console.log("succes");
					    	
					    	var downloadInProgress = document.getElementById('downloadInProgress');
					    	downloadInProgress.style.visibility="hidden";
							var downloadReady = document.getElementById('downloadReady');
							downloadReady.style.visibility="visible";
						
			/* 			 	
							var alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert"><p>Snapshot is ready. Please click to download.<a th:href=@{/staff/exhibit/download/+id+(folderName=folderName)} ><span class="btn primary-btn btn-sm">Download</span></a> </p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
							$('.successAlert').append(alert); */
							/* var successAlert = document.getElementById('successAlert');
							successAlert.style.visibility="visible"; */
					    	
					      return resolve(result);
					    } else if (maxAttempts && attempts === maxAttempts) {
					    	var loader = document.getElementById('downloadLoader');
		  					loader.style.visibility="hidden";
		  					var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>Snapshot could not be created. Please try again later</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
		  					$('.errorAdd').append(alert);
		  					var errorAlert = document.getElementById('downloadError');
							errorAlert.style.visibility="visible";
		  					
					      return reject(new Error('Exceeded max attempts'));
					    } else {
		  					setTimeout( executePoll, interval, resolve, reject  );
		  				
					    }
					  };

					  return new Promise(executePoll);
			
			};
			
			poll(id, folderName)
			.then(value => value)
			.then(data => console.log(data))
			     	
			.catch(err => console.error(err)) 
		 
	}

</script>
<style>
.pagination>li>a {
	border: 1px solid #A55941;
	padding: 5px;
	color: #A55941;
	font-size: 15px;
}

.pagination>li.active>a {
	background: #A55941;
	color: #fff;
	font-size: 15px;
}

a.nav-link.active.show {
	border-color: transparent;
	border-bottom: 4px solid var(--primary);
	color: var(--primary) !important;
	background: transparent;
	font-weight: 600;
}

.img-thumbnail {
    height: 100px;
    width: 140px;
}
.loader {
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid blue;
  border-bottom: 16px solid blue;
  width: 12px;
  height: 12px;
  -webkit-animation: spin 2s linear infinite;
  animation: spin 2s linear infinite;


}
#downloadInProgress {
visibility: hidden;
}

#downloadReady {
visibility: hidden;
}
#infoSection {
display: none;
}


@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

</style>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
<div layout:fragment="content" class="main-content">
<!-- 	<span class = "errorAdd" id="downloadError"></span>
 --><!-- 	<span class = "successAlert" id="downloadSuccess"></span>
 -->	
 	<button class="download btn primary-btn" onClick="triggerExhibitionDownload()">Create Snapshot</button>
 	<div id= "infoSection">
 	<div id="downloadInProgress">
 	<p>Snapshot creation is in progress.</p>
 	<div class="loader" > </div>
 	
 	</div>
 	<div id="downloadReady">
 	<p>Snapshot is ready. Please click to download.
 	<a th:href="@{/staff/exhibit/download/+id+(folderName=folderName)} "> </a>
 	
 	</div>
 	</div>
 	
 	
 	
 	 <h2>Downloads</h2>
 	 
 	 <div class="downloadPage-selection"></div>
	 <table class="table">
	  <thead>
                <tr>
                    <th scope="col" sort-prop="filename"><a
                        href="#">Creation date</a></th>
                    <th scope="col" sort-prop="name"><a href="#">Created by</a></th>

                    <th scope="col" >View</th>


                </tr>
            </thead>
	 		<tbody class="tableBody" id="downloads">
                <tr th:each="exhibitionDownload:  ${downloadsList}">
                    <th scope="row">[[${exhibitionDownload.creationDate}]]</th>
                 
                    <td>[[${exhibitionDownload.createdBy}]]</td>
                    <td><a th:href="@{'/staff/exhibit/download/'+${exhibitionDownload.id}(folderName=${exhibitionDownload.folderName})}" ><span class="btn primary-btn btn-sm">Download</span></a></td>
               </tr>
            </tbody>
	 
</table>
 	 <div class="downloadPage-selection"></div>

</div>
</body>
</html>