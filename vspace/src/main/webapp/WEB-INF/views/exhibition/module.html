<html layout:decorate="~{layouts/main}">
   <head>
      <style type="text/css">
      </style>
       <script src="https://d3js.org/d3.v4.js"></script>
      <script th:inline="javascript">
      	var json = [[${sequences}]]; //[[${sequenceOverview}]];
      	var moduleBubble = [[${module}]];
         $( document ).ready(function() {
            $("#blocks a").css('color','rgb(150, 45, 62)').css('font-weight','bold');
            $(".nav-bar").css('position','fixed').css('width','100%').css('z-index','125');
         });
         
         function showModuleMapModal(){
 			$("#moduleOverviewModal").show();
 		}
         
         function closeModuleOverview(){
 			$("#moduleOverviewModal").hide();   
 		}
      </script>
   </head>
   <body>
    <div layout:fragment="content">
        <div th:if="${showAlert == true}"
            class="alert alert-warning center col-md-12"
            style="text-align: center;">[[${message}]] <a
                th:href="@{'/exhibit/space/'+${spaceId}}">
                <button class="btn circle-btn" style="margin-left: 10px;">
                    <span class="icon-double-chevron-left"></span> <span
                        class="tooltiptext">Go To Space</span>
                </button>
            </a>
        </div>
        <div th:if="${showAlert != true}" id="Module_1" class="Module_1_Class">
        <div th:if="${showAlert != true}" style="padding-top: 4%; padding-bottom: 1%; background-color: white; position: relative; z-index: 100; top: 5.5%; width: 100%; display: flex;">
            <h3 class="textDiv">[[${module.name}]]</h3>
            <p class="slideNumberClass">Slide [[${currentNumOfSlide}]]/[[${numOfSlides}]]</p>
        </div>
         <div class="Group_7_Class" >
            <a th:if="${!#strings.isEmpty(prevSlide)}" th:href="@{'/exhibit/'+${spaceId}+'/module/'+${module.id}+'/sequence/'+${currentSequenceId}+'/slide/'+${prevSlide}}">
               <div class="Slideshow_previous_Class" style="position: fixed; z-index:110; left: 13%; top: 40.3%;">
                  <button class="btn circle-btn-slide-nav">
                         <span class="icon-chevron-left slide-nav"></span>
                         <span class="tooltiptext">Previous slide</span>
                  </button>
               </div>
           </a>
            <a th:if="${!#strings.isEmpty(nextSlide)}" th:href="@{'/exhibit/'+${spaceId}+'/module/'+${module.id}+'/sequence/'+${currentSequenceId}+'/slide/'+${nextSlide}}">
               <div class="slideshow_next slideshow_next_Class" style="position: fixed; z-index:110; right: 11%; top: 40.3%;">
                    <button class="btn circle-btn-slide-nav">
                         <span class="icon-chevron-right slide-nav"></span>
                         <span class="tooltiptext">Next slide</span>
                    </button>  
               </div>
            </a>
         </div>
         <a th:href="@{'/exhibit/space/'+${spaceId}}">
            <div class="exit_to_space_Class" style="position: fixed;  z-index:120;">
                  <button class="btn circle-btn">
                      <span class="icon-double-chevron-left"></span>
                      <span class="tooltiptext">Go To Space</span>
                  </button>
            </div>
         </a>
         <a th:href="@{'/exhibit/'+${spaceId}+'/module/'+${module.id}+'/sequence/'+${startSequenceId}+'?clearHistory=true'}">
            <div class="exit_to_branchingPoint_Class" style="position: fixed;  z-index:110;">
                  <button class="btn circle-btn">
                      <span class="icon-rewind-end"></span>
                      <span class="tooltiptext">Go To Start Sequence of Module</span>
                  </button>
            </div>
         </a>
         <a th:if="${showBackToPreviousChoice eq true}" th:href="@{'/exhibit/'+${spaceId}+'/module/'+${module.id}+'/sequence/'+${previousSequenceId}+'/slide/'+${previousBranchingPoint.id}+'?back=true'}">
            <div class="exit_to_previousChoice_Class" style="position: fixed; z-index:110;">
                  <button class="btn circle-btn">
                      <span class="icon-caret-left"></span>
                      <span class="tooltiptext">Go back to [[${previousBranchingPoint.name} ]]</span>
                  </button>
            </div>
         </a>
         <div style="position: relative;top: 6.5%;">
            <h3 style="text-align:center;">[[${currentSlideCon.name}]]</h3>
            <div id="blocks" class="Group_8_Class" th:each="contents: ${currentSlideCon.contents}">
                <img th:if="${contents['class'].simpleName ==  'ImageBlock'}" id="${contents.id}" class="imgDiv" th:src="@{'/api/image/'+${contents.image.id}}">
                <div th:if="${contents['class'].simpleName ==  'TextBlock'}" id="${contents.id}" class="textDiv">[(${contents.htmlRenderedText()})]</div>
                <div th:if="${contents['class'].simpleName == 'ChoiceBlock'}" id="${contents.id}" class="textDiv" style="margin: 1%;">
                    <div th:if="${contents.showsAll eq true}" th:each="choice: ${choices}" class="list-group">
                        <a th:href="@{'/exhibit/'+${spaceId}+'/module/'+${module.id}+'/sequence/'+${choice.sequence.id}+'?branchingPoint='+${slideId}+'&previousSequenceId='+${currentSequenceId}}"
                            class="list-group-item list-group-item-action">[[${choice.sequence.name}]]</a>
                    </div>
                    <div class="list-group" th:if="${contents.showsAll eq false}" th:each="choice: ${contents.choices}">
                        <a th:href="@{'/exhibit/'+${spaceId}+'/module/'+${module.id}+'/sequence/'+${choice.sequence.id}+'?branchingPoint='+${slideId}+'&previousSequenceId='+${currentSequenceId}}"
                            class="list-group-item list-group-item-action">[[${choice.sequence.name}]]</a>
                    </div>
                </div>
            </div>
        </div>
      </div>
       <div id="moduleOverviewModal" class="modal" role="dialog">
        	<div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Module Map</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div id="graph" class="modal-body">
                        <script>
				  		var nodeJson = json; //JSON.parse(jsonMap['nodesJson']);
				  		var moduleBubbleData = moduleBubble;
				  		const PADDING_BUBBLE = 15 // distance between edge end and bubble
				        const PADDING_LABEL = 30 // distance between edge end and engineer id
				        const BUBBLE_SIZE_MIN = 10
				        const BUBBLE_SIZE_MAX = 10
				        var diameter = 400,
				        radius = diameter / 2,
				        innerRadius = radius - 170; // between center and edge end
				        
				     // The 'cluster' function takes 1 argument as input. It also has methods (??) like cluster.separation(), cluster.size() and cluster.nodeSize()
				        var cluster = d3.cluster()
				            .size([360, innerRadius]);
				        
				        var line = d3.radialLine()
				            .curve(d3.curveBundle.beta(0.85))
				            .radius(function (d) { return d.y; })
				            .angle(function (d) { return d.x / 180 * Math.PI; });
				        
				        var svg = d3.select("#graph").append("svg")
				            .attr("width", diameter)
				            .attr("height", diameter)
				            .append("g")
				            .attr("transform", "translate(" + radius + "," + radius + ")");
				        
				        var link = svg.append("g").selectAll(".link"),
				            sequence = svg.append("g").selectAll(".sequence"),
				            moduleNameBubble = svg.append("g").selectAll(".moduleBubble"),
				            bubble = svg.append("g").selectAll(".bubble"),
				            slides = svg.append("g").selectAll(".slides");
				        
				        
				        
				        var moduleRootArray = [];
				        moduleRootArray.push(moduleBubbleData);
				        var root = packageHierarchy(nodeJson);
				        var moduleRoot = packageHierarchy(moduleRootArray);
				        cluster(moduleRoot);
				        moduleLeaf = moduleRoot.leaves();
				        // Build an object that gives feature of each leaves
				        cluster(root);
				        leaves = root.leaves();
				        console.log(leaves);
				        console.log(moduleLeaf);
				        //console.log(leaves);
				        // Leaves is an array of Objects. 1 item = one leaf. Provides x and y for leaf position in the svg. Also gives details about its parent.
				        /* link = link
				            .data(getEdges(leaves))
				            .enter().append("path")
				            .each(function (d) { d.source = d[0], d.target = d[d.length - 1]; })
				            .attr("class", "link")
				            .attr("d", line)
				            .attr("fill", "none")
				            .attr("stroke", "black") */  
				        moduleNameBubble = moduleNameBubble
				        			.data(moduleLeaf)
				        			.enter().append("circle")
				        			.attr("class", "moduleNode")
						            .attr("dy", "0.7em")
						            .attr("dx", "0.7em")
						            .attr("transform", function (d) { return "rotate(" + (d.x - 90) + ")translate(" + (d.y + PADDING_BUBBLE) + ",0)" + (d.x < 180 ? "" : "rotate(180)"); })
						            .attr("text-anchor", function (d) { return d.x < 180 ? "start" : "end"; })
						            .attr("r", 20)
						            .style("fill", "red")
						            .text(function (d) { return d.data.name; });
				            
				        sequence = sequence
				            .data(leaves)
				            .enter().append("circle")
				            .attr("class", "sequenceNode")
				            .attr("dy", "0.7em")
				            .attr("dx", "0.7em")
				            .attr("transform", function (d) { return "rotate(" + (d.x - 90) + ")translate(" + (d.y + PADDING_BUBBLE) + ",0)" + (d.x < 180 ? "" : "rotate(180)"); })
				            .attr("text-anchor", function (d) { return d.x < 180 ? "start" : "end"; })
				            .attr("r", 20)
				            .style("fill", "#69b3a2")
				            .text(function (d) { return d.data.name; });
				    
				        /* bubble = bubble
				            .data(leaves)
				            .enter().append("g")
				            .attr("class", "bubble")
				            .attr("transform", function (d) { return "rotate(" + (d.x - 90) + ")translate(" + (d.y + PADDING_BUBBLE) + ",0)" })
				            */
				       sequence.filter(function(d,i){
				    	  d.data.slides.filter(function(slide,j){
				    		  var slideArr = [];
				    		  slideArr.push(slide);
				    		  var slideArrJson = packageHierarchy(slideArr);
				    		  cluster(slideArrJson);
				    		  slides=slides
				    		  .data(slideArrJson.leaves())
				    		  .enter().append("circle")
				    		 .attr("class","slideNode")
					    	.attr("dy", "0.50em")
				            .attr("dx", "0.7em")
				            .attr("transform", function (d) { return "rotate(" + (d.x - 90) + ")translate(" + (d.y + PADDING_BUBBLE) + ",0)" + (d.x < 180 ? "" : "rotate(180)"); })
				            .attr("text-anchor", function (d) { return d.x < 180 ? "start" : "end"; })
				            .attr("r", 20)
				            .style("fill", "blue")
				            .text(function (dp) {console.log(dp); return dp.name; });
					    	  }) ;
				    	  
				       });  
				       /*slides = sequence.filter(function(d,i){
				    	    console.log(d.data.id);
				    	   console.log(d.data.slides); 
				    	  return d.data.slides;
				    	}) .append("svg:foreignObject")
			            .attr("x", function(d) { return -10;})
			            .attr("y", function(d) { return -10;})
			            .attr("height", 22)
			            .attr("width", 22) 
			            .html('<span class="icon-2x2-grid secondary"></span>'); */
				      
				      
				       
				    // Lazily construct the package hierarchy from class ids.
				       function packageHierarchy(classes) {
				           var map = {};
				       
				           function find(id, data) {
				               var node = map[id], i;
				               if (!node) {
				                   node = map[id] = data || { id: id, children: [] };
				                   if (id.length) {
				                       node.parent = find(id.substring(0, i = id.lastIndexOf(".")));
				                       node.parent.children.push(node);
				                       node.key = id.substring(i + 1);
				                   }
				               }
				               return node;
				           }
				       
				           classes.forEach(function (d) {
				               find(d.id, d);
				           });
				       
				           return d3.hierarchy(map[""]);
				       }
				       
				       // Return a list of edges for the given array of nodes.
				       function getEdges(nodes) {
				           var map = {},
				               edges = [];
				       
				           // Compute a map from id to node.
				           nodes.forEach(function (d) {
				               map[d.data.id] = d;
				           });
				       
				           // For each import, construct a link from the source to target node.
				           nodes.forEach(function (d) {
				               if (d.data.edges) d.data.edges.forEach(function (i) {
				                   edges.push(map[d.data.id].path(map[i]));
				               });
				           });
				       
				           return edges;
				       }
       				</script>
         </div>
         </div>
         </div>
         </div>
         <div>
        	<button onClick="showModuleMapModal()">View Module Map</button>
        </div>
      </div>
    </body>
</html>