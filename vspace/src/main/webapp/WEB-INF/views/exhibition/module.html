<html layout:decorate="~{layouts/main}">
   <head>
      <style type="text/css">
		      .links line {
		  stroke: #999;
		  stroke-opacity: 0.6;
		}
		
		.nodes circle {
		  stroke: #fff;
		  stroke-width: 1.5px;
		}
      
      </style>
       <script src="https://d3js.org/d3.v4.min.js"></script>
      <script th:inline="javascript">
      var json =[[${overview}]];
         $( document ).ready(function() {
            $("#blocks a").css('color','rgb(150, 45, 62)').css('font-weight','bold');
            $(".nav-bar").css('position','fixed').css('width','100%').css('z-index','125');
         });
         
         function showModuleMapModal(){
 			$("#moduleOverviewModal").show();
 		}
         
         function closeModuleOverview(){
 			$("#moduleOverviewModal").hide();   
 		}
      </script>
   </head>
   <body>
    <div layout:fragment="content">
        <div th:if="${showAlert == true}"
            class="alert alert-warning center col-md-12"
            style="text-align: center;">[[${message}]] <a
                th:href="@{'/exhibit/space/'+${spaceId}}">
                <button class="btn circle-btn" style="margin-left: 10px;">
                    <span class="icon-double-chevron-left"></span> <span
                        class="tooltiptext">Go To Space</span>
                </button>
            </a>
        </div>
        <div th:if="${showAlert != true}" id="Module_1" class="Module_1_Class">
        <div th:if="${showAlert != true}" style="padding-top: 4%; padding-bottom: 1%; background-color: white; position: relative; z-index: 100; top: 5.5%; width: 100%; display: flex;">
            <h3 class="textDiv">[[${module.name}]]</h3>
            <p class="slideNumberClass">Slide [[${currentNumOfSlide}]]/[[${numOfSlides}]]</p>
        </div>
         <div class="Group_7_Class" >
            <a th:if="${!#strings.isEmpty(prevSlide)}" th:href="@{'/exhibit/'+${spaceId}+'/module/'+${module.id}+'/sequence/'+${currentSequenceId}+'/slide/'+${prevSlide}}">
               <div class="Slideshow_previous_Class" style="position: fixed; z-index:110; left: 13%; top: 40.3%;">
                  <button class="btn circle-btn-slide-nav">
                         <span class="icon-chevron-left slide-nav"></span>
                         <span class="tooltiptext">Previous slide</span>
                  </button>
               </div>
           </a>
            <a th:if="${!#strings.isEmpty(nextSlide)}" th:href="@{'/exhibit/'+${spaceId}+'/module/'+${module.id}+'/sequence/'+${currentSequenceId}+'/slide/'+${nextSlide}}">
               <div class="slideshow_next slideshow_next_Class" style="position: fixed; z-index:110; right: 11%; top: 40.3%;">
                    <button class="btn circle-btn-slide-nav">
                         <span class="icon-chevron-right slide-nav"></span>
                         <span class="tooltiptext">Next slide</span>
                    </button>  
               </div>
            </a>
         </div>
         <a th:href="@{'/exhibit/space/'+${spaceId}}">
            <div class="exit_to_space_Class" style="position: fixed;  z-index:120;">
                  <button class="btn circle-btn">
                      <span class="icon-double-chevron-left"></span>
                      <span class="tooltiptext">Go To Space</span>
                  </button>
            </div>
         </a>
         <a th:href="@{'/exhibit/'+${spaceId}+'/module/'+${module.id}+'/sequence/'+${startSequenceId}+'?clearHistory=true'}">
            <div class="exit_to_branchingPoint_Class" style="position: fixed;  z-index:110;">
                  <button class="btn circle-btn">
                      <span class="icon-rewind-end"></span>
                      <span class="tooltiptext">Go To Start Sequence of Module</span>
                  </button>
            </div>
         </a>
         <a th:if="${showBackToPreviousChoice eq true}" th:href="@{'/exhibit/'+${spaceId}+'/module/'+${module.id}+'/sequence/'+${previousSequenceId}+'/slide/'+${previousBranchingPoint.id}+'?back=true'}">
            <div class="exit_to_previousChoice_Class" style="position: fixed; z-index:110;">
                  <button class="btn circle-btn">
                      <span class="icon-caret-left"></span>
                      <span class="tooltiptext">Go back to [[${previousBranchingPoint.name} ]]</span>
                  </button>
            </div>
         </a>
         <div style="position: relative;top: 6.5%;">
            <h3 style="text-align:center;">[[${currentSlideCon.name}]]</h3>
            <div id="blocks" class="Group_8_Class" th:each="contents: ${currentSlideCon.contents}">
                <img th:if="${contents['class'].simpleName ==  'ImageBlock'}" id="${contents.id}" class="imgDiv" th:src="@{'/api/image/'+${contents.image.id}}">
                <div th:if="${contents['class'].simpleName ==  'TextBlock'}" id="${contents.id}" class="textDiv">[(${contents.htmlRenderedText()})]</div>
                <div th:if="${contents['class'].simpleName == 'ChoiceBlock'}" id="${contents.id}" class="textDiv" style="margin: 1%;">
                    <div th:if="${contents.showsAll eq true}" th:each="choice: ${choices}" class="list-group">
                        <a th:href="@{'/exhibit/'+${spaceId}+'/module/'+${module.id}+'/sequence/'+${choice.sequence.id}+'?branchingPoint='+${slideId}+'&previousSequenceId='+${currentSequenceId}}"
                            class="list-group-item list-group-item-action">[[${choice.sequence.name}]]</a>
                    </div>
                    <div class="list-group" th:if="${contents.showsAll eq false}" th:each="choice: ${contents.choices}">
                        <a th:href="@{'/exhibit/'+${spaceId}+'/module/'+${module.id}+'/sequence/'+${choice.sequence.id}+'?branchingPoint='+${slideId}+'&previousSequenceId='+${currentSequenceId}}"
                            class="list-group-item list-group-item-action">[[${choice.sequence.name}]]</a>
                    </div>
                </div>
            </div>
        </div>
      </div>
       <div id="moduleOverviewModal" class="modal" role="dialog">
        	<div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Module Map</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div id="graph" class="modal-body">
                        <svg width="400px" height="400px"></svg>
                        <script>
                        /* var diameter = 400;
                        var radius = 200; */
                        let graph = {};
                        graph.nodes = [];
                        graph.links = [];
                        let module = {};
                        
                        console.log('the entire json is');
                        //console.log(json);
                        module.id = json.id;
                        console.log(json.id);
                        let moduleid = json.id;
                        module.name = json.name;
                        module.group = "module";
                        graph.nodes.push(module);
                        console.log('module is');
                        console.log(module);
				  		let sequences = json['sequenceOverview'];
				  		let slides = [];
				  		
				  		for (sequence of sequences) {
				  		  sequence.group = "sequence";
				  		  let nodeSequence = {};
				  		  nodeSequence.name = sequence.name;
				  		  nodeSequence.id = sequence.id;
				  		  nodeSequence.group = "sequence";
				  		  graph.nodes.push(nodeSequence);
				  		  let modlink = {};
				  		  /* console.log('module id is')
				  		  console.log(module.id); */
				  		  
				  		  //modlink.source = modlink.s;
				  		  modlink.target = nodeSequence.id;
				  		  modlink.source = moduleid;
				  		  modlink.value=20;
				  		  graph.links.push(modlink);
				  		  modlink={}
				  		  let sequenceSlides = sequence.slides;
				  		  let index = 0;
				  		  let source = "";
				  		  for(slide of sequenceSlides){
				  			  
				  			  let slideNode = {}
				  			  slideNode.name = slide.name
				  			  //slideNode.id = slide.id;
				  			  slideNode.group = "slide";
				  			  slideNode.sequenceId = sequence.id;
				  			  slideNode.id = sequence.id + slide.id;
				  			  slides.push(slideNode);
				  			  graph.nodes.push(slideNode);
					  		  if(index == 0){
				  				  let slideLink ={};
				  				  slideLink.source = nodeSequence.id;
				  				  slideLink.target = slideNode.id;
				  				  slideLink.value=10;
				  				  graph.links.push(slideLink);
					  		  } else {
					  			  let slideLink = {};
					  			  slideLink.source = source;
					  			  slideLink.target = slideNode.id;
					  			  slideLink.value=10;
					  			  graph.links.push(slideLink);
					  		  }
					  		  source = slideNode.id;
					  		  index=index+1;
				  		  }
				  		}
				  		console.log('sequences are');
				  		console.log(sequences);
				  		console.log('slides are');
				  		console.log(slides);
				  		//graph.nodes = slides;
				  		console.log('graph is');
				  		console.log(graph);
				  		//var simulation = d3.ForceSimulation(graph.nodes).force()
				         
				  		var svg = d3.select("svg"),
					    width = +svg.attr("400px"),
					    height = +svg.attr("400px");
				  		
				  		var color = d3.scaleOrdinal(d3.schemeCategory20);
				  		
				  		var simulation = d3.forceSimulation(graph.nodes)
				  	    .force("link", d3.forceLink(graph.links).id(function(d){
				  	    	 /* console.log('reached here');
				  	    	console.log(d.id);
				  	    	console.log('done');  */
				  	    	return d.id;
				  	    }))
				  	    .force("charge", d3.forceManyBody().strength(-400))
				  	    .force("center", d3.forceCenter("200", "200"))
				  	    .on("tick", ticked);
				  		console.log('reached here');
				  		  var link = svg.append("g")
				  		      .attr("class", "links")
				  		    .selectAll("line")
				  		    .data(graph.links)
				  		    .enter().append("line")
				  		      .attr("stroke-width", function(d) { return 3 })
				  		      .style("stroke", "pink");

				  		  var node = svg.append("g")
				  		      .attr("class", "nodes")
				  		    .selectAll("circle")
				  		    .data(graph.nodes)
				  		    .enter().append("circle")
				  		      .attr("r", 15)
				  		      .attr("fill", function(d) { return color(d.group); });
				  		       /* .call(d3.drag()
				  		          .on("start", dragstarted)
				  		          .on("drag", dragged)
				  		          .on("end", dragended));  */

				  		  node.append("title")
				  		      .text(function(d) { return d.id; });
		  		          node.append("text")
			  		        .text(function(d) { return d.name; });
 
				  		     /* simulation
				  		      .nodes(graph.nodes)
				  		      .on("tick", ticked); 

				  		  simulation.force("link")
				  		      .links(graph.links);   */  
				  		    
				  		   function ticked() {
				  		    link
				  		        .attr("x1", function(d) { return d.source.x; })
				  		        .attr("y1", function(d) { return d.source.y; })
				  		        .attr("x2", function(d) { return d.target.x; })
				  		        .attr("y2", function(d) { return d.target.y; });

				  		    node
				  		        .attr("cx", function(d) { return d.x; })
				  		        .attr("cy", function(d) { return d.y; });
				  		  } 

				  		function dragstarted(d) {
				  		  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
				  		  d.fx = d.x;
				  		  d.fy = d.y;
				  		}

				  		function dragged(d) {
				  		  d.fx = d3.event.x;
				  		  d.fy = d3.event.y;
				  		}

				  		function dragended(d) {
				  		  if (!d3.event.active) simulation.alphaTarget(0);
				  		  d.fx = null;
				  		  d.fy = null;
				  		} 

				  		
				  
				        
				        
				       
       				</script>
         </div>
         </div>
         </div>
         </div>
         <div>
        	<button onClick="showModuleMapModal()">View Module Map</button>
        </div>
      </div>
    </body>
</html>