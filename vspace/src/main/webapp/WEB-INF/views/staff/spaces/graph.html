<html layout:decorate="~{layouts/main_staff}">
<head>
<script th:inline="javascript">
var jsonMap = [[${jsonFormatMap}]];
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
<style>
.links line {
  stroke: #999;
  stroke-width: 2px;
}
text {
  font-family: sans-serif;
  font-size: 15px;
}
image { 
 filter: drop-shadow(1px 1px 7px  #e39e44);
}
svg
{
width: 100%;
}
</style>
</head>
<body>
<div layout:fragment="content">
<div><center><p>Double Click On Space's Image or Module Icon to go to the respective Space or Module's Page</p></center></div>
<div id="mainContent">
<svg></svg>
</div>
<script>
//# sourceURL=graph.js
var nodeJson = JSON.parse(jsonMap['nodesJson']);
var linkJson = JSON.parse(jsonMap['linksJson']);
var w = window,
d = document,
e = d.documentElement,
g = $('body')[0],
x = w.innerWidth || e.clientWidth || g.clientWidth,
y = w.innerHeight|| e.clientHeight|| g.clientHeight;

var svg = d3.select("body")
          .select("svg")
          .attr("width", x)
          .attr("height",y);

width = +svg.attr("width"),
height = +svg.attr("height");

force = d3.layout.force()
.size([width, height])
.charge(-400)
.linkDistance(40);

 drag = force.drag().on('dragstart', function(d) {
    return d.fixed = true;
  });

 _ref = linkJson;
 for (_i = 0, _len = _ref.length; _i < _len; _i++) {
   l = _ref[_i];
   _ref2 = nodeJson;
   for (_j = 0, _len2 = _ref2.length; _j < _len2; _j++) {
     n = _ref2[_j];
     if (typeof(l) != "undefined" && typeof(l.source) != "undefined" && typeof(n) != "undefined" && typeof(n.id) != "undefined" && l.source === n.id) {
       l.source = _j;
       continue;
     }
     if (typeof(l) != "undefined" && typeof(l.target) != "undefined" && typeof(n) != "undefined" && typeof(n.id) != "undefined" && l.target === n.id) {
       l.target = _j;
       continue;
     }
   }
 }
 
 var link = svg.append("g")
	      .attr("class", "links")
	    .selectAll("line")
	    .data(linkJson)
	    .enter().append("line");
	  
	 var node = svg.append("g")
	    .attr("class", "nodes")
	    .selectAll("g")
	    .data(nodeJson)
	    .enter().append("g")
	    .call(drag);  
	  	    
     var modules = node.filter(function(d,i){
    	  return d.module;
    	}).append("svg:foreignObject")
        .attr("x", function(d) { return -10;})
        .attr("y", function(d) { return -10;})
        .attr("height", 22)
        .attr("width", 22) 
        .html('<span class="icon-2x2-grid secondary"></span>');
        
    
   var images = node.filter(function(d,i){
  	  return !d.module;
  	}).append("svg:image")
    .attr("xlink:href",  function(d) {  return d.img;})
    .attr("x", function(d) { return -25;})
    .attr("y", function(d) { return -25;}) 
    .attr("height", 100)
    .attr("width", 100);
   
   node.filter(function(d,i){
 	  return !d.module && d.unpublished;
 	}).append("svg:foreignObject")
     .attr("x", function(d) { return -5;})
     .attr("y", function(d) { return -5;})
     .attr("height", 24)
     .attr("width", 24) 
     .html('<span class="icon-warning secondary" aria-hidden="true" data-toggle="tooltip" data-html="true" data-placement="top" title="This space is currently unpublished."></span>');

   node.filter(function(d,i){
	 	  return !d.module && d.hideIncomingLinks;
	 	}).append("svg:foreignObject")
	     .attr("x", function(d) { return 20;})
	     .attr("y", function(d) { return -5;})
	     .attr("height", 24)
	     .attr("width", 24) 
	     .html('<span class="icon-close-alt hiddenLinks secondary" aria-hidden="true" data-toggle="tooltip" data-html="true" data-placement="top" title="This space has hidden links"></span>');

     var setEvents = modules
	    .on( 'dblclick', function (d) {
	        location.href = d.link;
	     });
	  var setEvents = images
	    .on( 'dblclick', function (d) {
	        location.href = d.link;
	     })

	    .on( 'mouseenter', function() {
	      // select element in current context
	      d3.select( this )
	        .transition()
	        .attr("x", function(d) { return -60;})
	        .attr("y", function(d) { return -60;})
	        .attr("height", 300)
	        .attr("width", 300);
	    })
	     // set back
	          .on( 'mouseleave', function() {
	            d3.select( this )
	              .transition()
	              .attr("x", function(d) { return -25;})
	              .attr("y", function(d) { return -25;})
	              .attr("height", 100)
	              .attr("width", 100);
	          }); 
	
	      node.filter(function(d,i){
	    	  return !d.module;
	    	}).append("text")
		      .text(function(d) {
			        return d.name;
			      })
			      .attr('x', 10)
			      .attr('y', 90);
	      
	      node.filter(function(d,i){
	    	  return d.module;
	    	}).append("text")
		      .text(function(d) {
			        return d.name;
			      })
			      .attr('x', 12)
			      .attr('y', 20);
	      
	  node.append("title")
	      .text(function(d) { return d.name; });

	  force.nodes(nodeJson)
	      .on("tick", ticked);

	  force.links(linkJson).start();

	  function ticked() {
	    link
	        .attr("x1", function(d) { return d.source.x; })
	        .attr("y1", function(d) { return d.source.y; })
	        .attr("x2", function(d) { return d.target.x; })
	        .attr("y2", function(d) { return d.target.y; });

	    node
	        .attr("transform", function(d) {
	          return "translate(" + d.x + "," + d.y + ")";
	        })
	  }
	</script>
</div>	
</body>
</html>