<html layout:decorate="~{layouts/main_staff}">
<head>
<link rel="stylesheet"
	href="https://unpkg.com/easymde/dist/easymde.min.css">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>

<style type="text/css">
.hova {
	background-color: #bfb168;
}
</style>
<script th:inline="javascript">
//# sourceURL=click.js
var contentCount = [[${#lists.size(slideContents)}]];
var markDown = null;
var defaultValue;

$(function () {
	  $('[data-toggle="tooltip"]').tooltip()
});

function createImageBlock(reader, width) {
    var imageblock = $('<div id="current" style="margin: 1%; border: 1px solid rgba(0, 0, 0, 0.125);" class="valueDiv card-body"><img src="#" style="margin: 1%;"/><input type="hidden" id="deleteImageId" /><a class="btn deleteImage" href="javascript:;" style="float: right;"><i style="color: black;" class="fas fa-trash-alt"></i></a></div>');
    imageblock.find('img').attr('src', reader.result);
    if(width > 800)
    	imageblock.find('img').attr('width', '800px');
    return imageblock;
}

function createVideoBlock(reader, videoSrc) {
	//var videoBlock = $('<div id="currentVideo" style="margin: 1%; border: 1px solid rgba(0, 0, 0, 0.125);" class="valueDiv card-body"><video width="800" height="530" style="margin: 1%;" controls ><source  width="600" height="400" src="#" type="video/mp4"></video><input type="hidden" id="deleteVideoId" /><a class="btn deleteImage" href="javascript:;" style="float: right;"><i style="color: black;" class="fas fa-trash-alt"></i></a></div>');
	var videoBlock = $('<div id="currentVideo" style="margin: 1%; border: 1px solid rgba(0, 0, 0, 0.125);" class="valueDiv card-body"><iframe width="800" height="530" src="#" frameborder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><input type="hidden" id="deleteVideoId" /><a class="btn deleteImage" href="javascript:;" style="float: right;"><i style="color: black;" class="fas fa-trash-alt"></i></a></div>');
	videoBlock.find('iframe').attr('src', videoSrc);
	return videoBlock;
}

function onMouseEnter(e){
    var target = $( e.target );
   
    $(".hova").removeClass("hova");
    $(e.target).addClass("hova");
    // This is needed to prevent only the p tag from being highlighted
    if(target.is('p')){
        $(e.target).parent().addClass("hova");
    }
    //prevent normal hover actions
    e.preventDefault();
}
function onMouseLeave(e) {
    $(this).removeClass("hova");
}

function onDoubleClick(e){
    // get to the nearest divs class attribute
    $(".EasyMDEContainer").remove();
    var divName = $(e.target).closest('div').attr('class');
    console.log(divName);
    //if the div is a text content block 
    if(divName.includes("textDiv")){

    	$(e.target).closest('.textDiv').addClass("open");
        var description = $("div.open p:eq(0)").text();
    	defaultValue = description;

        $("#editTextAlert").show();
        markDown = new EasyMDE({element: $('#editTextBlock')[0]});
        markDown.value(description.trim());
        //remove card border
        $(".open").css('display', 'none');
    } else if(divName.includes("imgDiv")) {
    	
    	// store image ID selected by the user to replace, onDoubleClick
    	var imgID = $(e.target).attr('id'); 
    	alert(imgID);
    	if(imgID != ''){
        	$("#uploadImage").data('value', imgID); // sets image ID value
        	$("#addImgAlert").show();
    	}
    }
    else {
    	var vidId = $(e.target).attr('id');
    	alert(vidId);
    	if(vidId != '') {
    		var url = $(e.target).find('iframe').attr('src');
    		console.log(url);
    		if(url.includes("www.")) {
    			console.log("link");
    			$("#videoLink").data('value', url);
    		}
    		else {
    			console.log("upload");
    			$("#videoFile").attr('value', url);
    		}
    		//$("#saveVideo").data('value', vidId); // sets video ID value
        	$("#addVideoAlert").show();
    	}
    }
}
    
function uploadImage() {
   	
	var imgID = $("#uploadImage").data('value') // gets image ID
    var file = $('#file')[0].files[0];
	var fileName = file.name;
    var reader  = new FileReader();
    var formData = new FormData();
    formData.append('file', file);
    formData.append('content', file.name);
    formData.append('contentOrder', contentCount);
    var imageblock = "";
 	var oldImageBlock = "";
    
    // Ashmi changes for Story VSPC-64
    
	// checks if image ID is present to replace
    if (imgID != '') {
    	oldImageBlock = $("#" + imgID);
    	var imageBlockId = imgID;
    	formData.append('imageBlockId',imageBlockId);
        var url = "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/image/'})]" + imageBlockId + '?[(${_csrf.parameterName})]=[(${_csrf.token})]';
        console.log(url);
        reader.onload = function (theFile) {
	        var image = new Image();
	        image.src = theFile.target.result;
	        image.onload = function () {
	            imageblock = createImageBlock(reader, this.width);
	            $("#" + imageBlockId).replaceWith(imageblock);	
	            $(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
        	};
        }
        // Reset data-attribute to get current selected image ID
        $("#uploadImage").data('value', '');
      }
  	else {
  	  var url = "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/image/?'+${_csrf.parameterName}+'='+${_csrf.token}})]";
        reader.onload = function (theFile) {        	
        	var image = new Image();
            image.src = theFile.target.result;
            image.onload = function() {
            	imageblock = createImageBlock(reader, this.width);  
            	$('#slideSpace').append(imageblock); 
                $(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
            };          
        }
        ++contentCount; 
    }
  	
    reader.readAsDataURL(file);
    $.ajax({
        enctype: 'multipart/form-data',
        // ------------- creating image content blocks ------------
        url: url,
        type: 'POST',
        cache       : false,
        contentType : false,
        processData : false,
        data: formData,
        
        success: function(data) {
            $(".open").removeClass("open");
           	var img = imageblock.find('img');
           	if(data != ''){
           		img.attr('id', data);
           		$("#current").find('#deleteImageId').val(data);
           		$("#current").attr('id', data);
           	}
           	else{
           		img.attr('id', imgID);
           		$("#current").find('#deleteImageId').val(imgID);
           		$("#current").attr('id', imgID);
           	}
        },
        error: function(data) {
        	if (imgID == '') {
        		$("#current").remove();
        	}
        	else {
        		$("#current").replaceWith(oldImageBlock);
        	}
        	if (data.status == 403) {
        		$("#loginAlert").show();
        	}
        }
    });
    // Reset the image file name 
   	$('#file').val('');
}

function embedVideo() {
	var videoID = $("#saveVideo").data('value') // gets video ID
	
	var url = $("#videoLink").val();
	var vidFile = $("#videoFile")[0].files[0];
	var reader = new FileReader();
	var videoBlock = "";

	//var iFrameString = "<iframe width='560' height='315' src='"+url+"' frameborder='0' allow='accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture' allowfullscreen></iframe>"
    var formData = new FormData();
    if(url) {
    	formData.append('url', url);
    	videoBlock = createVideoBlock(reader, url);
        $('#slideSpace').append(videoBlock); 
    }
	if(vidFile) {
		formData.append('videoFile', vidFile);

	    reader.onload = function (theFile) { 
			videoBlock = createVideoBlock(reader, theFile.target.result);
	        $('#slideSpace').append(videoBlock);
		}
	}
    var ajaxUrl = "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/video?'+${_csrf.parameterName}+'='+${_csrf.token}})]";

    $(videoBlock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);       
	if(vidFile) {
    	reader.readAsDataURL(vidFile);
	}
    formData.append('contentOrder', contentCount);
    ++contentCount;
    $.ajax({
        enctype: 'multipart/form-data',
        // ------------- creating image content blocks ------------
        url: ajaxUrl,
        type: 'POST',
        cache       : false,
        contentType : false,
        processData : false,
        data: formData,
        
        success: function(data) {
           	var videoBlk = videoBlock.find('iframe');
           	if(data != ''){
           		videoBlk.attr('id', data);
           		$("#currentVideo").find('#deleteVideoId').val(data);
           		$("#currentVideo").attr('id', data);
           	}
        },
        error: function(data) {
        	alert("Something failed!");
        	console.log(data);
        }
    });
}

$(document).ready(function() {
    
    [# th:if="${#strings.equals(slide['class'].simpleName,'BranchingPoint')}"]
		$('#addChoice').show();
		$('#choiceSpace').show();
	[/]
	

    //-------- edit contentblock description --------

    $("#submitDescription").hide()
    $("#cancelEditDescription").hide()
    var description = $("#description").text()
    $("#editDescription").click(function() {
        $('<textarea id="newDescription" style="margin-top: 1%;" class="form-control" type="text">'+description+'</textarea>').insertBefore( "#description" );
        $("#description").remove()
        $("#editDescription").hide()
        $("#submitDescription").show()
        $("#cancelEditDescription").show()
        
    });

    $("#submitDescription").click(function() {
        var formData = new FormData();
        formData.append('description', $("#newDescription").val());
        $.ajax({ 
	        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/edit/description?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
	        type: 'POST',
	        cache       : false,
	        contentType : false,
	        processData : false,
	        data: formData,
	        enctype: 'multipart/form-data',
	        success: function(data) {
	            // replace text box with new description
	            $("#submitDescription").hide()
	            $("#cancelEditDescription").hide()
	            $("#editDescription").show()
	            var val = $("#newDescription").val();
	            $('<p id="description"style="margin-top: .5rem; margin-bottom: .5rem;"></p>').insertBefore( "#newDescription" );
	            $("#newDescription").remove();
	            $("#description").text(val)
	        },
	        error: function(data) {
	            $(".open").removeClass("open");
	                var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
	                $('.error').append(alert);
	        }
         });       
      });
    
    $("#cancelEditDescription").click(function(){
        $("#submitDescription").hide()
        $("#editDescription").show()
        $("#cancelEditDescription").hide()
        $('<p id="description" style="margin-top: .5rem; margin-bottom: .5rem;"></p>').insertBefore( "#newDescription" );
        $("#newDescription").remove()
        $("#description").text(description)
        
    });
    
    //------- edit title --------
    $("#submitTitle").hide();
    $("#cancelEditTitle").hide();
    var getTitleText = $("#title").text().split(": ")[1]
    $("#editTitle").click(function() {
        $('<div class="col-4"><input id="newTitle" class="form-control" type="text"></div>').insertAfter( "#title" );
        $('#title').text('Slide: ')
        $("#newTitle").val(getTitleText)
        $("#editTitle").hide()
        $("#submitTitle").show()
        $("#cancelEditTitle").show()       
    });
    
    $("#submitTitle").click(function() {
        var formData = new FormData();
        formData.append('title', $("#newTitle").val());
        $.ajax({
            url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/edit/title?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
            type: 'POST',
            cache       : false,
            contentType : false,
            processData : false,
            data: formData,
            enctype: 'multipart/form-data',
            success: function(data) {
                // replace text box with new description
                $("#submitTitle").hide()
                $("#cancelEditTitle").hide();
                $("#editTitle").show()
                var val = $("#newTitle").val();
                $("#newTitle").closest('div').remove();
                $("#title").text("Silde: " + val)
                
            },
            error: function(data) {
                var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                $('.error').append(alert);
            }
        });
      });
   $("#cancelEditTitle").click(function(){
        $("#submitTitle").hide()
        $("#editTitle").show()
        $("#cancelEditTitle").hide()
        $("#newTitle").closest('div').remove();
        $("#title").text("Silde: " + getTitleText);
   });
   
    $("#addText").click(function() {
        $(".EasyMDEContainer").remove();
    	markDown = new EasyMDE({element: $('#textBlockText')[0]});
        $("#addTextAlert").show();
    });
    
    $("#addImage").click(function() {
        $("#addImgAlert").show();
    });
    
    $("#addVideo").click(function() {
        $("#addVideoAlert").show();
    });
    
    $("#uploadImage").click(function(e) {
        e.preventDefault();
            $("#addImgAlert").hide();
            uploadImage();
    });
    
    $("#saveVideo").click(function(e) {
    	e.preventDefault();
    	$("#addVideoAlert").hide();
    	embedVideo();
    })
    
    $("#embedVideo").click(function(e) {
    	e.preventDefault();
    	alert("data loaded");
        $("#addVideoAlert").hide();
        alert("he he");
        //embedVideo(e);
    });
    
    $("#addChoice").click(function() {
        $("#addChoiceAlert").show();
    });
    
    $(document).on("click", ".deleteText", function(e) {
		$("#confirmDeleteTextAlert").show();
		var alert = $('<input type="hidden" id="deleteTextId">');
		$(alert).attr( 'value', $(this).siblings('input').val());
		$('.modal-footer').append(alert); 
  	});
	
	$(document).on("click", ".deleteImage", function(e) {
		$("#confirmDeleteImageAlert").show();
		var alert = $('<input type="hidden" id="deleteImageId">');
		$(alert).attr( 'value', $(this).siblings('input').val());
		$('.modal-footer').append(alert); 
  	});
	
	$(document).on("click", ".deleteChoiceBlock", function(e) {
		$("#confirmDeleteChoiceBlockAlert").show();
		var alert = $('<input type="hidden" id="deleteChoiceBlockId">');
		$(alert).attr( 'value', $(this).siblings('input').val());
		$('.modal-footer').append(alert); 
  	});
    
    $("#cancelSubmitText").click(function() {
		$("#addTextAlert").hide();	
	});
	
	$("#cancelDeleteText").click(function() {
		$("#confirmDeleteTextAlert").find('input').remove();
		$("#confirmDeleteImageAlert").find('input').remove();
		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
		$("#confirmDeleteTextAlert").hide();
	});
	
	$("#cancelDeleteImage").click(function() {
		$("#confirmDeleteImageAlert").hide();
	});
	
	$("#cancelDeleteChoiceBlock").click(function() {
	    $("#confirmDeleteChoiceBlockAlert").find('input').remove();
	    $("#confirmDeleteTextAlert").find('input').remove();
		$("#confirmDeleteImageAlert").find('input').remove();
		$("#confirmDeleteChoiceBlockAlert").hide();
	});
	
	$("#cancelDelete").click(function() {
		$("#confirmDeleteTextAlert").find('input').remove();
		$("#confirmDeleteImageAlert").find('input').remove();
		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
		$("#confirmDeleteImageAlert").hide();	
	});
	
    	// ---------- Delete Text Block -------------
	
		$("#deleteText").on("click", function(e) {
		e.preventDefault();
		$("#confirmDeleteImageAlert").find('input').remove();
		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
		$("#confirmDeleteTextAlert").hide();
		var blockId = $('#deleteTextId').attr('value');
		$('#deleteTextId').remove()
		
		// ------------- delete text content blocks ------------
		$.ajax({
		    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/text/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
		    type: 'DELETE',
		    success: function(result) {
		        $('#' + blockId).remove();
		        
		    },
			error: function(data) {
				var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
				$('.error').append(alert); 
				$(".error").delay(4000).slideUp(500, function(){
				    $(".error").empty();
				});
			}
		});
	});
	
	// ---------- Delete Image Block -----------
	
	$("#deleteImage").on("click", function(e) {
		e.preventDefault();
		$("#confirmDeleteTextAlert").find('input').remove();
		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
		$("#confirmDeleteImageAlert").hide();
		var blockId = $('#deleteImageId').attr('value');
		if(blockId == null || blockId == ''){
			var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
			$('.error').append(alert); 
			$(".error").delay(4000).slideUp(500, function(){
			    $(".error").empty();
			});
		} else{
			$('#deleteImageId').remove()
			// ------------- delete image content blocks ------------
			$.ajax({
			    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/image/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
			    type: 'DELETE',
			    success: function(result) {
			    	$('#' + blockId).remove();
			    },
				error: function(data) {
					var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
					$('.error').append(alert); 
					$(".error").delay(4000).slideUp(500, function(){
					    $(".error").empty();
					});
				}
			});
		}
	});
	
	$("#deleteChoiceBlock").on("click", function(e) {
	    e.preventDefault();
	    $("#confirmDeleteTextAlert").find('input').remove();
	    $("#confirmDeleteImageAlert").find('input').remove();
		$("#confirmDeleteChoiceBlockAlert").hide();
		var blockId = $('#deleteChoiceBlockId').attr('value');
		if(blockId == null || blockId == ''){
			var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
			$('.error').append(alert); 
			$(".error").delay(4000).slideUp(500, function(){
			    $(".error").empty();
			});
		} else{
			$('#deleteChoiceBlockId').remove()
			// ------------- delete choices content blocks ------------
			$.ajax({
			    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/choiceBlock/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
			    type: 'DELETE',
			    success: function(result) {
			    	$('#' + blockId).remove();
			    },
				error: function(data) {
					var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
					$('.error').append(alert); 
					$(".error").delay(4000).slideUp(500, function(){
					    $(".error").empty();
					});
				}
			});
		}
	});
	
					
    

    
	$("#cancelSubmitChoice").click(function() {
        $("#addChoiceAlert").hide();	
    });
	
    $("#cancelImageBtn").click(function() {
    	// Initialize selected image ID to blank, on clicking cancel button
    	$("#uploadImage").data('value', '');
        $("#addImgAlert").hide();
        $(".open").removeClass("open");
    });
    
    $("#cancelVideoBtn").click(function() {
    	// Initialize selected image ID to blank, on clicking cancel button
    	$("#embedVideo").data('value', '');
        $("#addVideoAlert").hide();
        $(".open").removeClass("open");
    });
    
    $("#submitText").on("click", function(e) {
        $("#addTextAlert").hide();
        e.preventDefault();
        // ------------- creating text content blocks ------------
        
        var formData = new FormData();
        var text = markDown.value();
        formData.append('content', text);
        ++contentCount;
        formData.append('contentOrder', contentCount);
        markDown.value('');
        $.ajax({
            url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/textcontent?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
            type: 'POST',
            cache       : false,
            contentType : false,
            processData : false,
            data: formData,
            enctype: 'multipart/form-data',
            success: function(data) {

                var textblock = $('<div id="'+ data +'" class="textDiv card card-body row"><p>'+text+'<input type="hidden" id="deleteTextId" value="'+data+'" /><a class="btn deleteText" href="javascript:;" style="float: right;"><i style="color: black;" class="fas fa-trash-alt"></i></a></p></div>');
                $(textblock).css({
                    'margin': "10px"
                });
                $(textblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
                $('#slideSpace').append(textblock);             
            },
            error: function(data) {
            	if (data.status == 403){
            		$("#loginAlert").show();
            	}
            	else {
                	var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                	$('.error').append(alert);
            	}
            }
        });
    });
    
    $('input:checkbox').click(function() {
        if ($(this).is(':checked')) {
        	$('#submitChoices').prop("disabled", false);
        } else {
        if ($('.choiceOptions').filter(':checked').length < 1){
        	$('#submitChoices').attr('disabled',true);}
        }
    });
    
    $("#submitChoices").on("click", function(e) {
        e.preventDefault();
        $("#addChoiceAlert").hide();
        var selectedChoice = [];
        var showsAll = false;
        $('#selectChoices :checked').each(function() {
        	selectedChoice.push($(this).attr("id"));
          });
        // ------------- creating choice content blocks ------------
        if ($('#showAllChoices').is(':checked')) {
            showsAll = true;
        }
        var formData = new FormData();
        formData.append('selectedChoices', selectedChoice);
        ++contentCount;
        formData.append('contentOrder', contentCount);
        formData.append('showsAll', showsAll);
        $.ajax({
            url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/choice/content?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
            type: 'POST',
            cache       : false,
            contentType : false,
            processData : false,
            data: formData,
            enctype: 'multipart/form-data',
            success: function(data) {
                var choiceblock = $('<div id="'+ data['choiceBlock'].id +'" class="card card-body row" style="margin: 10px;">');
                if (data['choiceBlock'].showsAll == false){
                    $.each(data['selectedSequences'], function(index, sequence) {
                        choiceblock.append('<a href="/vspace/staff/module/[(${module.id})]/sequence/'+sequence.id+'">'+sequence.name+'</a>');
            	});
                }else{
                	$(function() {
                        var links = $("#choiceSpace a").map(function(e) {
                            text = '<a href='+this.href+'>'+this.name+'</a>';
                            return text;
                        }).get();
                        $(links).each(function(index, choice) {
                            choiceblock.append(choice);
                        });
                   });
                }
                choiceblock.append('<input type="hidden" id="deleteChoiceBlockId" value="'+ data['choiceBlock'].id +'"><a class="btn deleteChoiceBlock" href="javascript:;" style="float: right; position: absolute; right: 20px; top: 0;"><i style="color: black;" class="fas fa-trash-alt"></i></a></div>')
            	$(choiceblock).css({
                    'margin': "10px"
                });
                $('#slideSpace').append(choiceblock);
            },
            error: function(data) {
                var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                $('.error').append(alert);
            }
        });
        $('#choiceForm')[0].reset();
    });
    
    $("#urlLink").on("click", function(e) {
    	$("#saveVideo").html("Embed Video");
    }); 
    
    $("#uploadLink").on("click", function(e) {
    	$("#saveVideo").html("Upload Video");
    });    
    
    function updateTextBox(blockId, text) {
        // clear text box and buttons
        $(".open").empty();
        $(".open").append('<p>'+text+'<input type="hidden" id="deleteTextId" value="'+blockId+'" /><a class="btn deleteText" href="javascript:;" style="float: right;"><i style="color: black; float: right;" class="fas fa-trash-alt"></i></a></p>');
        // reset border of the card
        $(".open").css('border', '1px solid rgba(0,0,0,.125)');
        //rebind event handlers
        
        $('.textDiv').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
        $(".open").css('display', 'block');
        // remove id from storage so its not there on refresh
        $(".open").removeClass("open");
    }
    
    // must add the event to the document since the buttons are added dynamically
    $('#cancelTextBlock').on('click',function(){
    	$("#editTextAlert").hide();
    	var blockId = $(this).closest(".open").attr("id");
    	updateTextBox(blockId, defaultValue);
    });

    $('.valueDiv').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
    $('.textDiv').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
    $('.imgDiv').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
    $('.vidDiv').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);

    $("#submitTextBlock").on("click", function(e){
    	e.preventDefault();
        // ------------- editting text content blocks ------------
        
        var formData = new FormData();
        var text = markDown.value();
        markDown.value('');
        var formData = new FormData();
        var blockId = $(".open").attr("id");
        formData.append('textBlockDesc', text);
        formData.append('textBlockId', blockId);
    	$("#editTextAlert").hide();
        $.ajax({
            url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/text/edit?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
            type: 'POST',
            cache       : false,
            contentType : false,
            processData : false,
            data: formData,
            enctype: 'multipart/form-data',
            success: function(data) {
                // replace text box with new description
               updateTextBox(blockId, text)
               $(".open").removeClass("open");
           },
           error: function(data) {
        		if (data.status == 403) {
           			$("#loginAlert").show();
           		}
           		else {
               		var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
               		$('.error').append(alert);
           		}
           }
       });
    });    
});

$(window).on('load', function () {
	var divWindow = $(".valueDiv");
	$(".deleteText").css('float', 'right');
	var images = $(".imgDiv");
	resizeImage(images);
	
	function resizeImage(images) {
		$(".valueDiv").css('border', '1px solid rgba(0,0,0,.125)');
		for(var i =0; i < images.length; i++) {
			if (images[i].width > divWindow.width() || images[i].width >= 800) {
				$(".valueDiv").find("#"+images[i].id).css("width", 800);
				images[i].width = 800;
			} else {
				$(".valueDiv").find("#"+images[i].id).css("width", images[i].width);
			}
		}
	}
});

</script>
</head>
<body>
    <div class="main-content" layout:fragment="content">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
            	<a th:href="@{/staff/dashboard}">Dashboard</a></li>
            <li class="breadcrumb-item">
            	<a th:href="@{/staff/module/list}">Modules</a></li>
            <li class="breadcrumb-item">
            	<a th:href="@{'/staff/module/'+${module.id}}">[[${module.name}]]</a></li>
            <li class="breadcrumb-item" th:each="slideSequence: ${slideSequences}">
            	<a th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${slideSequence.id}}" th:name="${slideSequence.name}">[[${slideSequence.name}]]</a></li>	
            <li class="breadcrumb-item active">[[${slide.name}]]</li>
        </ol>
        
        <div class="error"></div>
        
		<div class="dropdown" style="float: right">
        	<button class="btn branchbtn dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
		    	<i class="fa fa-code-branch"></i> Branching point
			</button>
			<div class="dropdown-menu" aria-labelledby="dropdownMenu2" th:each="choice: ${choices}">
			    <a  class="dropdown-item" 
			    	th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${choice.sequence.id}}"
	                th:name="${choice.sequence.name}">[[${choice.sequence.name}]]</a>
			</div>
        </div>       
        
        <h2><span style="color: var(--dark-grey)">Slide:</span> [[${slide.name}]]
        	<i class="fa fa-info-circle black" data-toggle="tooltip" data-html="true" data-placement="top" 
	   			th:title="|Created on <span class='date'>${slide.creationDate}</span> by ${slide.createdBy}|"></i>&emsp;
	   		<a th:href="@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/edit'}">
        		<i class="fas fa-edit"></i></a>
        </h2>
        <p id="description">[[${slide.description}]]</p>
                
        
        <div style="margin: 40px 0">
        	<button type="button" id="addText" class="btn pill-btn" data-toggle="tooltip" title="Add Text Block" data-placement="top">
        		<i class="fa fa-plus"></i>&emsp;<i class="fa fa-font"></i></button>&nbsp;
        	<button type="button" id="addImage" class="btn pill-btn" data-toggle="tooltip" title="Add Image" data-placement="top">
        		<i class="fa fa-plus"></i>&emsp;<i class="fa fa-image"></i></button>&nbsp;
        	<button type="button" id="addVideo" class="btn pill-btn" data-toggle="tooltip" title="Add Video" data-placement="top">
        		<i class="fa fa-plus"></i>&emsp;<i class="fa fa-video"></i></button>&nbsp;
        	<button type="button" id="addChoice" style="display: none;" class="btn pill-btn" data-toggle="tooltip" title="Add Sequence Choice" data-placement="top">
        		<i class="fa fa-plus"></i>&emsp;<i class="fa fa-square"></i></button>
            <p style="margin-top: 1rem;">Double Click on a Block to Edit it</p>
        </div>

		<!-- Delete Text Modal -->
		<div id="confirmDeleteTextAlert" class="modal" tabindex="-1"
			role="dialog" th:draggable="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Confirm Delete</h5>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<h6>Are you sure you want to delete this text block?</h6>
					</div>
					<div class="modal-footer">
						<button id="cancelDeleteText" type="reset" class="btn light">Cancel</button>
						<button type="submit" id="deleteText" class="btn btn-primary">Submit</button>
					</div>
				</div>
			</div>
		</div>
		<!-- Delete Image Modal -->
		<div id="confirmDeleteImageAlert" class="modal" tabindex="-1"
			role="dialog" th:draggable="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Confirm Delete</h5>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<h6>Are you sure you want to delete this image block?</h6>
					</div>
					<div class="modal-footer">
						<button id="cancelDelete" type="reset" class="btn light">Cancel</button>
						<button type="submit" id="deleteImage" class="btn btn-primary">Submit</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Delete ChoiceBlock Modal -->
		<div id="confirmDeleteChoiceBlockAlert" class="modal" tabindex="-1"
			role="dialog" th:draggable="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Confirm Delete</h5>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<h6>Are you sure you want to delete this choices Block?</h6>
					</div>
					<div class="modal-footer">
						<button id="cancelDeleteChoiceBlock" type="reset"
							class="btn light">Cancel</button>
						<button type="submit" id="deleteChoiceBlock"
							class="btn btn-primary">Submit</button>
					</div>
				</div>
			</div>
		</div>



		<div id="addTextAlert" class="modal" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document" th:draggable="true">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Add new Text Block</h5>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<form name="textForm" id="textUploadForm"
						enctype="multipart/form-data" method="post">
						<div class="modal-body">
							<h6>
								<small>Enter Text: </small>
							</h6>
							<textarea class="form-control" id="textBlockText" rows="3"></textarea>
						</div>
						<div class="modal-footer">
							<button id="cancelSubmitText" type="reset" class="btn light">Cancel</button>
							<button type="submit" id="submitText" class="btn btn-primary">Submit</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div id="editTextAlert" class="modal" tabindex="-1" role="dialog"
			th:draggable="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Edit Text Block</h5>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<form name="textForm" id="textEditUploadForm"
						enctype="multipart/form-data" method="post">
						<div class="modal-body">
							<h6>
								<small>Edit Text: </small>
							</h6>
							<textarea class="form-control" id="editTextBlock" rows="3"></textarea>
						</div>
						<div class="modal-footer">
							<button id="cancelTextBlock" type="reset" class="btn light">Cancel</button>
							<button type="submit" id="submitTextBlock"
								class="btn btn-primary">Submit</button>
						</div>
					</form>
				</div>
			</div>
		</div>


		<div id="addImgAlert" class="modal" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document" draggable="true">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Add New Image Block</h5>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<form name="photoForm" id="imageUploadForm"
						enctype="multipart/form-data" method="post">
						<div class="modal-body">
							<h6>
								<small>Upload Image: </small>
							</h6>
							<input class="form-control" type="file" name="file" rows="5"
								cols="500" id="file" />
						</div>
						<div class="modal-footer">
							<button id="cancelImageBtn" type="reset" class="btn light">Cancel</button>
							<button type="submit" id="uploadImage" class="btn btn-primary" data-value="">Upload
								Image</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div id="addVideoAlert" class="modal" tabindex="-1" role="dialog"
			aria-hidden="true">
			<div class="modal-dialog" role="document" draggable="true">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Add New Video Block</h5>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<form name="videoForm" id="videoUploadForm"
						enctype="multipart/form-data" method="post">
						<div class="modal-body">
							<div role="tabpanel">
								<ul class="nav nav-tabs" role="tablist">
									<li role="presentation" class="active"><a
										href="#uploadTab" id="uploadLink" aria-controls="uploadTab"
										role="tab" data-toggle="tab">Upload</a></li>
									<li role="presentation"><a href="#urlTab" id="urlLink"
										aria-controls="urlTab" role="tab" data-toggle="tab">Link</a></li>
								</ul>
								<!-- Tab panes -->
								<div class="tab-content">
									<div role="tabpanel" class="tab-pane active" id="uploadTab">
										Upload Video: <input id="videoFile" class="form-control"
											type="file" name="videoFile" rows="5" cols="500" />
									</div>
									<div role="tabpanel" class="tab-pane" id="urlTab">
										Enter URL: <input class="form-control" type="text"
											name="videoLink" rows="5" cols="500" id="videoLink" />
									</div>
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button id="cancelVideoBtn" type="reset" class="btn light">Cancel</button>
							<button type="submit" id="saveVideo" class="btn btn-primary">Upload
								Video</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div id="loginAlert" class="modal" tabindex="-1" role="dialog"
			backdrop="static"
			style="display: none; background-color: rgba(0, 0, 0, 0.5);">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Login</h5>
					</div>
					<div class="modal-body">
						<h6>You are not logged in, please login.</h6>
					</div>
					<div class="modal-footer">
						<a class="btn btn-primary" style="color: white;"
							onClick="window.location.reload();">Login</a>
					</div>
				</div>
			</div>
		</div>

		<div id="addChoiceAlert" class="modal" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Select from the Choices</h5>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<form name="choiceForm" id="choiceForm"
						enctype="multipart/form-data" method="post">
						<div id="choiceDiv" class="modal-body">
							<input class="choiceOptions" id="showAllChoices" type="checkbox"
								name="showAll" value="showAll" checked="true" /> <label
								for="showAll">Always show all choices</label><br />
							<div id="selectChoices">
								<div th:each="choice: ${choices}">
									<input class="choiceOptions" th:id="${choice.id}"
										type="checkbox" th:name="${choice.sequence.name}"
										th:value="${choice.sequence.name}" /> <label
										th:for="${choice.id}">[[${choice.sequence.name}]]</label> <br />
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button id="cancelSubmitChoice" type="reset" class="btn light">Cancel</button>
							<button type="submit" id="submitChoices" class="btn btn-primary">Submit</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<div id="slideSpace">
            <div th:each="contents: ${slideContents}">
                <div class="tab imgDiv row" th:id="${contents.id}" th:if="${#strings.equals(contents['class'].simpleName,'ImageBlock')}" style="align-items: center">
                	<a class="btn col-md-1" href="#"> 
                    	<i style="color: var(--dark-grey)" class="fas fa-grip-vertical"></i>
                    </a>
                    <img th:id="${contents.id}" class="imgDiv col-md-10" th:src="@{'/api/image/'+${contents.image.id}}" />
                    <input type="hidden" id="deleteImageId" th:value="${contents.id}"> 
                    <a class="btn deleteImage col-md-1" href="javascript:;"> 
                        <i style="color: var(--error)" class="fas fa-trash-alt"></i>
                    </a>
                </div>
                <div style="align-items: center" class="tab vidDiv row" th:id="${contents.id}" th:if="${#strings.equals(contents['class'].simpleName,'VideoBlock')}">
					<a class="btn col-md-1" href="#"> 
                    	<i style="color: var(--dark-grey)" class="fas fa-grip-vertical"></i>
                    </a>
                    <iframe th:id="${contents.id}" width="800" height="530" th:src="${contents.url}" th:if="${contents.url}" frameborder="0"
						allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
						allowfullscreen ></iframe>
					<iframe th:id="${contents.id}" width="800" height="530" th:if="${contents.video}"
						th:src="@{'/api/video/'+${contents.video.id}}" frameborder="0"
						allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
						allowfullscreen ></iframe>
					


					<input type="hidden" id="deleteVideoId" th:value="${contents.id}">
					<a class="btn deleteVideo" href="javascript:;"
						style="float: right;"> <i style="color: black;"
						class="fas fa-trash-alt"></i>
					</a>
				</div>
                <div th:id="${contents.id}" class="tab textDiv row" th:if="${#strings.equals(contents['class'].simpleName,'TextBlock')}" style="align-items: center">
                	<a class="btn col-md-1" href="#"> 
                    	<i style="color: var(--dark-grey)" class="fas fa-grip-vertical"></i>
                    </a>
                    <p class="col-md-10"> [[${contents.text}]] 
                    <input type="hidden" id="deleteTextId" th:value="${contents.id}" />
                    </p>
                    <a class="btn deleteText col-md-1" href="javascript:;"> 
                    	<i style="color: var(--error)" class="fas fa-trash-alt"></i>
                    </a>
                </div>
                <div th:id="${contents.id}" class="tab row" th:if="${#strings.equals(contents['class'].simpleName,'ChoiceBlock')}" style="align-items: center">
                	<a class="btn col-md-1" href="#"> 
                    	<i style="color: var(--dark-grey)" class="fas fa-grip-vertical"></i>
                    </a>
                    <a th:if="${contents.showsAll}" th:each="choice: ${choices}"
                        th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${choice.sequence.id}}">[[${choice.sequence.name}]]</a>
                    <a th:if="!${contents.showsAll}" th:each="choice: ${contents.choices}"
                        th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${choice.sequence.id}}">[[${choice.sequence.name}]]</a>
                    <input type="hidden" class="col-md-8" id="deleteChoiceBlockId" th:value="${contents.id}"> 
                    <a class="btn deleteChoiceBlock col-md-1" href="javascript:;">
                        <i style="color: var(--error)" class="fas fa-trash-alt"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</body>
