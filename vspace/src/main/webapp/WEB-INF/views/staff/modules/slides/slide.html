<html layout:decorate="~{layouts/main_staff}">
    <head>
        <link rel="stylesheet"
            href="https://unpkg.com/easymde/dist/easymde.min.css">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
        <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
		<script th:src="@{/resources/jquery/jquery-ui.min_custom_sortable.js}"></script>
        <style type="text/css">
            .hova {
            background-color: #f2f2f2;
            }
            .EasyMDEContainer .CodeMirror-wrap{
            overflow-y: scroll;
            height: 400px;
            }
            .fixed {
		    position: fixed;
		    top:0; left:0;
		    width: 100%;
		    z-index:100;
     		}
     		
     		li.active>a{
			background: solid var(--primary);
			color: #fff;
			font-size: 15px;
			}
			
			a.nav-link.active.show {
			border-color: transparent;
			border-bottom: 4px solid var(--primary);
			color: var(--primary) !important;
			background: transparent;
			}
            .tooltip {
                z-index: 0;
            }
        </style>
        <script th:inline="javascript">
            $(function () {
		        $('.close').on('click', function () {
		        	$('.modal').hide();
		        })
            })

            var currentSpaceName;
            var contentCount = [[${#lists.size(slideContents)}]];
            var markDown = null;
            var defaultValue;
            var formDataCancel;
            var currentSpaceId;
            var addVideoClk=0;
            var editVideoClk=0;
            var currentBlockId;
            var currentRefId;
            
            $(function () {
            	  $('[data-toggle="tooltip"]').tooltip()
            });
            
            $(window).scroll(function(){
            	  var sticky = $('.sticky'),
            	      scroll = $(window).scrollTop();
            	  if (scroll >= 100) sticky.addClass('fixed');
            	  else sticky.removeClass('fixed');
            });
            
            function createImageBlock(reader, width) {
                var imageblock = $('<div id="current" class="valueDiv tab row"><img src="#" style="imgDiv tab row"/><input type="hidden" id="deleteImageId" /><a class="btn deleteImage" href="javascript:;" style="position: absolute; right:64px;"><i style="color: var(--error);" class="fas fa-trash-alt"></i></a></div>');
                imageblock.find('img').attr('src', reader.result);
                if(width > 800)
                	imageblock.find('img').attr('width', '800px');
                return imageblock;
            }
            
            function createImageBlockWithExistingImage(src, width) {
                var imageblock = $('<div id="current" class="valueDiv tab row"><img src="#" style="imgDiv tab row"/><input type="hidden" id="deleteImageId" /><a class="btn deleteImage col-md-1" href="javascript:;" style="position:absolute; right:25px;"><span class="icon-trash error"></span></a></div>');
                imageblock.find('img').attr('src', src);
                if(width > 800)
                	imageblock.find('img').attr('width', '800px');
                return imageblock;
            }
            
            function createVideoBlock(reader, videoSrc, title, isUrlProvided, videoId) {
                var videoBlock = $("<div></div>");
                videoBlock.attr('id', videoId || "currentVideo");
                videoBlock.attr('class', "tab vidDiv row");
                videoBlock.attr('data-video-block', '');
                videoBlock.css('border', '1px solid rgba(0, 0, 0, 0.125)');
                
                var innerDiv1 = $("<div></div>");
                var heading = $("<h3></h3>");
                heading.append($("<strong></strong>"));
                innerDiv1.append(heading);
                
                if (isUrlProvided) {
                    var iframe = $("<iframe></iframe>");
                    iframe.attr('width', "800");
                    iframe.attr('height', "530");
                    iframe.attr('src', videoSrc);
                    iframe.attr('frameborder', "0");
                    iframe.attr('allow', "accelerometer; clipboard-write; encrypted-media;gyroscope; picture-in-picture");
                    iframe.attr('allowFullScreen', '');
                    innerDiv1.append(iframe);
                } else {
                    var video = $("<video></video>");
                    video.attr('width', "800");
                    video.attr('height', "530");
                    video.attr('controls', true);
                    var source = $("<source></source>");
                    source.attr('src', videoSrc);
                    source.attr('type', "video/mp4");
                    video.append(source);
                    innerDiv1.append(video);
                }
                
                videoBlock.append(innerDiv1);
                
                // Delete button with data attributes
                var anchor1 = $("<a></a>");
                anchor1.attr('href', "javascript:;");
                anchor1.attr('class', "btn col-md-1");
                anchor1.attr('data-action', "delete-video");
                anchor1.attr('data-video-id', videoId || "");
                anchor1.css('position', 'absolute');
                anchor1.css('right', '25px');
                var span1 = $("<span></span>");
                span1.attr('class', "icon-trash error");
                anchor1.append(span1);
                videoBlock.append(anchor1);
                
                // Edit button with data attributes
                var anchor2 = $("<a></a>");
                anchor2.attr('href', "javascript:;");
                anchor2.attr('class', "btn col-md-1");
                anchor2.attr('data-action', "edit-video");
                anchor2.attr('data-editvideo-id', videoId || "");
                anchor2.css('position', 'absolute');
                anchor2.css('top', '60px');
                anchor2.css('right', '25px');
                var span2 = $("<span></span>");
                span2.attr('class', "icon-edit");
                anchor2.append(span2);
                videoBlock.append(anchor2);
                
                videoBlock.find('h3 strong').html(title);
                return videoBlock;
            }
            
            function onMouseEnter(e){
                var target = $( e.target );
               
                $(".hova").removeClass("hova");
                $(e.target).addClass("hova");
                // This is needed to prevent only the p tag from being highlighted
                if(target.is('p')){
                    $(e.target).parent().addClass("hova");
                }
                //prevent normal hover actions
                e.preventDefault();
            }
            function onMouseLeave(e) {
                $(this).removeClass("hova");
            }

            function getSelectedSpace(blockId) {
                $.ajax({
                    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/space/'})]" + blockId,
                    type: 'GET',
                    success: function(result) {
                    	if (result != null && result.space != null){
                            currentSpaceName = result.space.name;
                            currentSpaceId = result.space.id;
                            $("#selectedSpace").text(currentSpaceName);
                            $("#editSpaceBlock").text(result.title);
                            if ($("#editSpaceName").find("option[value='" + currentSpaceId + "']").length == 0) {
                                var newOption = new Option(currentSpaceName, currentSpaceId, true, true);
                                $("#editSpaceName").append(newOption).trigger('change');
                            } else {
                                $("#editSpaceName").val(currentSpaceId).trigger('change');
                            }

                            $("#editSpaceName").select2({
                                ajax: {
                                    url: [[@{|/staff/spaces/search|}]],
                                    dataType: 'json',
                                    processResults: function (data) {
                                        
                                        return {
                                            results: $.map(data, function(item) {
                                                return {
                                                    id: item.id,
                                                    text: item.name 
                                                };
                                            })
                                        };
                                    }
                                },
                                templateResult: function(data) {
                                    if (!data.id) {
                                        return data.text;
                                    }
                                    return $('<span>').text(data.text);
                                },
                                templateSelection: function(data) {
                                    return $('<span>').text(data.text);
                                }
                            });
                    	}

                    },
                    error: function(data) {
                        var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                        $('.error').append(alert);
                        $(".error").delay(4000).slideUp(500, function() {
                            $(".error").empty();
                        });
                    }
                });
            }

            
            function textBlockDoubleClick(e){
            	// get to the nearest divs class attribute
                $(".EasyMDEContainer").remove();
                var divName = $(e.target).closest('div').attr('class');
                //if the div is a text content block 
                $(e.target).closest('.textDivStaff').addClass("open");
                var description = $("div.open p:eq(0)").text();
            	defaultValue = description;
        
                $("#editTextAlert").show();
                markDown = new EasyMDE({element: $('#editTextBlock')[0]});
                markDown.value(description.trim());
                //remove card border
                $(".open").css('display', 'none');
                $(".open").css('overflow-y', 'scroll');
                $(".open").css('height', '400px');
            }

            function biblioBlockDoubleClick(e){
               $(".EasyMDEContainer").remove();
         	   $(e.target).closest('.biblioDivStaff').addClass("open");
         	   var description = $("div.open p:eq(0)").text();
           	   defaultValue = description;
           	
           	   var title = $("div.open p span:eq(0)").text();
           	   var desc = $("div.open p span:eq(1)").text();  
	      	    //showing the edit bibliography form with all the respective values
      	       $("#editBiblioAlert").show();
      	
      	       $("#editTitleBiblio").val(title);
      	       $("#editDescBiblio").val(desc);
           		
           	    formDataCancel = new FormData();
           	    formDataCancel.append('biblioTitle', title);
           	    formDataCancel.append('description', desc);
            	    //remove card border
                $(".open").css('display', 'none');
                $(".open").css('overflow-y', 'scroll');
                $(".open").css('max-height', '200px');	
             } 
             
            function referenceBlockDoubleClick(e) {
                currentRefId = $(this).find('input[data-reference-id]').val();
                $(".EasyMDEContainer").remove();
                $(e.target).closest('.referenceDivStaff').addClass("open");
                var description = $("div.open p:eq(0)").text();
                defaultValue = description;
                
                var title = $("div.open p span:eq(0)").text();
                var author = $("div.open p span:eq(1)").text();
                var year = $("div.open p span:eq(2)").text();
                var journal = $("div.open p span:eq(3)").text();
                var url = $("div.open p span:eq(4)").text();
                var volume = $("div.open p span:eq(5)").text();
                var issue = $("div.open p span:eq(6)").text();
                var pages = $("div.open p span:eq(7)").text();
                var editors = $("div.open p span:eq(8)").text();
                var type = $("div.open p span:eq(9)").text();
                var note = $("div.open p span:eq(10)").text(); 
                
                // Showing the edit reference form with all the respective values
                $("#editReferenceAlert").show();
                
                // Clear existing hidden inputs
                $("#editReferenceAlert .modal-footer input[type='hidden']").remove();
                
                // Get bibliography ID from the parent element 
                var biblioId = $(this).closest("[data-biblio-block]").attr("id");
                
                // Create a hidden input with a better ID
                var biblioInput = $('<input type="hidden" id="editRefBiblioId">');
                biblioInput.val(biblioId);
                $("#editReferenceAlert .modal-footer").append(biblioInput);
                
                $("#editTitleRef").val(title);
                $("#editAuthorRef").val(author);
                $("#editYearRef").val(year);
                $("#editJournalRef").val(journal);
                $("#editUrlRef").val(url);
                $("#editVolumeRef").val(volume);
                $("#editIssueRef").val(issue);
                $("#editPagesRef").val(pages);
                $("#editEditorsRef").val(editors);
                $("#editTypeRef").val(type);
                $("#editNoteRef").val(note);
                
                formDataCancel = new FormData();
                formDataCancel.append('title', title);
                formDataCancel.append('author', author);
                formDataCancel.append('year', year);
                formDataCancel.append('journal', journal);
                formDataCancel.append('url', url);
                formDataCancel.append('volume', volume);
                formDataCancel.append('issue', issue);
                formDataCancel.append('pages', pages);
                formDataCancel.append('editors', editors);
                formDataCancel.append('type', type);
                formDataCancel.append('note', note);
                
                // Remove card border
                $(".open").css('display', 'none');
                $(".open").css('overflow-y', 'scroll');
                $(".open").css('max-height', '200px');
            }
             
            function spaceBlockDoubleClick(e) {
        	 	$(".EasyMDEContainer").remove();
        	 	var divName = $(e.target).closest('div').attr('class');
        	 	let spaceId = e.target.closest('div').id;
        	 	$(e.target).closest('.SpaceDivStaff').addClass("open");
        	 	defaultValue = $("div.open p:eq(0)").text();
        	 	var blockId = $(this).closest("div").attr("id");
        	 	currentBlockId = blockId;
        	 	getSelectedSpace(blockId);
        	 	$("#editSpaceAlert").show();
        	 	$(".open").css('display', 'none');
        	 	$(".open").css('overflow-y', 'scroll');
        	 	$(".open").css('height', '400px');
            }
            
            function imageBlockDoubleClick(e) {
                $(".EasyMDEContainer").remove();
                var divName = $(e.target).closest('div').attr('class');
                var imgBlockID = $(e.target).closest('[data-image-block]').attr('id'); 
                
                if(imgBlockID != ''){
                    $("#uploadImage").data('value', imgBlockID);
                    $("#addImgAlert").show();
                }
            }
                
            function uploadImage() {
                var imgBlockID = $("#uploadImage").data('value');
                var file = $('#file')[0].files[0];
                var reader = new FileReader();
                var formData = new FormData();
                var chooseFromExisting = true;
                
                if (typeof(file) != "undefined"){
                    chooseFromExisting = false;
                    formData.append('file', file);
                }
                
                var imageSource = $('#selectedImage').find('img').attr('src');
                var imageId = "";
                if(typeof(imageSource) != "undefined"){
                    imageId = imageSource.split("/").pop().split(".")[0];
                }
                
                var imageblock = "";
                var oldImageBlock = "";
                var token = [[${_csrf.token}]];
                
                // Checks if image ID is present to replace
                if (imgBlockID != '') {
                    oldImageBlock = $("#" + imgBlockID);
                    var imageBlockId = imgBlockID;
                    formData.append('imageBlockId', imageBlockId);
                    var url = "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/image/'})]" + imageBlockId;
                    
                    if(!chooseFromExisting){
                        reader.onload = function (theFile) {
                            var image = new Image();
                            image.src = theFile.target.result;
                            image.onload = function () {
                                imageblock = createImageBlockWithDataAttributes(reader, this.width, imageBlockId);
                                $("#" + imageBlockId).replaceWith(imageblock);	
                                $(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(imageBlockDoubleClick);
                            };
                        }
                    }
                    else{
                        var image = new Image();
                        image.src = $('#selectedImage').find('img').attr('src');
                        formData.append('imageId', imageId);
                        imageblock = createImageBlockWithDataAttributesExisting($('#selectedImage').find('img').attr('src'), image.width, imageBlockId);
                        $("#" + imageBlockId).replaceWith(imageblock);	
                        $(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(imageBlockDoubleClick);
                    }
                    // Reset data-attribute to get current selected image ID
                    $("#uploadImage").data('value', '');
                }
                else {
                    var url = "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/image'})]";
                    if(!chooseFromExisting){
                        reader.onload = function (theFile) {        	
                            var image = new Image();
                            image.src = theFile.target.result;
                            image.onload = function() {
                                imageblock = createImageBlockWithDataAttributes(reader, this.width, null);  
                                $('#slideSpace').append(imageblock); 
                                $(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(imageBlockDoubleClick);
                            };          
                        } 
                    }
                    else {
                        var image = new Image();
                        image.src = $('#selectedImage').find('img').attr('src');
                        formData.append('imageId', imageId);
                        imageblock = createImageBlockWithDataAttributesExisting($('#selectedImage').find('img').attr('src'), image.width, null);  
                        $('#slideSpace').append(imageblock); 
                        $(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(imageBlockDoubleClick);
                    }
                }
                
                if (!chooseFromExisting) {
                    reader.readAsDataURL(file);
                }
                
                $.ajax({
                    enctype: 'multipart/form-data',
                    url: url,
                    type: 'POST',
                    cache: false,
                    contentType: false,
                    processData: false,
                    headers: {
                        'X-CSRF-TOKEN': token
                    },
                    data: formData,    
                    success: function(data) {
                        $(".open").removeClass("open");
                        var img = imageblock.find('img');
                        if(data != ''){
                            img.attr('id', data);
                            $("#current").find('input[data-image-id]').val(data);
                            $("#current").attr('id', data);
                        }
                        else{
                            img.attr('id', imgBlockID);
                            $("#current").find('input[data-image-id]').val(imgBlockID);
                            $("#current").attr('id', imgBlockID);
                        }
                    },
                    error: function(data) {
                        if (imgBlockID == '') {
                            $("#current").remove();
                        }
                        else {
                            $("#current").replaceWith(oldImageBlock);
                        }
                        if (data.status == 403) {
                            $("#loginAlert").show();
                        }
                    }
                });
                
                // Reset the image file name 
                $('#file').val('');
                if(chooseFromExisting) {
                    $("#selectedImage").empty();
                    $('#imageId').prop('selectedIndex',0).trigger("change");
                }
            }
            
            function createImageBlockWithDataAttributes(reader, width, blockId) {
                var imageblock = $(
                    '<div id="current" class="valueDiv tab row" data-image-block>' + 
                    '<img src="#" style="imgDiv tab row"/>' + 
                    '<input type="hidden" data-image-id="' + (blockId || '') + '" />' + 
                    '<a class="btn col-md-1" data-action="delete-image" href="javascript:;" style="position: absolute; right:64px;">' + 
                    '<i style="color: var(--error);" class="fas fa-trash-alt"></i></a>' + 
                    '</div>'
                );
                imageblock.find('img').attr('src', reader.result);
                if(width > 800)
                    imageblock.find('img').attr('width', '800px');
                return imageblock;
            }

            function createImageBlockWithDataAttributesExisting(src, width, blockId) {
                var imageblock = $(
                    '<div id="current" class="valueDiv tab row" data-image-block>' + 
                    '<img src="#" style="imgDiv tab row"/>' + 
                    '<input type="hidden" data-image-id="' + (blockId || '') + '" />' + 
                    '<a class="btn col-md-1" data-action="delete-image" href="javascript:;" style="position:absolute; right:25px;">' + 
                    '<span class="icon-trash error"></span></a>' + 
                    '</div>'
                );
                imageblock.find('img').attr('src', src);
                if(width > 800)
                    imageblock.find('img').attr('width', '800px');
                return imageblock;
            }
            
            function embedVideo() {
                var videoID = $("#saveVideo").data('value'); // gets video ID
                var oldUrl = $("#saveVideo").data('url');
                var url = $("#videoLink").val();
                var title = $("#videoTitle").val();
                var vidFile = $("#videoFile")[0].files[0];
                var reader = new FileReader();
                var videoBlock = "";
                var ajaxUrl = '';
                var oldVideoBlock = '';
                var formData = new FormData();
                
                if (url) {
                    if(url.startsWith("https://www.youtube.com/watch?v=")) {
                        videoId = url.substring(url.indexOf("v=")+2);
                        url = "https://www.youtube.com/embed/"+videoId;
                    }
                    formData.append('url', url);
                    videoBlock = createVideoBlock(reader, url, title, true, videoID);
                }
                
                if (vidFile) {
                    formData.append('videoFile', vidFile);
                }
                
                if (videoID) {
                    oldVideoBlock = $("#" + videoID);
                    ajaxUrl = "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/video/'})]" + videoID;
                    formData.append('videoBlockId', videoID);
                    
                    if (url) {
                        $("#" + videoID).replaceWith(videoBlock);
                    }
                    if (vidFile) {
                        reader.onload = function (theFile) {
                            videoBlock = createVideoBlock(reader, theFile.target.result, title, false, videoID);
                            $("#" + videoID).replaceWith(videoBlock);
                        };
                    }
                } else {
                    if (url) {
                        $('#slideSpace').append(videoBlock);
                    }
                    if (vidFile) {
                        reader.onload = function (theFile) {
                            videoBlock = createVideoBlock(reader, theFile.target.result, title, false, "currentVideo");
                            $('#slideSpace').append(videoBlock);
                        }
                    }
                    ajaxUrl = "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/video'})]";
                }
                
                // Reset data-attribute to get current selected video ID
                $("#videoFile").val('');
                $("#videoLink").val('');
                
                $(videoBlock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave);
                
                if (vidFile) {
                    reader.readAsDataURL(vidFile);
                }
                
                formData.append('videoTitle', title);
                var token = [[${_csrf.token}]];
                
                $.ajax({
                    enctype: 'multipart/form-data',
                    url: ajaxUrl,
                    type: 'POST',
                    cache: false,
                    contentType: false,
                    processData: false,
                    data: formData,
                    headers: {
                        'X-CSRF-Token': token
                    },
                    success: function (data) {
                        if(videoBlock) {
                            var videoBlk = "";
                            if(url) {
                                videoBlk = videoBlock.find('iframe');
                            } else {
                                videoBlk = videoBlock.find('video');
                            }
                            
                            if (data != '') {
                                videoBlk.attr('id', data);
                                $("#currentVideo [data-action='delete-video']").attr('data-video-id', data);
                                $("#currentVideo [data-action='edit-video']").attr('data-editvideo-id', data);
                                $("#currentVideo").attr('id', data);
                            } else {
                                videoBlk.attr('id', videoID);
                                $("#currentVideo [data-action='delete-video']").attr('data-video-id', videoID);
                                $("#currentVideo [data-action='edit-video']").attr('data-editvideo-id', videoID);
                                $("#currentVideo").attr('id', videoID);
                            }
                        } else {
                            if(videoID) {
                                $("#" + videoID).find('h3 strong').html(title);
                            }
                        }
                    },
                    error: function (data) {
                        if (videoID == '') {
                            $("#current").remove();
                        } else {
                            $("#current").replaceWith(oldVideoBlock);
                        }
                        if (data.status == 403) {
                            $("#loginAlert").show();
                        } else {
                            var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>Please try again.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                            $('.error').append(alert);
                        }
                    }
                });
            }
            
            $(document).on("click", "[data-action='edit-video']", function(e) {
                addVideoClk = 0;
                editVideoClk = 1;
                $("#saveVideo").html("Update Video");
                $("#saveVideo").prop('disabled', false);
                
                var id = $(this).attr('data-editvideo-id');
                var vidId = $('div#' + id).attr('id');
                var title = $('div#' + id).find('h3 strong').html();
                
                if (vidId != '') {
                    var url = "";
                    if($('div#' + id).find('iframe').length > 0 && 
                       $('div#' + id).find('iframe').attr('src') != null && 
                       typeof($('div#' + id).find('iframe').attr('src')) != "undefined") {
                        url = $('div#' + id).find('iframe').attr('src');
                    }
                    
                    if (url.length > 0) {
                        $("#saveVideo").data('url', url);
                        $("#videoLink").val(url);
                        $("#urlTab").addClass("active");
                        $("#urlLink").addClass("active show");
                        $("#uploadTab").removeClass("active show");
                        $("#uploadLink").removeClass("active show");
                        $("#urlLink>a").addClass("active show");
                        $("#uploadLink").removeClass("active show");
                        $("#uploadLink>a").removeClass("active show");
                    } 
                    
                    $("#videoTitle").val(title);
                    $("#saveVideo").data('value', vidId);
                    $("#addVideoAlert").show();
                }
            });
            
            $(document).on("click", "[data-action='delete-video']", function(e) {
                $("#confirmDeleteVideoAlert .modal-footer input[type='hidden']").remove();
                $("#videoIdToDelete").val($(this).attr('data-video-id'));
                
                $(".load").remove();
                $("#" + $(this).attr('data-video-id')).append($('<div class="load" style="font-size: 30px;display: none; text-align: center;"><i class="fa fa-spinner fa-spin" aria-hidden="true"></i></div>'));
                $(".load").show();
                
                setTimeout(function() {
                    $(".load").hide();
                    $("#confirmDeleteVideoAlert").show();
                }, 3000);
            });
            
            function guidedTour() {
            	const tour = new Shepherd.Tour({
            		  defaultStepOptions: {
            		    cancelIcon: {
            		      enabled: true
            		    },
            		    classes: '',
            		    scrollTo: { behavior: 'smooth', block: 'center' },
            		  },
            		  useModalOverlay: true,
            		});
            
            	tour.addStep({
            	  title: 'Welcome to the slide editor!',
            	  text: `Add or edit the content you want to show on your slides.`,
            	  buttons: [
            	    {
            	      action() {
            	        return this.next();
            	      },
            	      text: 'Next'
            	    }
            	  ],
            	  id: 'creating1'
            	});
            	
            	tour.addStep({
            	  title: 'Easy navigation',
            	  text: `Keep track of your location in the module or navigate back.`,
            	  attachTo: {
            	    element: '.breadcrumb',
            	    on: 'bottom'
            	  },
            	  buttons: [
            	    {
            	      action() {
            	        return this.back();
            	      },
            	      classes: 'shepherd-button-secondary',
            	      text: 'Back'
            	    },
            	    {
            	      action() {
            	        return this.next();
            	      },
            	      classes: 'btn primary-btn',
            	      text: 'Next'
            	    }
            	  ],
            	  id: 'creating2'
            	});
            	
            	tour.addStep({
            	  title: 'Adding content',
            	  text: `Add content to your slide. The content will be shown in the exhibition in the order you define here.`,
            	  attachTo: {
            	    element: '.content-btns',
            	    on: 'bottom'
            	  },
            	  buttons: [
            	    {
            	      action() {
            	        return this.back();
            	      },
            	      classes: 'shepherd-button-secondary',
            	      text: 'Back'
            	    },
            	    {
            	      action() {
            	        return this.next();
            	      },
            	      text: 'Done'
            	    }
            	  ],
            	  id: 'creating3'
            	});
            	tour.start();
            }
            $(document).ready(function() {
            	if (localStorage.getItem("newSlide") == null) {
            		guidedTour();
            		localStorage.setItem("newSlide", false);
            	}
            	$('#imageId').prop("disabled",true);
            	$('#chooseFromLocal').click(function() {
            		$("#selectedImage").empty();
            		$('#imageId').prop('selectedIndex',0).trigger( "change" );
            		$('#imageId').prop("disabled",true);
            		$('#file').prop("disabled",false);
            		
            	  });
            	
            	$('#chooseFromExisting').click(function() {
            		$('#file').val('');
            		$('#file').prop("disabled",true);
            		$('#imageId').prop("disabled",false);
            	  });
            	var timeout=null;
            	$('#slideSpace').sortable({
	            	update: function(event,ui) {
		            	var jsonObj = [];
		            	var blockId;
		            	$(this).children().each(function(index,element){
			            	if(typeof($(element.innerHTML).filter('div').attr('data-position'))=="undefined") {
			            		blockId=$(element).attr('id');
			            	}else {
			            		blockId = $(element.innerHTML).filter('div').attr('id');
			            	}
			            	item = {}
			            	item ["id"] = blockId;
			            	item ["contentOrder"] = index;
			            	jsonObj.push(item);
			            	$(element.innerHTML).filter('div').attr('data-position',index);
		            	});
		            	var token = [[${_csrf.token}]];
		            	if (jsonObj.length != 0){
			            	if (timeout != null){
			            		clearTimeout(timeout);
			            	}
			            	timeout = setTimeout(updateContentOrder(jsonObj,token), 1000);
		            	}
	            	}
            	});

            	function updateContentOrder(jsonObj,token){
	            		$.ajax({
	            		 // ------------- adjusting content order of blocks if their position changed after dragging ----------
		            		url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/blocks/order/update'})]",
		            		type: 'POST',
		            		beforeSend: function(){
			            		$(".loader").remove();
			            		$('#contOrdUpdStatus').empty();
			            		$('#contOrdUpdStatus').append($('<div class="loader" style="font-size: 30px;display: none; text-align: center;"><i class="icon-spinner" aria-hidden="true">Saving...</i></div>'));
			            		$(".loader").show();
		            		},
		            		complete: function(){
			            		$(".loader").hide();
			            		timeout = null;
		            		},
		            		cache       : false,
		            		contentType: 'application/json; charset=utf-8',
		            		processData :false,
		            		headers:{
		            			'X-CSRF-Token':token
		            		},
		            		data: JSON.stringify(jsonObj),
		            		success: function(data) {
			            		$(".save").remove();
			            		for(let i=0;i<data.length;i++) {
				            		$('#'+data[i].id).attr('data-position',data[i].contentOrder);
			            		} 
			            		var successDiv = $('<div style="width: 100%;height: 50px;" class="save alert alert-success alert-dismissible fade show" role="alert">');
			            		successDiv.append('<p>Successfully Saved.</p>');
			            		successDiv.append('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>');
			            		successDiv.append('</div>');
			            		$('#contOrdUpdStatus').empty();
			            		$('#contOrdUpdStatus').append(successDiv);
		            		},
		            		error: function(data) {
			            		$(".errInSave").remove();
			            		var errorDiv = $('<div style="width: 100%;height: 50px;" class="errInSave alert alert-danger alert-dismissible fade show" role="alert">');
			            		errorDiv.append('<p>We are sorry but something went wrong. Please try again later.</p>');
			            		errorDiv.append('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>');
			            		errorDiv.append('</div>');
			            		$('#contOrdUpdStatus').empty();
			            		$('#contOrdUpdStatus').append(errorDiv);
		            		}
	            		});
            		}
                [# th:if="${#strings.equals(slide['class'].simpleName,'BranchingPoint')}"]
            		$('#addChoice').show();
            		$('#choiceSpace').show();
            	[/]
            	
            
                //-------- edit contentblock description --------
            
                $("#submitDescription").hide();
                $("#cancelEditDescription").hide();
                var description = $("#description").text()
                $("#editDescription").click(function() {
                    $('<textarea id="newDescription" style="margin-top: 1%;" class="form-control" type="text">'+description+'</textarea>').insertBefore( "#description" );
                    $("#description").remove()
                    $("#editDescription").hide()
                    $("#submitDescription").show()
                    $("#cancelEditDescription").show()
                    
                });
            
                $("#submitDescription").click(function() {
                    var formData = new FormData();
                    var token = [[${_csrf.token}]];
                    formData.append('description', $("#newDescription").val());
                    $.ajax({ 
            	        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/edit/description'})]",
            	        type: 'POST',
            	        cache       : false,
            	        contentType : false,
            	        processData : false,
            	        headers:{
	            			'X-CSRF-Token':token
	            		},
            	        data: formData,
            	        enctype: 'multipart/form-data',
            	        success: function(data) {
            	            // replace text box with new description
            	            $("#submitDescription").hide()
            	            $("#cancelEditDescription").hide()
            	            $("#editDescription").show()
            	            var val = $("#newDescription").val();
            	            $('<p id="description"style="margin-top: .5rem; margin-bottom: .5rem;"></p>').insertBefore( "#newDescription" );
            	            $("#newDescription").remove();
            	            $("#description").text(val)
            	        },
            	        error: function(data) {
            	            $(".open").removeClass("open");
            	                var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            	                $('.error').append(alert);
            	        }
                     });       
                  });
                
                $("#cancelEditDescription").click(function(){
                    $("#submitDescription").hide()
                    $("#editDescription").show()
                    $("#cancelEditDescription").hide()
                    $('<p id="description" style="margin-top: .5rem; margin-bottom: .5rem;"></p>').insertBefore( "#newDescription" );
                    $("#newDescription").remove()
                    $("#description").text(description)
                    
                });
                
                //------- edit title --------
                $("#submitTitle").hide();
                $("#cancelEditTitle").hide();
                var getTitleText = $("#title").text().split(": ")[1]
                $("#editTitle").click(function() {
                    $('<div class="col-4"><input id="newTitle" class="form-control" type="text"></div>').insertAfter( "#title" );
                    $('#title').text('Slide: ')
                    $("#newTitle").val(getTitleText)
                    $("#editTitle").hide()
                    $("#submitTitle").show()
                    $("#cancelEditTitle").show()       
                });
                
                $("#submitTitle").click(function() {
                    var token = [[${_csrf.token}]];
                    var formData = new FormData();
                    formData.append('title', $("#newTitle").val());
                    $.ajax({
                        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/edit/title'})]",
                        type: 'POST',
                        cache       : false,
                        contentType : false,
                        processData : false,
                        headers:{
	            			'X-CSRF-Token':token
	            		},
                        data: formData,
                        enctype: 'multipart/form-data',
                        success: function(data) {
                            // replace text box with new description
                            $("#submitTitle").hide()
                            $("#cancelEditTitle").hide();
                            $("#editTitle").show()
                            var val = $("#newTitle").val();
                            $("#newTitle").closest('div').remove();
                            $("#title").text("Silde: " + val)
                            
                        },
                        error: function(data) {
                            var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                            $('.error').append(alert);
                        }
                    });
                  });
               $("#cancelEditTitle").click(function(){
                    $("#submitTitle").hide()
                    $("#editTitle").show()
                    $("#cancelEditTitle").hide()
                    $("#newTitle").closest('div').remove();
                    $("#title").text("Silde: " + getTitleText);
               });
               
                $("#addText").click(function() {
                    $(".EasyMDEContainer").remove();
                	markDown = new EasyMDE({element: $('#textBlockText')[0]});
                    $("#addTextAlert").show();
                });
                
	            $("#addSpace").click(function() {
		            markDown = new EasyMDE({element: $('#spaceBlockText')[0]});
		            $("#addSpaceAlert").show();
	            });

	            $("#spaceName").select2({
		            ajax: {
			            url: [[@{|/staff/spaces/search|}]],
			            dataType: 'json',
			            processResults: function (data) {
				            return {
				            	results: data,
				            };
			            },
		            },
		            templateResult: formatSpace,
		            templateSelection: formatSpace
	            });

	            function formatSpace (space) {
		            if (!space.id) {
		            	return space.name;
		            }
		            var $space = $('<span>' + space.name + '</span>');
		            return $space;
	            }
	
                $("#addImage").click(function() {
                    $("#addImgAlert").show();
                });
                
                $("#addVideo").click(function() {
                    $("#videoTitle").value = "";
                    $("#addVideoAlert").show();
                    addVideoClk =1;
                    editVideoClk=0;
                });
                
                $("#uploadImage").click(function(e) {
                    e.preventDefault();
                    $("#addImgAlert").hide();
                    uploadImage();
                    $('#chooseFromLocal').trigger( "click" );
                });
                
                $("#saveVideo").click(function(e) {
                    e.preventDefault();
                    $("#addVideoAlert").hide();
                    embedVideo();
                    $("#saveVideo").data('value', '');
                    $("#saveVideo").data('url', '');
                    $("#uploadTab").addClass("active");
                    $("#urlTab").removeClass("active");
                    $("#urlLink").removeClass("active show");
                    $("#urlLink>a").removeClass("active show");
                    $("#uploadLink").addClass("active show");
                    $("#uploadLink>a").addClass("active show");
                });
                
                $("#addChoice").click(function() {
                    $("#addChoiceAlert").show();
                });
                
             	// Delete Text Click Handler
                $(document).on("click", "[data-action='delete-text']", function(e) {
                    $("#confirmDeleteTextAlert .modal-footer input[type='hidden']").remove();
                    $("#confirmDeleteTextAlert").show();
                    
                    var textId = $(this).siblings("input[data-text-id]").val();
                    var textInput = $('<input type="hidden" id="deleteTextId">');
                    textInput.val(textId);
                    $('#confirmDeleteTextAlert .modal-footer').append(textInput);
                });

             	// Delete Space Click Handler
                $(document).on("click", "[data-action='delete-space']", function(e) {
                    $("#confirmDeleteSpaceAlert .modal-footer input[type='hidden']").remove();
                    $("#confirmDeleteSpaceAlert").show();
                    
                    var spaceId = $(this).siblings("input[data-space-id]").val();
                    var spaceInput = $('<input type="hidden" id="deleteSpaceId">');
                    spaceInput.val(spaceId);
                    $('#confirmDeleteSpaceAlert .modal-footer').append(spaceInput);
                });

             	// Delete Image Click Handler
                $(document).on("click", "[data-action='delete-image']", function(e) {
                    $("#confirmDeleteImageAlert .modal-footer input[type='hidden']").remove();
                    $("#confirmDeleteImageAlert").show();
                    
                    var imageId = $(this).siblings("input[data-image-id]").val();
                    var imageInput = $('<input type="hidden" id="deleteImageId">');
                    imageInput.val(imageId);
                    $('#confirmDeleteImageAlert .modal-footer').append(imageInput);
                });
            	
             	// Delete Video Click Handler
                $(document).on("click", "[data-action='delete-video']", function(e) {
                    $("#confirmDeleteVideoAlert .modal-footer input[type='hidden']").remove();
                    
                    var videoId = $(this).attr('data-video-id');
                    $("#videoIdToDelete").val(videoId);
                    
                    $(".load").remove();
                    $("#" + videoId).append($('<div class="load" style="font-size: 30px;display: none; text-align: center;"><i class="fa fa-spinner fa-spin" aria-hidden="true"></i></div>'));
                    $(".load").show();
                    
                    setTimeout(function() {
                        $(".load").hide();
                        $("#confirmDeleteVideoAlert").show();
                    }, 3000);
                });
            	
            $("#addBibliography").click(function() {
                 $("#addBiblioAlert").show();
             });
           	
         	// Add Reference Click Handler
            $(document).on("click", "[data-action='add-reference']", function(e) {
                $("#addReferenceAlert").show();
                // Clear any existing hidden inputs first
                $("#addReferenceAlert .modal-footer input[type='hidden']").remove();
                
                var biblioId = $(this).closest("[data-biblio-block]").attr("id");
                var biblioInput = $('<input type="hidden" id="addReferenceTarget">');
                biblioInput.val(biblioId);
                $('#addReferenceAlert .modal-footer').append(biblioInput);
            });
             
         	// Delete Bibliography Click Handler
            $(document).on("click", "[data-action='delete-biblio']", function(e) {
                // Clear any existing hidden inputs
                $("#confirmDeleteBiblioAlert .modal-footer input[type='hidden']").remove();
                $("#confirmDeleteBiblioAlert").show();
                
                var biblioId = $(this).siblings("input[data-biblio-id]").val();
                var biblioInput = $('<input type="hidden" id="deleteBiblioId">');
                biblioInput.val(biblioId);
                $('#confirmDeleteBiblioAlert .modal-footer').append(biblioInput);
            });
             
            $(document).on("click", "[data-action='delete-reference']", function(e) {
                $("#confirmDeleteRefAlert .modal-footer input[type='hidden']").remove();
                $("#confirmDeleteRefAlert").show();
                
                // Create reference ID input
                var refInput = $('<input type="hidden" id="deleteReferenceId">');
                refInput.val($(this).siblings("input[data-reference-id]").val());
                $("#confirmDeleteRefAlert .modal-footer").append(refInput);
                
                // Create bibliography parent ID input
                var biblioInput = $('<input type="hidden" id="referenceBlockBiblioId">');
                biblioInput.val($(this).closest("[data-biblio-block]").attr("id"));
                $("#confirmDeleteRefAlert .modal-footer").append(biblioInput);
            });
            	
          	// Delete Choice Block Click Handler
             $(document).on("click", "[data-action='delete-choice']", function(e) {
                 // Clear any existing hidden inputs
                 $("#confirmDeleteChoiceBlockAlert .modal-footer input[type='hidden']").remove();
                 $("#confirmDeleteChoiceBlockAlert").show();
                 
                 var choiceId = $(this).siblings("input[data-choice-id]").val();
                 var choiceInput = $('<input type="hidden" id="deleteChoiceBlockId">');
                 choiceInput.val(choiceId);
                 $('#confirmDeleteChoiceBlockAlert .modal-footer').append(choiceInput);
             });
                
                $("#cancelSubmitText").click(function() {
            		$("#addTextAlert").hide();	
            	});

                $("#cancelSpaceText").click(function() {
            		removeAllSelectOptions("spaceName");
            		$("#addSpaceAlert").hide();
            	});

                function removeAllSelectOptions(elementId){
            		var element = document.getElementById(elementId);
            		element.innerHTML="";
            	}
            	
                function setSelectOption(elementId, option){
            		var element = document.getElementById(elementId);
            		element.innerHTML= option;
            	}
            	
            	$("#cancelDeleteText").click(function() {
            		$("#confirmDeleteTextAlert").find('input').remove();
         		$("#confirmDeleteBiblioAlert").find('input').remove();
         		$("#confirmDeleteRefAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
            		$("#confirmDeleteTextAlert").hide();
            	});
	
            	$("#cancelDeleteSpace").click(function() {
					$("#confirmDeleteSpaceAlert").find('input').remove();
					$("#confirmDeleteTextAlert").find('input').remove();
					$("#confirmDeleteImageAlert").find('input').remove();
					$("#confirmDeleteChoiceBlockAlert").find('input').remove();
					$("#confirmDeleteSpaceAlert").hide();
            	});
	            
            	$("#cancelDeleteImage").click(function() {
            		$("#confirmDeleteImageAlert").hide();
            	});
            	
            	$("#cancelDeleteVideo").click(function() {
            		$("#confirmDeleteVideoAlert").find('input').remove();
            		$("#confirmDeleteVideoAlert").hide();	
            	});
            	
         	$("#cancelSubmitBiblio").click(function() {
         		$("#addBiblioAlert").hide();	
         	});
         	
         	$("#cancelSubmitReference").click(function() {
         		$("#addReferenceAlert").hide();	
         	});
         	
         	$("#cancelDeleteBiblio").click(function() {
         		$("#confirmDeleteTextAlert").find('input').remove();
         		$("#confirmDeleteBiblioAlert").find('input').remove();
         		$("#confirmDeleteRefAlert").find('input').remove();
         		$("#confirmDeleteImageAlert").find('input').remove();
         		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
         		$("#confirmDeleteBiblioAlert").hide();
         	});
         	
         	$("#cancelDeleteReference").click(function() {
         		$("#confirmDeleteTextAlert").find('input').remove();
         		$("#confirmDeleteBiblioAlert").find('input').remove();
         		$("#confirmDeleteRefAlert").find('input').remove();
         		$("#confirmDeleteImageAlert").find('input').remove();
         		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
         		$("#confirmDeleteRefAlert").hide();
         	});
         	
            	$("#cancelDeleteChoiceBlock").click(function() {
            	    $("#confirmDeleteChoiceBlockAlert").find('input').remove();
            	    $("#confirmDeleteTextAlert").find('input').remove();
         	    $("#confirmDeleteBiblioAlert").find('input').remove();
         	    $("#confirmDeleteRefAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").hide();
            	});
            	
            	$("#cancelDelete").click(function() {
            		$("#confirmDeleteTextAlert").find('input').remove();
         		$("#confirmDeleteBiblioAlert").find('input').remove();
         		$("#confirmDeleteRefAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").hide();	
            	});
            	
         		// ---------- Delete Bibliography Block -------------
         		
         		$("#deleteBiblio").on("click", function(e) {
         		e.preventDefault();
         		$("#confirmDeleteTextAlert").find('input').remove();
         		$("#confirmDeleteImageAlert").find('input').remove();
         		$("#confirmDeleteRefAlert").find('input').remove();
         		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
         		$("#confirmDeleteBiblioAlert").hide();
         		var blockId = $('#deleteBiblioId').attr('value');
         		$('#deleteBiblioId').remove();
         		var token =  $('input[name="_csrf"]').attr('value');
         		
         		// ------------- delete Bibliography content blocks ------------
         		$.ajax({
         		    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/bibliography/'})]"+blockId,
         		    type: 'DELETE',
         		    headers: {
                         'X-CSRF-Token': token 
                    	},
         		    success: function(result) {
         		        $('#' + blockId).remove();
         		    },
         			error: function(data) {
         				var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
         				$('.error').append(alert); 
         				$(".error").delay(4000).slideUp(500, function(){
         				    $(".error").empty();
         				});
         			}
         		});
         	});
         		
         	// ---------- Delete Reference -------------
         		$("#deleteReference").on("click", function(e) {
         		    e.preventDefault();
         		    
         		    // Clear all inputs from other modal dialogs
         		    $("#confirmDeleteTextAlert").find('input').remove();
         		    $("#confirmDeleteImageAlert").find('input').remove();
         		    $("#confirmDeleteBiblioAlert").find('input').remove();
         		    $("#confirmDeleteChoiceBlockAlert").find('input').remove();
         		    $("#confirmDeleteRefAlert").hide();
         		    
         		    // Get values using the new data attributes and ids
         		    var refId = $('#deleteReferenceId').val();
         		    var biblioBlockId = $('#referenceBlockBiblioId').val();
         		    
         		    // Clean up the inputs
         		    $('#deleteReferenceId').remove();
         		    $('#referenceBlockBiblioId').remove();
         		    
         		    var token = $('input[name="_csrf"]').attr('value');
         		    
         		    // ------------- delete Reference ------------
         		    $.ajax({
         		        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/bibliography/'})]" + biblioBlockId + ['/reference/delete/'] + refId,
         		        type: 'DELETE',
         		        headers: {
         		            'X-CSRF-Token': token 
         		        },
         		        success: function(result) {
         		            $('#' + refId).remove();
         		        },
         		        error: function(data) {
         		            var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
         		            $('.error').append(alert); 
         		            $(".error").delay(4000).slideUp(500, function(){
         		                $(".error").empty();
         		            });
         		        }
         		    });
         		});
         	
         	// ---------- Delete Text Block -------------
         		$("#deleteText").on("click", function(e) {
         		    e.preventDefault();
         		    // Clean up other modals
         		    $("#confirmDeleteBiblioAlert").find('input').remove();
         		    $("#confirmDeleteRefAlert").find('input').remove();
         		    $("#confirmDeleteVideoAlert").find('input').remove();
         		    $("#confirmDeleteImageAlert").find('input').remove();
         		    $("#confirmDeleteChoiceBlockAlert").find('input').remove();
         		    $("#confirmDeleteTextAlert").hide();
         		    
         		    var blockId = $('#deleteTextId').val();
         		    $('#deleteTextId').remove();
         		    
         		    // ------------- delete text content blocks ------------
         		    $.ajax({
         		        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/text/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
         		        type: 'DELETE',
         		        success: function(result) {
         		            $('#' + blockId).remove();
         		        },
         		        error: function(data) {
         		            var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
         		            $('.error').append(alert); 
         		            $(".error").delay(4000).slideUp(500, function(){
         		                $(".error").empty();
         		            });
         		        }
         		    });
         		});

         	// ---------- Delete Space Block ------------- //
         		$("#deleteSpace").on("click", function(e) {
         		    e.preventDefault();
         		    var token = $('input[name="_csrf"]').attr('value');
         		    // Clean up other modals
         		    $("#confirmDeleteImageAlert").find('input').remove();
         		    $("#confirmDeleteChoiceBlockAlert").find('input').remove();
         		    $("#confirmDeleteTextAlert").find('input').remove();
         		    $("#confirmDeleteSpaceAlert").hide();
         		    
         		    var blockId = $('#deleteSpaceId').val();
         		    $('#deleteSpaceId').remove();

         		    // ------------- Delete space content blocks ------------ //
         		    $.ajax({
         		        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/space/'})]"+blockId,
         		        type: 'DELETE',
         		        headers:{
         		            'X-CSRF-Token':token
         		        },
         		        success: function(result) {
         		            $('#' + blockId).remove();
         		        },
         		        error: function(data) {
         		            var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
         		            $('.error').append(alert);
         		            $(".error").delay(4000).slideUp(500, function(){
         		                $(".error").empty();
         		            });
         		        }
         		    });
         		});

         	// ---------- Delete Image Block -----------
         		$("#deleteImage").on("click", function(e) {
         		    e.preventDefault();
         		    // Clean up other modals
         		    $("#confirmDeleteTextAlert").find('input').remove();
         		    $("#confirmDeleteBiblioAlert").find('input').remove();
         		    $("#confirmDeleteRefAlert").find('input').remove();
         		    $("#confirmDeleteChoiceBlockAlert").find('input').remove();
         		    $("#confirmDeleteSpaceAlert").find('input').remove();
         		    $("#confirmDeleteImageAlert").hide();
         		    
         		    var blockId = $('#deleteImageId').val();
         		    if(blockId == null || blockId == ''){
         		        var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
         		        $('.error').append(alert); 
         		        $(".error").delay(4000).slideUp(500, function(){
         		            $(".error").empty();
         		        });
         		    } else{
         		        $('#deleteImageId').remove();
         		        // ------------- delete image content blocks ------------
         		        $.ajax({
         		            url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/image/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
         		            type: 'DELETE',
         		            success: function(result) {
         		                $('#' + blockId).remove();
         		            },
         		            error: function(data) {
         		                var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
         		                $('.error').append(alert); 
         		                $(".error").delay(4000).slideUp(500, function(){
         		                    $(".error").empty();
         		                });
         		            }
         		        });
         		    }
         		});
         	
         	// ---------- Delete Choice Block -----------
         		$("#deleteChoiceBlock").on("click", function(e) {
         		    e.preventDefault();
         		    // Clean up other modals
         		    $("#confirmDeleteTextAlert").find('input').remove();
         		    $("#confirmDeleteBiblioAlert").find('input').remove();
         		    $("#confirmDeleteRefAlert").find('input').remove();
         		    $("#confirmDeleteImageAlert").find('input').remove();
         		    $("#confirmDeleteVideoAlert").find('input').remove();
         		    $("#confirmDeleteChoiceBlockAlert").hide();
         		    
         		    var blockId = $('#deleteChoiceBlockId').val();
         		    if(blockId == null || blockId == ''){
         		        var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
         		        $('.error').append(alert); 
         		        $(".error").delay(4000).slideUp(500, function(){
         		            $(".error").empty();
         		        });
         		    } else{
         		        $('#deleteChoiceBlockId').remove();
         		        // ------------- delete choices content blocks ------------
         		        $.ajax({
         		            url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/choiceBlock/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
         		            type: 'DELETE',
         		            success: function(result) {
         		                $('#' + blockId).remove();
         		            },
         		            error: function(data) {
         		                var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
         		                $('.error').append(alert); 
         		                $(".error").delay(4000).slideUp(500, function(){
         		                    $(".error").empty();
         		                });
         		            }
         		        });
         		    }
         		});
            	
         	// ---------- Delete Video Block -----------
			$("#deleteVideo").on("click", function(e) {
			    e.preventDefault();
			    // Clean up other modals
			    $("#confirmDeleteTextAlert").find('input').remove();
			    $("#confirmDeleteChoiceBlockAlert").find('input').remove();
			    $("#confirmDeleteVideoAlert").hide();
			    
			    var blockId = $('#videoIdToDelete').val();
			    $('#videoIdToDelete').val("");
			    
			    if(blockId == null || blockId == ''){
			        var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
			        $('.error').append(alert); 
			        $(".error").delay(4000).slideUp(500, function(){
			            $(".error").empty();
			        });
			    } else{
			        // ------------- delete video content blocks ------------
			        $.ajax({
			            url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/video/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
			            type: 'DELETE',
			            success: function(result) {
			                $('#' + blockId).remove();
			            },
			            error: function(data) {
			                var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
			                $('.error').append(alert); 
			                $(".error").delay(4000).slideUp(500, function(){
			                    $(".error").empty();
			                });
			            }
			        });
			    }
			});
            	
           	$("#deleteChoiceBlock").on("click", function(e) {
           	    e.preventDefault();
           	    $("#confirmDeleteTextAlert").find('input').remove();
           	    $("#confirmDeleteImageAlert").find('input').remove();
           	    $("#confirmDeleteSpaceAlert").find('input').remove();
           	    $("#confirmDeleteChoiceBlockAlert").hide();
           		var blockId = $('#deleteChoiceBlockId').attr('value');
           		if(blockId == null || blockId == ''){
           			var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
           			$('.error').append(alert); 
           			$(".error").delay(4000).slideUp(500, function(){
           			    $(".error").empty();
           			});
           		} else{
           			$('#deleteChoiceBlockId').remove()
           			// ------------- delete choices content blocks ------------
           			$.ajax({
           			    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/choiceBlock/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
           			    type: 'DELETE',
           			    success: function(result) {
           			    	$('#' + blockId).remove();
           			    },
           				error: function(data) {
           					var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
           					$('.error').append(alert); 
           					$(".error").delay(4000).slideUp(500, function(){
           					    $(".error").empty();
           					});
           				}
           			});
           		}
           	});
            	
         	$("#cancelSubmitChoice").click(function() {
                 $("#addChoiceAlert").hide();	
             });
            	
            $("#cancelImageBtn").click(function() {
                $('#chooseFromLocal').trigger( "click" );
                // Initialize selected image ID to blank, on clicking cancel button
                $("#uploadImage").data('value', '');
                $("#addImgAlert").hide();
                $(".open").removeClass("open");
            });
                
            $("#submitBiblio").on("click", function(e) {
                e.preventDefault();
                // ------------- creating Bibliography content blocks ------------
                
                var formData = new FormData();
                var biblioTitle = $("#titleBiblio").val();
                var description = $("#descriptionBiblio").val();
                
                formData.append('biblioTitle', biblioTitle);
                formData.append('description', description);    
                $("#titleBiblio").val('');
                $("#descriptionBiblio").val('');
                $("#addBiblioAlert").hide();
                
                var object = {};
                
                formData.forEach((value, key) => {
                    if (key !== 'contentOrder') {
                        object[key] = value;
                    }
                });
                
                var jsonData = JSON.stringify(object);
                
                var token = $('input[name="_csrf"]').attr('value');
                $.ajax({
                    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/bibliography'})]",
                    type: 'POST',
                    cache: false,
                    contentType: 'application/json',
                    processData: false,
                    headers: {
                        'X-CSRF-Token': token 
                    },
                    data: jsonData,
                    success: function(data) {
                        console.log(data);
                        
                        // Updated biblioblock creation with data attributes
                        var biblioblock = $(
                            '<div id="' + data.id + '" class="biblioDivStaff tab row" data-biblio-block>' +
                            '<p class="col-md-10">' +
                            'Bibliography Title: <span>' + data.biblioTitle + '</span>,' +
                            'Description: <span>' + data.description + '</span>' +
                            '</p>' +
                            '<input type="hidden" data-biblio-id="' + data.id + '" value="' + data.id + '" />' +
                            '<a class="btn col-md-1" data-action="delete-biblio" href="javascript:;" style="position: absolute; right: 0px;">' +
                            '<span class="icon-trash error"></span>' +
                            '</a>' +
                            '<a class="btn primary-btn btn-sm" data-action="add-reference" style="padding-top: 8px;">+ New Reference</a>' +
                            '<div id="referenceSpace" class="col-md-10">' +
                            '</div>' +
                            '</div>'
                        );
                        
                        $(biblioblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(biblioBlockDoubleClick);
                        $('#slideSpace').append(biblioblock); 
                    },
                    error: function(data) {
                        if (data.status == 403){
                            $("#loginAlert").show();
                        }
                        else {
                            var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                            $('.error').append(alert);
                        }
                    }
                });
            });

             
            $("#submitReference").on("click", function(e) {
                e.preventDefault();
                // ------------- creating reference ------------
                
                var formData = new FormData();
                var title = $("#titleRef").val();
                var author = $("#authorRef").val();
                var year = $("#yearRef").val();
                var journal = $("#journalRef").val();
                var url = $("#urlRef").val();
                var volume = $("#volumeRef").val();
                var issue = $("#issueRef").val();
                var pages = $("#pagesRef").val();
                var editors = $("#editorsRef").val();
                var type = $("#typeRef").val();
                var note = $("#noteRef").val();
                
                formData.append('title', title);
                formData.append('author', author);
                formData.append('year', year);
                formData.append('journal', journal);
                formData.append('url', url);
                formData.append('volume', volume);
                formData.append('issue', issue);
                formData.append('pages', pages);
                formData.append('editors', editors);
                formData.append('type', type);
                formData.append('note', note);
                
                // Change this to use addReferenceTarget or a similar ID
                var biblioBlockId = $('#addReferenceTarget').attr('value');

                // Clear the input fields
                $("#titleRef").val('');
                $("#authorRef").val('');
                $("#yearRef").val('');
                $("#journalRef").val('');
                $("#urlRef").val('');
                $("#volumeRef").val('');
                $("#issueRef").val('');
                $("#pagesRef").val('');
                $("#editorsRef").val('');
                $("#typeRef").val('');
                $("#noteRef").val('');
                $("#addReferenceAlert").hide();
                
                var object = {};
                formData.forEach((value, key) => object[key] = value);
                var jsonData = JSON.stringify(object);
                var token = $('input[name="_csrf"]').attr('value');
                
                $.ajax({
                    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/bibliography/'})]" + biblioBlockId + ['/reference/add'],
                    type: 'POST',
                    cache: false,
                    contentType: 'application/json; charset=utf-8',
                    processData: false,
                    headers: {
                        'X-CSRF-Token': token 
                    },
                    data: jsonData,
                    success: function(data) {
                        // Updated with data attributes
                        var referenceblock = $(
                            '<div id="'+ data.id +'" class="referenceDivStaff tab row" data-reference-block data-biblio-id="' + biblioBlockId + '">' +
                            '<p class="col-md-10">Reference Title: <span>' + data.title + '</span>, Author: <span>' + data.author + '</span>, Year:' +
                            '<span>' + data.year + '</span>, Journal: <span>' + data.journal + '</span>, ' +
                            'Url: <span>' + data.url + '</span>, Volume: <span>' + data.volume + '</span>, ' +
                            'Issue: <span>' + data.issue + '</span>, Pages: <span>' + data.pages + '</span>, ' +
                            'Editors: <span>' + data.editors + '</span>, Type: <span>' + data.type + '</span>, ' +
                            'Note: <span>' + data.note + '</span>' +
                            '</p>' +
                            '<input type="hidden" data-reference-id="' + data.id + '" value="' + data.id + '" />' +
                            '<a class="btn col-md-1" data-action="delete-reference" href="javascript:;" style="position: absolute; right:0px;">' +
                            '<i style="color: var(--error);" class="fas fa-trash-alt"></i></a>' +
                            '</div>'
                        );

                        $(referenceblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(referenceBlockDoubleClick);
                        var elem = $('#' + biblioBlockId).find('#referenceSpace');
                        elem.append(referenceblock);
                        
                        // Remove the reference target ID input
                        $('#addReferenceTarget').remove();
                    },
                    error: function(data) {
                        if (data.status == 403){
                            $("#loginAlert").show();
                        }
                        else {
                            var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                            $('.error').append(alert);
                        }
                    }
                });
            });
                $("#cancelVideoBtn").click(function() {
                    // Initialize selected video ID to blank, on clicking cancel button
                    $("#videoTitle").val('');
                    $("#saveVideo").data('value', '');
                    $("#saveVideo").data('url', '');
                    $("#saveVideo").prop('disabled', true);
                    $("#videoFile").val('');
                    $("#videoLink").val('');
                    $("#addVideoAlert").hide();
                    $(".open").removeClass("open");
                    $("#uploadTab").addClass("active");
                    $("#urlTab").removeClass("active");
                    $("#urlLink").removeClass("active show");
                    $("#urlLink>a").removeClass("active show");
                    $("#uploadLink").addClass("active show");
                    $("#uploadLink>a").addClass("active show");
                    $("#saveVideo").html("Update Video"); 
                    $('#videoIdToDelete').val("");
                });
                
                $("#file").click(function() {
                    $("#selectedImage").empty();
                    $('#imageId').prop('selectedIndex',0).trigger( "change" );
                });
                
                $("#submitText").on("click", function(e) {
                    $("#addTextAlert").hide();
                    e.preventDefault();
                    // ------------- creating text content blocks ------------
                    
                    var formData = new FormData();
                    var token = [[${_csrf.token}]];
                    var text = markDown.value();
                    formData.append('content', text);
                    markDown.value('');
                    $.ajax({
                        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/textcontent'})]",
                        type: 'POST',
                        cache       : false,
                        contentType : false,
                        processData : false,
                        data: formData,
                        headers:{
	            			'X-CSRF-Token':token
	            		},
                        enctype: 'multipart/form-data',
                        success: function(data) {
            
                        	// Example update for text block creation
                        	var textblock = $('<div style="word-break:break-word;" id="'+ data +'" class="textDivStaff tab row">' + 
                        	                  '<label>Text Description: </label><p class="col-md-10">'+text+'</p>' +
                        	                  '<input type="hidden" data-text-id="'+data+'" value="'+data+'" />' + 
                        	                  '<a class="btn col-md-1" data-action="delete-text" href="javascript:;">' + 
                        	                  '<span class="icon-trash error"></span></a></div>');
                        	$(textblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(textBlockDoubleClick);
                            $('#slideSpace').append(textblock);             
                        },
                        error: function(data) {
                        	if (data.status == 403){
                        		$("#loginAlert").show();
                        	}
                        	else {
                            	var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                            	$('.error').append(alert);
                        	}
                        }
                    });
                });
                
                $("#submitSpace").on("click", function(e) {
                    $("#addSpaceAlert").hide();
                    e.preventDefault();
                    // ------------- creating space content blocks ------------

                    var formData = new FormData();
                    var title = document.getElementById('spaceTitle').value;
                    var selectedSpace = document.getElementById('spaceName');
                    var spaceName = $('#spaceName').select2('data')[0].name;
                    var token = [[${_csrf.token}]];
                    
                    if (selectedSpace.selectedIndex != -1 && selectedSpace.value != "") {
                        var spaceId = selectedSpace.options[selectedSpace.selectedIndex].value;
                        formData.append('title', title);
                        formData.append('spaceId', spaceId);
                        
                        $.ajax({
                            url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/space'})]",
                            type: 'POST',
                            cache: false,
                            contentType: false,
                            processData: false,
                            data: formData,
                            headers: {
                                'X-CSRF-Token': token
                            },
                            enctype: 'multipart/form-data',
                            success: function(data) {
                                // Updated space creation with data attributes
                                var space = $(
                                    '<div style="word-break:break-word;" id="' + data + '" class="SpaceDivStaff tab row" data-space-block>' + 
                                    '<div style="display: flex; flex-direction: column; width: 100%;">' +
                                    '<div style = "display:flex; flex-direction: row; width: 100%;"><label>Title: </label><p class="col-md-10">' + title + '</p></div>' + 
                                    '<div style = "display:flex; flex-direction: row;width: 100%;"><label>Space: </label><p class="col-md-10">' + spaceName + '</p></div>' +
                                    '</div>' +
                                    '<input type="hidden" data-space-id="' + data + '" value="' + data + '" />' + 
                                    '<a class="btn col-md-1" data-action="delete-space" href="javascript:;" style="position: absolute; right: 0px;"><span class="icon-trash error"></span></a>' +
                                    '</div>'
                                );

                                $(space[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(spaceBlockDoubleClick);
                                $('#slideSpace').append(space);
                                $('#spaceTitle').val("");
                                removeAllSelectOptions("spaceName");
                            },
                            error: function(data) {
                                if (data.status == 403) {
                                    $("#loginAlert").show();
                                } else {
                                    var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                                    $('.error').append(alert);
                                }
                            }
                        });
                    }
                });

                $('input:checkbox').click(function() {
                    if ($(this).is(':checked')) {
                    	$('#submitChoices').prop("disabled", false);
                    } else {
                    if ($('.choiceOptions').filter(':checked').length < 1){
                    	$('#submitChoices').attr('disabled',true);}
                    }
                });
                
                $("#submitChoices").on("click", function(e) {
                    e.preventDefault();
                    $("#addChoiceAlert").hide();
                    var selectedChoice = [];
                    var showsAll = false;
                    var token = [[${_csrf.token}]];
                    $('#selectChoices :checked').each(function() {
                    	selectedChoice.push($(this).attr("id"));
                      });
                    // ------------- creating choice content blocks ------------
                    if ($('#showAllChoices').is(':checked')) {
                        showsAll = true;
                    }
                    var formData = new FormData();
                    formData.append('selectedChoices', selectedChoice);
                    ++contentCount;
                    formData.append('contentOrder', contentCount);
                    formData.append('showsAll', showsAll);
                    $.ajax({
                        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/choice/content'})]",
                        type: 'POST',
                        cache       : false,
                        contentType : false,
                        processData : false,
                        data: formData,
                        headers:{
	            			'X-CSRF-Token':token
	            		},
                        enctype: 'multipart/form-data',
                        success: function(data) {
                            var choiceblock = $('<div id="'+ data['choiceBlock'].id +'" class="choiceDiv tab row" style="display:block;">');
                            if (data['choiceBlock'].showsAll == false){
                                $.each(data['selectedSequences'], function(index, sequence) {
                                    choiceblock.append('<a style="color:var(--primary);  display:block;" href="/vspace/staff/module/[(${module.id})]/sequence/'+sequence.id+'">'+sequence.name+'</a>');
                        	});
                            }else{
                            	$(function() {
                                    var links = $("#choiceSpaceData a").map(function(e) {
                                        text = '<a style="color:var(--primary); display:block;" href='+this.href+'>'+this.name+'</a>';
                                        return text;
                                    }).get();
                                    $(links).each(function(index, choice) {
                                        choiceblock.append(choice);
                                    });
                               });
                            }
                            choiceblock.append('<input type="hidden" id="deleteChoiceBlockId" value="'+ data['choiceBlock'].id +'"><a class="btn deleteChoiceBlock col-md-1" href="javascript:;" style="position: absolute; right: 0; top: 0"><i style="color: var(--error);" class="fas fa-trash-alt"></i></a></div>')
                        	$(choiceblock).css({
                                'display': "block"
                            });
                            $('#slideSpace').append(choiceblock);
                        },
                        error: function(data) {
                            var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                            $('.error').append(alert);
                        }
                    });
                    $('#choiceForm')[0].reset();
                });
            
                $("#urlLink").on("click", function (e) {
 				    if ($("#videoFile").val()) {
 						$("#videoTitle").prop('disabled', true);
 						$("#videoLink").prop('disabled', true);
 						$("#saveVideo").prop('disabled', true);
 					}
 					if (!$("#videoFile").val()) {
 						$("#videoTitle").prop('disabled', false);
 						$("#videoLink").prop('disabled', false);
 						$("#saveVideo").prop('disabled', false);
 					}
 					if (!$("#videoTitle").val() && !$("#videoLink").val()) {
 						$("#saveVideo").prop('disabled', true);
 					}
 					if (!$("#videoTitle").val() && $("#videoLink").val()) {
 						$("#saveVideo").prop('disabled', true);
 					}
 					$("#urlLink").addClass("active show");
 					$("#uploadLink").removeClass("active show");
                    if(addVideoClk==1 && editVideoClk==0){
                        $("#saveVideo").html("Embed Video"); 
                        if (!$("#videoTitle").val() || !$("#videoLink").val()) {
     						$("#saveVideo").prop('disabled', true);
     					}
                    }
                    if(addVideoClk==0 && editVideoClk==1){
                        $("#saveVideo").html("Update Video");  
                        if ($("#videoTitle").val() && !$("#videoLink").val()) {
     						$("#saveVideo").prop('disabled', false);
     					}
                        if (!$("#videoTitle").val() && $("#videoLink").val()) {
     						$("#saveVideo").prop('disabled', true);
     					}
                    }
                    
 				});

 				$("#uploadLink").on("click", function (e) {
 				    if ($("#videoLink").val()) {
 						$("#videoTitle").prop('disabled', true);
 						$("#videoFile").prop('disabled', true);
 						$("#saveVideo").prop('disabled', true);
 					}else {
 						$("#videoTitle").prop('disabled', false);
 						$("#videoFile").prop('disabled', false);
 						$("#saveVideo").prop('disabled', false);
 					}
 					
 					if (!$("#videoTitle").val() && !$("#videoFile").val()) {
 						$("#saveVideo").prop('disabled', true);
 					}
 					$("#urlLink").removeClass("active show");
 					$("#uploadLink").addClass("active show");
 				   if(addVideoClk==1 && editVideoClk==0){
                       $("#saveVideo").html("Upload Video");   
                       if (!$("#videoTitle").val() || !$("#videoFile").val()) {
    						$("#saveVideo").prop('disabled', true);
    					}
                   }
                   if(addVideoClk==0 && editVideoClk==1){
                       $("#saveVideo").html("Update Video");  
                       if ($("#videoTitle").val() && !$("#videoFile").val()) {
    						$("#saveVideo").prop('disabled', false);
    					}
                       if (!$("#videoTitle").val() && $("#videoFile").val()) {
    						$("#saveVideo").prop('disabled', true);
    					}
                   }
 				});
 				
 				$("#videoLink").on("input", function (e) {
 				    if (!$("#videoLink").val()) {
 						$("#saveVideo").prop('disabled', true);
 					}else {
 						$("#saveVideo").prop('disabled', false);
 					}
 				});
 				
 				$("#videoFile").on("input", function (e) {
 				    if (!$("#videoFile").val()) {
 						$("#saveVideo").prop('disabled', true);
 					}else {
 						$("#saveVideo").prop('disabled', false);
 					}
 				});
 				
 				$("#videoTitle").on("input", function (e) {
 				    if ($("#videoFile").val() || $("#videoLink").val()) {
 						$("#saveVideo").prop('disabled', false);
 					}
 				}); 
                
 				function updateTextBox(blockId, text) {
 				    // clear text box and buttons
 				    $(".open").empty();
 				    
 				    // Updated to include data-text-id and data-action attributes
 				    $(".open").append(
 				        '<label>Text Description: </label>' +
 				        '<p class="col-md-10">' + text + '</p>' +
 				        '<input type="hidden" data-text-id="' + blockId + '" value="' + blockId + '" />' +
 				        '<a class="btn col-md-1" data-action="delete-text" href="javascript:;" style="position: absolute; right:0;">' +
 				        '<span class="icon-trash error"></span></a>'
 				    );
 				    
 				    // reset border of the card
 				    //rebind event handlers
 				    $('.textDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(textBlockDoubleClick);
 				    
 				    //resetting the height and overflow-y so that the TextBlock doesn't expand
 				    $('.textDivStaff').css('height', 'auto');
 				    $('.textDivStaff').css('overflow-y', 'visible');
 				    $(".open").css('display', 'flex');
 				    
 				    // remove id from storage so its not there on refresh
 				    $(".open").removeClass("open");
 				}
                
                // must add the event to the document since the buttons are added dynamically
                $('#cancelTextBlock').on('click',function(){
                	$("#editTextAlert").hide();
                	var blockId = $(this).closest(".open").attr("id");
                	updateTextBox(blockId, defaultValue);
                });
            
             function updateBiblioBox(blockId, formData) {
                 // clear biblio box and buttons
                 $(".open").empty();
                	$(".open").append('<p class="col-md-10"> \
                		    Bibliography Title: <span>' + formData.get('biblioTitle')+ '</span>, \
                		    Description: <span>' + formData.get('description') + '</span> \
                		</p> \
                		<input type="hidden" id="deleteBiblioId" value="' + blockId + '" /> \
                			<a class="btn deleteBiblio" href="javascript:;" style="position: absolute; right: 0px;">\
                         <i style="color: var(--error);" class="fas fa-trash-alt"></i>\
                     </a> \
                     <a id="addReference" class="btn primary-btn btn-sm" style="padding-top: 8px;">\
                         + New Reference \
                     </a> \
         ');
         
                	//reset border of the card
                 //rebind event handlers
                 $('.biblioDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(biblioBlockDoubleClick);
                 $(".open").css('display', 'flex');
                 // remove id from storage so its not there on refresh
                 $(".open").removeClass("open");
             }
             
          	// must add the event to the document since the buttons are added dynamically
             $('#cancelBiblioBlock').on('click',function(){
             	$('#currentBiblioId').remove();
             	$("#editBiblioAlert").hide();
             	var blockId = $(".open").attr("id");
             	updateBiblioBox(blockId, formDataCancel);
             });
          	
             function updateReferenceBox(blockId, formData) {
            	    // Clear biblio box and buttons
            	    $(".open").empty();
            	    
            	    // Updated to use data attributes
            	    $(".open").append(
            	        '<p class="col-md-10">Reference Title: <span>' + formData.get('title') + 
            	        '</span>, Author: <span>' + formData.get('author') + 
            	        '</span>, Year: <span>' + formData.get('year') + 
            	        '</span>, Journal: <span>' + formData.get('journal') + 
            	        '</span>, Url: <span>' + formData.get('url') + 
            	        '</span>, Volume: <span>' + formData.get('volume') + 
            	        '</span>, Issue: <span>' + formData.get('issue') + 
            	        '</span>, Pages: <span>' + formData.get('pages') + 
            	        '</span>, Editors: <span>' + formData.get('editors') + 
            	        '</span>, Type: <span>' + formData.get('type') + 
            	        '</span>, Note: <span>' + formData.get('note') + 
            	        '</span></p>' + 
            	        '<input type="hidden" data-reference-id="' + blockId + '" value="' + blockId + '" />' + 
            	        '<a class="btn col-md-1" data-action="delete-reference" href="javascript:;">' + 
            	        '<span class="icon-trash error"></span></a>'
            	    );
            	    
            	    // Reset border of the card
            	    // Rebind event handlers
            	    $('.referenceDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(referenceBlockDoubleClick);
            	    $(".open").css('display', 'flex');
            	    
            	    // Remove id from storage so it's not there on refresh
            	    $(".open").removeClass("open");
            	}
          	
         	// must add the event to the document since the buttons are added dynamically
			$('#cancelRefBlock').on('click', function() {
			    $('#editRefBiblioId').remove();
			    $("#editReferenceAlert").hide();
			    var refId = $(".open").attr("id");
			    updateReferenceBox(refId, formDataCancel);
			    $(".open").removeClass("open");
			});
         
             $('.valueDiv').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick((e)=>{$(".EasyMDEContainer").remove();});
             $('.textDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(textBlockDoubleClick);
             $('.vidDiv').mouseenter(onMouseEnter).mouseleave(onMouseLeave);
             $('.SpaceDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(spaceBlockDoubleClick);
             $('.biblioDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(biblioBlockDoubleClick);
             $('.referenceDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(referenceBlockDoubleClick);
            
	            $('#closeTextBlock').on('click',function(){
		            $("#editTextAlert").hide();
		            var blockId = $(this).closest(".open").attr("id");
		            updateTextBox(blockId, defaultValue);
	            });

	            function updateSpaceBox(blockId, text, spaceName) {
	                // clear text box and buttons
	                $(".open").empty();
	                $(".open").append(
	                    '<div style="display: flex; flex-direction: column; width: 100%;">' +
	                    '<div style="display:flex; flex-direction: row; width: 100%;">' +
	                    '<label>Title: </label><p class="col-md-10">' + text + '</p>' +
	                    '</div>' +
	                    '<div style="display:flex; flex-direction: row;width: 100%;">' +
	                    '<label>Space: </label><p class="col-md-10"> ' + spaceName + '</p>' +
	                    '</div>' +
	                    '</div>' +
	                    '<input type="hidden" data-space-id="' + blockId + '" value="' + blockId + '" />' +
	                    '<a class="btn col-md-1" data-action="delete-space" href="javascript:;" style="position: absolute; right: 0px;">' +
	                    '<span class="icon-trash error"></span></a>'
	                );
	                
	                // reset border of the card
	                // rebind event handlers
	                $('.SpaceDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(spaceBlockDoubleClick);
	                
	                // resetting the height and overflow-y so that the TextBlock doesn't expand
	                $('.SpaceDivStaff').css('height', 'auto');
	                $('.SpaceDivStaff').css('overflow-y', 'visible');
	                $(".open").css('display', 'flex');
	                
	                // remove id from storage so its not there on refresh
	                $(".open").removeClass("open");
	            }

            	// must add the event to the document since the buttons are added dynamically
	            $('#cancelSpaceBlock').on('click',function(){
	            	removeAllSelectOptions("editSpaceName");
		            $("#editSpaceAlert").hide();
		            updateSpaceBox(currentBlockId, defaultValue, currentSpaceName);
		            $(".open").removeClass("open");
	            });

	            $('#closeSpaceBlock').on('click',function(){
		            $("#editSpaceAlert").hide();
		            updateSpaceBox(currentBlockId, defaultValue, currentSpaceName);
		            $(".open").removeClass("open");
	            });

                $("#submitTextBlock").on("click", function(e){
                    e.preventDefault();
                    // ------------- editting text content blocks ------------
                    
                    var formData = new FormData();
                    var text = markDown.value();
                    markDown.value('');
                    var formData = new FormData();
                    var blockId = $(".open").attr("id");
                    var token = [[${_csrf.token}]];
                    formData.append('textBlockDesc', text);
                    formData.append('textBlockId', blockId);
                	$("#editTextAlert").hide();
                    $.ajax({
                        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/text/edit'})]",
                        type: 'POST',
                        cache       : false,
                        contentType : false,
                        processData : false,
                        data: formData,
                        headers:{
	            			'X-CSRF-Token':token
	            		},
                        enctype: 'multipart/form-data',
                        success: function(data) {
                            // replace text box with new description
                           updateTextBox(blockId, text)
                           $(".open").removeClass("open");
                       },
                       error: function(data) {
                    		if (data.status == 403) {
                       			$("#loginAlert").show();
                       		}
                    		else {
                        		var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                        		$('.error').append(alert);
                    		}
                    }
                });
             });   
             
             $("#submitBiblioBlock").on("click", function(e){
             	  e.preventDefault();
                 // ------------- editting Bibliography content blocks ------------
                 
                 var formData = new FormData();
                 var title = $("#editTitleBiblio").val();
                 var desc = $("#editDescBiblio").val();
                 var blockId = $(".open").attr("id");
                 
                 formData.append('biblioTitle', title);
                 formData.append('description', desc);
                 formData.append('id', blockId);
                 $("#editBiblioAlert").hide();
                 
                 var object = {};
                 formData.forEach((value, key) => object[key] = value);
                 var jsonData = JSON.stringify(object);
                 var token =  $('input[name="_csrf"]').attr('value');
                 
                 $.ajax({
                     url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/bibliography/edit'})]",
                     type: 'POST',
                     cache       : false,
                     contentType : 'application/json; charset=utf-8',
                     processData : false,
                     headers: {
                         'X-CSRF-Token': token 
                    	},
                     data: jsonData,
                     success: function(data) {
                         //replace Biblio box with new values
                         updateBiblioBox(blockId, formData);
                         $(".open").removeClass("open");
                         location.reload();
                    },
                    error: function(data) {
         	       if (data.status == 403) {
         	           $("#loginAlert").show();
         	       }
         	       else {
         	           var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
         	           $('.error').append(alert);
         	       }
                    }
                });
             });
             
             $("#submitRefBlock").on("click", function(e) {
            	    e.preventDefault();
            	    // ------------- editing Ref blocks ------------
            	    
            	    var formData = new FormData();
            	    var title = $("#editTitleRef").val();
            	    var author = $("#editAuthorRef").val();
            	    var year = $("#editYearRef").val();
            	    var journal = $("#editJournalRef").val();
            	    var url = $("#editUrlRef").val();
            	    var volume = $("#editVolumeRef").val();
            	    var issue = $("#editIssueRef").val();
            	    var pages = $("#editPagesRef").val();
            	    var editors = $("#editEditorsRef").val();
            	    var type = $("#editTypeRef").val();
            	    var note = $("#editNoteRef").val();
            	    var blockId = $(".open").attr("id");
            	    
            	    formData.append('title', title);
            	    formData.append('author', author);
            	    formData.append('year', year);
            	    formData.append('journal', journal);
            	    formData.append('url', url);
            	    formData.append('volume', volume);
            	    formData.append('issue', issue);
            	    formData.append('pages', pages);
            	    formData.append('editors', editors);
            	    formData.append('type', type);
            	    formData.append('note', note);
            	    formData.append('id', currentRefId);
            	    
            	    $("#editReferenceAlert").hide();
            	    $("#editBiblioAlert").hide();
            	    
            	    // Change this to use a better ID
            	    var biblioBlockId = $('#editRefBiblioId').val() || $('#currentBiblioId').val();
            	    
            	    var object = {};
            	    formData.forEach((value, key) => object[key] = value);
            	    var jsonData = JSON.stringify(object);
            	    var token = $('input[name="_csrf"]').attr('value');
            	    
            	    $.ajax({
            	        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/bibliography/'})]" + biblioBlockId + ['/reference/edit'],
            	        type: 'POST',
            	        cache: false,
            	        contentType: 'application/json; charset=utf-8',
            	        processData: false,
            	        headers: {
            	            'X-CSRF-Token': token
            	        },
            	        data: jsonData,
            	        success: function(data) {
            	            // Replace Reference box with new values
            	            updateReferenceBox(blockId, formData);
            	            $(".open").removeClass("open");
            	            location.reload();
            	        },
            	        error: function(data) {
            	            if (data.status == 403) {
            	                $("#loginAlert").show();
            	            }
            	            else {
            	                var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            	                $('.error').append(alert);
            	            }
            	        }
            	    });
            	});    
                
	            $("#submitSpaceBlock").on("click", function(e){
		            e.preventDefault();
		            // ------------- editting text content blocks ------------
		            if(document.getElementById('editSpaceName') != ""){
			            var selectedSpace = document.getElementById('editSpaceName');
			            var spaceId = selectedSpace.options[selectedSpace.selectedIndex].value;
			            var spaceName = $('#editSpaceName').select2('data')[0].text;
			            var formData = new FormData();
			            var text = document.getElementById("editSpaceBlock").value;
			            var formData = new FormData();
			            var blockId = $(".open").attr("id");
			            formData.append('spaceBlockId', blockId);
			            formData.append('spaceBlockTitle', text);
			            if(spaceId == "" || spaceId == null){
			            	spaceId = currentSpaceId;
			            }
			            var token = [[${_csrf.token}]];
			            formData.append('spaceId', spaceId);
			            $("#editSpaceAlert").hide();
			            $.ajax({
				            url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/space/edit'})]",
				            type: 'POST',
				            cache       : false,
				            contentType : false,
				            processData : false,
				            headers: {
			                    'X-CSRF-TOKEN': token
			                },
				            data: formData,
				            enctype: 'multipart/form-data',
				            success: function(data) {
				            	updateSpaceBox(blockId, text, spaceName)
				            	$(".open").removeClass("open");
				            },
				            error: function(data) {
					            if (data.status == 403) {
					            	$("#loginAlert").show();
					            } else {
						            var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
						            $('.error').append(alert);
					            }
				            }
			            });
		          }
	            });
	            
                $("#imageId").select2({
            		ajax: {
            		    url: [[@{|/staff/images/search|}]],
            		    dataType: 'json',
            		    processResults: function (data) {
            		        return {
            		          results: data,
            		        };
            		      },
            		},
            		templateResult: formatImage,
            		templateSelection: formatSelection
                });
                
                function formatImage (image) {
                	if (!image.id) {
                		return image.text;
                	}
                	var tbaseUrl = [[@{|/api/image/|}]];
                	var $image = $(
                			'<span><img src="' + tbaseUrl + image.id + '" class="img-thumbnail" /> ' + image.text + '</span>'
                	);
                	return $image;
                };
                
                function formatSelection(image) {
                	if (!image.id) {
                        return image.text;
                    }
                	var tbaseUrl = [[@{|/api/image/|}]];
                    var $image = $(
                            '<span>' + image.text + '</span>'
                    );
                    $("#selectedImage").empty();
                    $("#selectedImage").append('<img width="200px" src="' + tbaseUrl + image.id + '" class="img-thumbnail" />');
                    return $image;
                }
            });
            
            $(window).on('load', function () {	
            	var divWindow = $(".valueDiv");
            	$('[data-action="delete-text"]').css('position', 'absolute');
            	$('[data-action="delete-text"]').css('right', '0');
             	$(".deleteBiblio").css('position', 'absolute');
             	$(".deleteBiblio").css('right', '0px');
            	var images = $(".imgDiv");
            	resizeImage(images);
            	
            	function resizeImage(images) {
            		for(var i =0; i < images.length; i++) {
            			if (images[i].width > divWindow.width() || images[i].width >= 800) {
            				$(".valueDiv").find("#"+images[i].id).css("width", 800);
            				images[i].width = 800;
            			} else {
            				$(".valueDiv").find("#"+images[i].id).css("width", images[i].width);
            			}
            		}
            	}
            });
            
			// editing video block
            $(document).on("click", ".editVideo", function(e) {
                addVideoClk =0;
                editVideoClk=1;
                $("#saveVideo").html("Update Video");
                $("#saveVideo").prop('disabled', false);
            	var id = $(this).attr('data-editvideo-id');
            	var vidId = $('div#'+id).attr('id');
            	var title = $('div#'+id).find('h3 strong').html();
            	if (vidId != '') {
                    var url="";
                    if($('div#'+id).find('iframe')!=null && typeof($('div#'+id).find('iframe')) != "undefined"
					&& $('div#'+id).find('iframe').attr('src')!=null && typeof($('div#'+id).find('iframe').attr('src')) != "undefined")
					{
            			url = $('div#'+id).find('iframe').attr('src');
					}
                	if (url.length > 0) {
            			$("#saveVideo").data('url', url);
            			$("#videoLink").val(url);
            			$("#urlTab").addClass("active");
            			$("#urlLink").addClass("active  show");
            			$("#uploadTab").removeClass("active show");
            			$("#uploadLink").removeClass("active show");
            			$("#urlLink>a").addClass("active show");
            			$("#uploadLink").removeClass("active show");
            			$("#uploadLink>a").removeClass("active show");
					} 
                    $("#videoTitle").val(title);
                    $("#saveVideo").data('value', vidId);
                    $("#addVideoAlert").show();
            	}
            });
        </script>
    </head>
    <body>
        <div class="main-content" layout:fragment="content">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a th:href="@{/staff/dashboard}">Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a th:href="@{/staff/module/list}">Modules</a>
                </li>
                <li class="breadcrumb-item">
                    <a th:href="@{'/staff/module/'+${module.id}}">[[${module.name}]]</a>
                </li>
                <li class="breadcrumb-item" th:each="slideSequence: ${slideSequences}">
                    <a th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${slideSequence.id}}" th:name="${slideSequence.name}">[[${slideSequence.name}]]</a>
                </li>
                <li class="breadcrumb-item active">[[${slide.name}]]</li>
            </ol>
            <div class="error"></div>
            <div class="dropdown" style="float: right;" th:if="${#strings.equals(slide['class'].simpleName,'BranchingPoint')}">
                <button class="btn branchbtn dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="icon-branch"></span> This Branching Point links to the following Sequences
                </button>
                <div id="choiceSpaceData" class="dropdown-menu" aria-labelledby="dropdownMenu2">
                    <a  th:each="choice: ${choices}" class="dropdown-item" 
                        th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${choice.sequence.id}}"
                        th:name="${choice.sequence.name}" style="color:var(--primary);">[[${choice.sequence.name}]]</a>
                </div>
            </div>
         <h2><span style="color: var(--dark-grey)">Slide:</span> [[${slide.name}]]
            <span class="icon-info-circle" data-toggle="tooltip" data-html="true" data-placement="top" 
               th:title="|Created on <span class='date'>${slide.creationDate}</span> by ${slide.createdBy}|"></span>&emsp;
            <a th:href="@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/edit'}">
            <span class="icon-edit"></span></a>
         </h2>
         <p id="description">[[${slide.description}]]</p>
            <div style="margin: 40px 0 20px; width: fit-content" class="content-btns">
                <button type="button" id="addText" class="btn pill-btn" data-toggle="tooltip" title="Add Text Block" data-placement="top">
                +&nbsp;<span class="icon-text"></span></button>&nbsp;
                <button type="button" id="addSpace" class="btn pill-btn" data-toggle="tooltip" title="Add Space Block">
                +&nbsp;<span class="icon-layers"></span></button>&nbsp;
                <button type="button" id="addImage" class="btn pill-btn" data-toggle="tooltip" title="Add Image" data-placement="top">
                +&nbsp;<span class="icon-image"></span></button>&nbsp;
            <button type="button" id="addBibliography" class="btn pill-btn" data-toggle="tooltip" title="Add Bibliography block" data-placement="top">
            +&nbsp;<span class="icon-book-open-alt"></span></button>&nbsp;
                <button type="button" id="addVideo" class="btn pill-btn" data-toggle="tooltip" title="Add Video" data-placement="top">
                +&nbsp;<span class="icon-video"></span></button>&nbsp;
                <button type="button" id="addChoice" style="display: none;" class="btn pill-btn" data-toggle="tooltip" title="Add Sequence Choice" data-placement="top">
                +&nbsp;<span class="icon-checkmark"></span></button>
            <p style="margin-top: 1rem;">Double Click on a Block to Edit it</p>
            </div>
            <!-- Delete Text Modal -->
            <div id="confirmDeleteTextAlert" class="modal" tabindex="-1"
                role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h6>Are you sure you want to delete this
                                text block?
                            </h6>
                        </div>
                        <div class="modal-footer">
                            <button id="cancelDeleteText" type="reset"
                                class="btn light">Cancel</button>
                            <button type="submit" id="deleteText"
                                class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
	         <!-- Delete Bibliography Modal -->
	         <div id="confirmDeleteBiblioAlert" class="modal" tabindex="-1"
	            role="dialog" th:draggable="true">
	            <div class="modal-dialog" role="document">
	               <div class="modal-content">
	                  <div class="modal-header">
	                     <h5 class="modal-title">Confirm Delete</h5>
	                     <button type="button" class="close" data-dismiss="modal"
	                        aria-label="Close">
	                     <span aria-hidden="true">&times;</span>
	                     </button>
	                  </div>
	                  <div class="modal-body">
	                     <h6>Are you sure you want to delete this bibliography block?</h6>
	                  </div>
	                  <div class="modal-footer">
	                     <button id="cancelDeleteBiblio" type="reset" class="btn light">Cancel</button>
	                     <button type="submit" id="deleteBiblio" class="btn btn-primary">Submit</button>
	                  </div>
	               </div>
	            </div>
	         </div>
	         <!-- Delete Reference Modal -->
	         <div id="confirmDeleteRefAlert" class="modal" tabindex="-1"
	            role="dialog" th:draggable="true">
	            <div class="modal-dialog" role="document">
	               <div class="modal-content">
	                  <div class="modal-header">
	                     <h5 class="modal-title">Confirm Delete</h5>
	                     <button type="button" class="close" data-dismiss="modal"
	                        aria-label="Close">
	                     <span aria-hidden="true">&times;</span>
	                     </button>
	                  </div>
	                  <div class="modal-body">
	                     <h6>Are you sure you want to delete this reference?</h6>
	                  </div>
	                  <div class="modal-footer">
	                     <button id="cancelDeleteReference" type="reset" class="btn light">Cancel</button>
	                     <button type="submit" id="deleteReference" class="btn btn-primary">Submit</button>
	                  </div>
	               </div>
	            </div>
	         </div>
            <!-- Delete Space Modal -->
            <div id="confirmDeleteSpaceAlert" class="modal" tabindex="-1" role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h6>Are you sure you want to delete this Space Block?</h6>
                        </div>
                        <div class="modal-footer">
                            <button id="cancelDeleteSpace" type="reset" class="btn light">Cancel</button>
                            <button type="submit" id="deleteSpace" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Delete Image Modal -->
            <div id="confirmDeleteImageAlert" class="modal" tabindex="-1"
                role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h6>Are you sure you want to delete this
                                image block?
                            </h6>
                        </div>
                        <div class="modal-footer">
                            <button id="cancelDelete" type="reset"
                                class="btn light">Cancel</button>
                            <button type="submit" id="deleteImage"
                                class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Delete Video Modal -->
            <div id="confirmDeleteVideoAlert" class="modal"
                tabindex="-1" role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h6>Are you sure you want to delete this video block?</h6>
                        </div>
                        <input type="hidden" id="videoIdToDelete" />
                        <div class="modal-footer">
                            <button id="cancelDeleteVideo" type="reset"
                                class="btn light">Cancel</button>
                            <button type="submit" id="deleteVideo"
                                class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Delete ChoiceBlock Modal -->
            <div id="confirmDeleteChoiceBlockAlert" class="modal"
                tabindex="-1" role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h6>Are you sure you want to delete this
                                choices Block?
                            </h6>
                        </div>
                        <div class="modal-footer">
                            <button id="cancelDeleteChoiceBlock"
                                type="reset" class="btn light">Cancel</button>
                            <button type="submit" id="deleteChoiceBlock"
                                class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="addTextAlert" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document" th:draggable="true">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add new Text Block</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="textForm" id="textUploadForm"
                            enctype="multipart/form-data" method="post">
                            <div class="modal-body">
                                <h6>
                                    <small>Enter Text: </small>
                                </h6>
                                <textarea class="form-control"
                                    id="textBlockText" rows="3"></textarea>
                            </div>
                            <div class="modal-footer">
                                <button id="cancelSubmitText" type="reset"
                                    class="btn light">Cancel</button>
                                <button type="submit" id="submitText"
                                    class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="addSpaceAlert" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document" th:draggable="true">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add link to space</h5>
                            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="spaceForm" id="spaceUploadForm" enctype="multipart/form-data" method="post" th:object="${spaceContentBlockForm}">
                            <div class="modal-body">
                                <h6>
                                    <small>Enter title : </small>
                                </h6>
                                <textarea class="form-control" id="spaceTitle" rows="3" style="border: 1px solid black;"></textarea>
                            </div>
                            <div class="modal-body">
                                <h6>
                                    <small>Choose a Space</small>
                                </h6>
                                <select id="spaceName" name="spacesNames" class="form-control-xs target" style="height: 50px; width: 200px;">
                                    <option selected value="">Choose a Space</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button id="cancelSpaceText" type="reset" class="btn light">Cancel</button>
                                <button type="submit" id="submitSpace" class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="editTextAlert" class="modal" tabindex="-1" 
                role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Text Block</h5>
                            <button class = "close" type="button" id="closeTextBlock" data-bs-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="textForm" id="textEditUploadForm"
                            enctype="multipart/form-data" method="post">
                            <div class="modal-body">
                                <h6>
                                    <small>Edit Text: </small>
                                </h6>
                                <textarea class="form-control"
                                    id="editTextBlock" rows="3"></textarea>
                            </div>
                            <div class="modal-footer">
                                <button id="cancelTextBlock" type="reset"
                                    class="btn light">Cancel</button>
                                <button type="submit" id="submitTextBlock"
                                    class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="editSpaceAlert" class="modal" tabindex="-1" role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Space Block</h5>
                            <button type="button" class="close" id="closeSpaceBlock" data-bs-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="spaceForm" id="SpaceEditUploadForm" enctype="multipart/form-data" method="post" style="padding:20px;">
                            <div class="modal-body">
                                <h6>
                                    <small>Edit Title: </small>
                                </h6>
                                <textarea class="form-control" id="editSpaceBlock" rows="3"></textarea>
                            </div>
                            <select id="editSpaceName" name="editSpacesNames" class="form-control-xs target" style="height: 50px; width: 200px;">
                                <option selected value=""></option>
                            </select>
                            <p>Current selected space is <span id="selectedSpace"></span></p>
                            <div class="modal-footer">
                                <button id="cancelSpaceBlock" type="reset" class="btn light">Cancel</button>
                                <button type="submit" id="submitSpaceBlock" class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="addImgAlert" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document" th:draggable="true">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add new Image Block</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="photoForm" id="imageUploadForm"
                            enctype="multipart/form-data" method="post">
                            <div class="modal-body">
                                <input type="radio" id="chooseFromLocal" name ="uploadRadioBtn" checked/>
                                <h6>
                                    <small>Upload Image: </small>
                                </h6>
                                <input class="form-control" type="file"
                                    name="file" rows="5" cols="500"
                                    id="file" />
                                <input type="radio" id="chooseFromExisting" name ="uploadRadioBtn" />       
                                <div>
                                    <h6>
                                        <small>Or choose an existing image: </small>
                                    </h6>
                                    <select id="imageId" name="imageId"
                                        class="form-control-xs target"
                                        style="height: 50px; width: 200px;">
                                        <option selected value="">Choose from existing</option>
                                    </select>
                                </div>
                                <div>
                                    <span id="selectedImage" width="200px"></span>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button id="cancelImageBtn" type="reset"
                                    class="btn light">Cancel</button>
                                <button type="submit" id="uploadImage"
                                    class="btn btn-primary" data-value="">Upload
                                Image</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="addVideoAlert" class="modal" tabindex="-1" role="dialog" aria-hidden="true">
				<div class="modal-dialog" role="document" draggable="true">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">Add New Video Block</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<form name="videoForm" id="videoUploadForm" enctype="multipart/form-data" method="post">
							<div class="modal-body" style="background: var(--base-grey)">
								<div role="tabpanel">
									<ul class="nav nav-tabs" role="tablist">
										<li role="presentation" id="uploadLink" class="active show"><a class="active show nav-link" href="#uploadTab"
												aria-controls="uploadTab" role="tab" data-toggle="tab">Upload</a></li>
										<li role="presentation" id="urlLink"><a class="nav-link" href="#urlTab" aria-controls="urlTab" role="tab"
												data-toggle="tab">Link</a></li>
									</ul>
									<!-- Tab panes -->
									<div class="tab-content">
									<br/>
										<label for="videoFile">Video Title:</label><input class="form-control" id="videoTitle" type="text" name="videoTitle"/>
										<div role="tabpanel" class="tab-pane active" id="uploadTab"><br />
											<label for="videoFile">Upload Video in any of these format ( MP4, MOV, WEBM, MKV )<br>Note that not all encodings are supported. For .mov files make sure the encoding is H.264</label><input  id="videoFile" class="form-control-file" type="file" name="videoFile"/>
										</div>
										<div role="tabpanel" class="tab-pane" id="urlTab"><br />
											<label for="videoLink">Enter URL: </label><input class="form-control" type="text" placeholder="Use Video Embed Link..." name="videoLink" rows="5" cols="500"
												id="videoLink" />
										</div>
									</div>
								</div>
							</div>
							<div class="modal-footer">
								<button id="cancelVideoBtn" type="reset" class="btn light">Cancel</button>
								<button type="submit" id="saveVideo" class="btn btn-primary" disabled>Upload
									Video</button>
							</div>
						</form>
					</div>
				</div>
			</div>
	         <div id="addBiblioAlert" class="modal" tabindex="-1" role="dialog" style="overflow-y: scroll;">
	            <div class="modal-dialog" role="document" th:draggable="true">
	               <div class="modal-content">
	                  <div class="modal-header">
	                     <h5 class="modal-title">Add new Bibliography Block</h5>
	                     <button type="button" class="close" data-dismiss="modal"
	                        aria-label="Close">
	                     <span aria-hidden="true">&times;</span>
	                     </button>
	                  </div>
	                  <form name="sendBiblioForm" id="sendBiblioForm">
	                     <div class="modal-body">
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Title: </label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="titleBiblio" name="titleBiblio" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Description: </label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="descriptionBiblio" name="descriptionBiblio" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                     </div>
	                     <div class="modal-footer">
	                        <button id="cancelSubmitBiblio" type="reset" class="btn light">Cancel</button>
	                        <button type="submit" id="submitBiblio" class="btn btn-primary">Submit</button>
	                     </div>
	                  </form>
	               </div>
	            </div>
	         </div>
	         <div id="addReferenceAlert" class="modal" tabindex="-1" role="dialog" style="overflow-y: scroll;">
	            <div class="modal-dialog" role="document" th:draggable="true">
	               <div class="modal-content">
	                  <div class="modal-header">
	                     <h5 class="modal-title">Add new Reference</h5>
	                     <button type="button" class="close" data-dismiss="modal"
	                        aria-label="Close">
	                     <span aria-hidden="true">&times;</span>
	                     </button>
	                  </div>
	                  <form name="sendReferenceForm" id="sendReferenceForm">
	                     <div class="modal-body">
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Title:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="titleRef" name="titleRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Author:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="authorRef" name="authorRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Year:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="yearRef" name="yearRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Journal:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="journalRef" name="journalRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Url:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="urlRef" name="urlRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Volume:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="volumeRef" name="volumeRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Issue:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="issueRef" name="issueRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Pages:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="pagesRef" name="pagesRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Editors:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editorsRef" name="editorsRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Type:</label>
	                                 </td>
	                                 <td>                           <select class="form-control" id="typeRef" name="typeRef">
                              <option value="" disabled selected>Select a type</option>
                              <option value="Book">Book</option>
                              <option value="Journal Article">Journal Article</option>
                              <option value="Conference Paper">Conference Paper</option>
                              <option value="Thesis">Thesis</option>
                              <option value="Report">Report</option>
                              <option value="Website">Website</option>
                              <option value="Patent">Patent</option>
                              <option value="Other">Other</option>
                           </select></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Note:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="noteRef" name="noteRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                     </div>
	                     <div class="modal-footer">
	                        <button id="cancelSubmitReference" type="reset" class="btn light">Cancel</button>
	                        <button type="submit" id="submitReference" class="btn btn-primary">Submit</button>
	                     </div>
	                  </form>
	               </div>
	            </div>
	         </div>
	         <div id="editBiblioAlert" class="modal" tabindex="-1" role="dialog" style="overflow-y: scroll;">
	            <div class="modal-dialog" role="document" th:draggable="true">
	               <div class="modal-content">
	                  <div class="modal-header">
	                     <h5 class="modal-title">Edit Bibliography Block</h5>
	                     <button type="button" class="close" data-dismiss="modal"
	                        aria-label="Close">
	                     <span aria-hidden="true">&times;</span>
	                     </button>
	                  </div>
	                  <form name="sendBiblioForm" id="sendEditBiblioForm">
	                     <div class="modal-body">
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Title:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editTitleBiblio" name="editTitleBiblio" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Description:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editDescBiblio" name="editDescBiblio" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                     </div>
	                     <div class="modal-footer">
	                        <button id="cancelBiblioBlock" type="reset" class="btn light">Cancel</button>
	                        <button type="submit" id="submitBiblioBlock"
	                           class="btn btn-primary">Submit</button>
	                     </div>
	                  </form>
	               </div>
	            </div>
	         </div>
	         <div id="editReferenceAlert" class="modal" tabindex="-1" role="dialog" style="overflow-y: scroll;">
	            <div class="modal-dialog" role="document" th:draggable="true">
	               <div class="modal-content">
	                  <div class="modal-header">
	                     <h5 class="modal-title">Edit Reference</h5>
	                     <button type="button" class="close" data-dismiss="modal"
	                        aria-label="Close">
	                     <span aria-hidden="true">&times;</span>
	                     </button>
	                  </div>
	                  <form name="sendReferenceForm" id="sendEditReferenceForm">
	                     <div class="modal-body">
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Title:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editTitleRef" name="ediTitleRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Author:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editAuthorRef" name="editAuthorRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Year:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editYearRef" name="editYearRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Journal:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editJournalRef" name="editJournalRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Url:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editUrlRef" name="editUrlRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Volume:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editVolumeRef" name="editVolumeRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Issue:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editIssueRef" name="editIssueRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Pages:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editPagesRef" name="editPagesRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Editors:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editEditorsRef" name="editEditorsRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Type:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editTypeRef" name="editTypeRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                        <div class="form-group">
	                           <table>
	                              <tr>
	                                 <td><label for="name" class="col-form-label">Note:</label>
	                                 </td>
	                                 <td><input type="text" class="form-control"
	                                    id="editNoteRef" name="editNoteRef" /></td>
	                              </tr>
	                           </table>
	                        </div>
	                     </div>
	                     <div class="modal-footer">
	                        <button id="cancelRefBlock" type="reset" class="btn light">Cancel</button>
	                        <button type="submit" id="submitRefBlock"
	                           class="btn btn-primary">Submit</button>
	                     </div>
	                  </form>
	               </div>
	            </div>
	         </div>
            <div id="loginAlert" class="modal" tabindex="-1" role="dialog"
                backdrop="static"
                style="display: none; background-color: rgba(0, 0, 0, 0.5);">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Login</h5>
                        </div>
                        <div class="modal-body">
                            <h6>You are not logged in, please login.</h6>
                        </div>
                        <div class="modal-footer">
                            <a class="btn btn-primary" style="color: white;"
                                onClick="window.location.reload();">Login</a>
                        </div>
                    </div>
                </div>
            </div>
            <div id="addChoiceAlert" class="modal" tabindex="-1"
                role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select from the
                                Choices
                            </h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="choiceForm" id="choiceForm"
                            enctype="multipart/form-data" method="post">
                            <div id="choiceDiv" class="modal-body">
                                <input class="choiceOptions"
                                    id="showAllChoices" type="checkbox"
                                    name="showAll" value="showAll"
                                    checked="true" /> <label for="showAll">Always
                                show all choices</label><br />
                                <div id="selectChoices">
                                    <div th:each="choice: ${choices}">
                                        <input class="choiceOptions"
                                            th:id="${choice.id}"
                                            type="checkbox"
                                            th:name="${choice.sequence.name}"
                                            th:value="${choice.sequence.name}" />
                                        <label th:for="${choice.id}">[[${choice.sequence.name}]]</label>
                                        <br />
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button id="cancelSubmitChoice" type="reset"
                                    class="btn light">Cancel</button>
                                <button type="submit" id="submitChoices"
                                    class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
         <div id="slideSpace">
            <div th:each="contents: ${slideContents}">
            
            <!-- Image Block -->
            
				<div th:attr="data-position=${contents.contentOrder}" 
				     th:id="${contents.id}" 
				     class="valueDiv tab row" 
				     data-image-block
				     th:if="${#strings.equals(contents['class'].simpleName,'ImageBlock')}">
				    <img th:id="${contents.id}" 
				         class="imgDiv" 
				         th:src="@{'/api/image/'+${contents.image.id}}" />
				    <input type="hidden" 
				           data-image-id="${contents.id}"
				           th:attr="data-image-id=${contents.id}"
				           th:value="${contents.id}" />
				    <a class="btn col-md-1" 
				       data-action="delete-image" 
				       href="javascript:;" 
				       style="position:absolute; right:25px;">
				        <span class="icon-trash error"></span>
				    </a>
				</div>
               
               <!-- Text Block -->
               
				<div th:attr="data-position=${contents.contentOrder}" 
				     style="word-break:break-word;" 
				     th:id="${contents.id}" 
				     class="textDivStaff tab row" 
				     th:if="${#strings.equals(contents['class'].simpleName,'TextBlock')}">
				    <p class="col-md-10">[[${contents.text}]]</p>
				    <input type="hidden" 
				           data-text-id="${contents.id}" 
				           th:attr="data-text-id=${contents.id}"
				           th:value="${contents.id}" />
				    <a class="btn col-md-1" 
				       data-action="delete-text" 
				       href="javascript:;">
				        <span class="icon-trash error"></span>
				    </a>
				</div>
               
				<!-- Video Block -->    
				           
				<div th:attr="data-position=${contents.contentOrder}" 
				     class="tab vidDiv row" 
				     th:id="${contents.id}" 
				     data-video-block
				     th:if="${#strings.equals(contents['class'].simpleName,'VideoBlock')}">
				    <div>
				        <h3><strong>[[${contents.video.title}]]</strong></h3>
				        <br/>
				        <iframe th:id="${contents.id}" 
				                width="800" 
				                height="530" 
				                th:src="${contents.video.url}" 
				                th:if="${contents.video.url}" 
				                frameborder="0"
				                allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
				                allowfullscreen></iframe>
				        <video th:id="${contents.id}" 
				               width="800" 
				               height="530" 
				               th:if="${contents.video.url == null}" 
				               controls>
				            <source th:src="@{'/api/video/'+${contents.video.id}}" type="video/mp4"/>
				        </video>
				    </div>
				    <a class="btn col-md-1" 
				       data-action="delete-video" 
				       th:attr="data-video-id=${contents.id}"
				       data-video-id="${contents.id}"
				       href="javascript:;" 
				       style="position:absolute; right:25px;">
				        <span class="icon-trash error"></span>
				    </a>
				    <a class="btn col-md-1" 
				       data-action="edit-video" 
				       th:attr="data-editvideo-id=${contents.id}"
				       data-editvideo-id="${contents.id}"
				       href="javascript:;" 
				       style="position:absolute; top:60px;right:25px;">
				        <span class="icon-edit"></span>
				    </a>
				</div>
               
               <!-- Biblio Block -->
               
				<div th:attr="data-position=${contents.contentOrder}" 
				     class="biblioDivStaff tab row" 
				     th:id="${contents.id}"
				     data-biblio-block
				     th:if="${#strings.equals(contents['class'].simpleName,'BiblioBlock')}">
				    <p class="col-md-10">
				        Bibliography Title: <span>[[${contents.biblioTitle}]]</span>, 
				        Description: <span>[[${contents.description}]]</span>
				    </p>
				    <input type="hidden" 
				           data-biblio-id="${contents.id}" 
				           th:attr="data-biblio-id=${contents.id}"
				           th:value="${contents.id}" />
				    <a class="btn col-md-1" 
				       data-action="delete-biblio" 
				       href="javascript:;">
				        <span class="icon-trash error"></span>
				    </a>
				    <a class="btn primary-btn btn-sm" 
				       data-action="add-reference" 
				       style="padding-top: 8px;">+ New Reference</a>
				    <div id="referenceSpace" class="col-md-10">
				        <div th:each="contentRef: ${contents.references}">
				        
				        <!-- Reference Block -->
				        
					    <div th:id="${contentRef.id}" 
					         class="referenceDivStaff tab row" 
					         data-reference-block
					         th:attr="data-biblio-id=${contents.id}">
					        <p class="col-md-10">
					            Reference Title: <span>[[${contentRef.title}]]</span>, 
					            Author: <span>[[${contentRef.author}]]</span>,
					            Year: <span>[[${contentRef.year}]]</span>, 
					            Journal: <span>[[${contentRef.journal}]]</span>,
					            Url: <span>[[${contentRef.url}]]</span>, 
					            Volume: <span>[[${contentRef.volume}]]</span>,
					            Issue: <span>[[${contentRef.issue}]]</span>, 
					            Pages: <span>[[${contentRef.pages}]]</span>,
					            Editors: <span>[[${contentRef.editors}]]</span>, 
					            Type: <span>[[${contentRef.type}]]</span>,
					            Note: <span>[[${contentRef.note}]]</span>
					        </p>
					        <input type="hidden" 
					               class="deleteReferenceField" 
					               data-reference-id="${contentRef.id}"
					               th:attr="data-reference-id=${contentRef.id}"
					               th:value="${contentRef.id}" />
					        <a class="btn col-md-1" 
					           data-action="delete-reference" 
					           data-reference-id="${contentRef.id}"
					           th:attr="data-reference-id=${contentRef.id}"
					           href="javascript:;">
					            <span class="icon-trash error"></span>
					        </a>
					    </div>
					</div>
				
				    </div>
				</div>
               
               <!-- Space Block -->
               
				<div th:attr="data-position=${contents.contentOrder}" 
				     style="word-break: break-word;" 
				     th:id="${contents.id}" 
				     class="SpaceDivStaff tab row" 
				     data-space-block
				     th:if="${#strings.equals(contents['class'].simpleName,'SpaceBlock')}">
				    <div style="display: flex; flex-direction: column; width: 100%;">
				        <div style="display:flex; flex-direction: row; width: 100%;">
				            <label>Title: </label>
				            <p class="col-md-10">[[${contents.title}]]</p>
				        </div>
				        <div style="display:flex; flex-direction: row;width: 100%;">
				            <label>Space: </label>
				            <p class="col-md-10" th:if="${contents.space != null}">[[${contents.space.name}]]</p>
				        </div>
				    </div>
				    <input type="hidden" 
				           data-space-id="${contents.id}" 
				           th:attr="data-space-id=${contents.id}"
				           th:value="${contents.id}" />
				    <a class="btn col-md-1" 
				       data-action="delete-space" 
				       href="javascript:;" 
				       style="position: absolute; right: 0px; bottom: 10px;">
				        <span class="icon-trash error"></span>
				    </a>
				</div>
				
				<!-- Choice Block -->
				
				<div th:attr="data-position=${contents.contentOrder}" 
				     th:id="${contents.id}" 
				     class="choiceDiv tab row" 
				     data-choice-block
				     th:if="${#strings.equals(contents['class'].simpleName,'ChoiceBlock')}" 
				     style="display:block;">
				    <a th:if="${contents.showsAll}" 
				       th:each="choice: ${choices}" 
				       style="display:block; color: var(--primary);"
				       th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${choice.sequence.id}}">
				       [[${choice.sequence?.name}]]
				    </a>
				    <a th:if="!${contents.showsAll}" 
				       th:each="choice: ${contents.choices}" 
				       style="display:block; color: var(--primary);"
				       th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${choice.sequence.id}}">
				       [[${choice.sequence?.name}]]
				    </a>
				    <input type="hidden" 
				           class="col-md-8" 
				           data-choice-id="${contents.id}" 
				           th:attr="data-choice-id=${contents.id}"
				           th:value="${contents.id}">
				    <a class="btn col-md-1" 
				       data-action="delete-choice" 
				       href="javascript:;" 
				       style="position:absolute; right:0; top: 0;">
				        <span class="icon-trash error"></span>
				    </a>
				</div>
            </div>
        </div>
    </body>
</html>