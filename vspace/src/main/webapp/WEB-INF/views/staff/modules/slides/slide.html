<html layout:decorate="~{layouts/main_staff}">
    <head>
        <link rel="stylesheet"
            href="https://unpkg.com/easymde/dist/easymde.min.css">
        <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
        <style type="text/css">
            .hova {
            background-color: #f2f2f2;
            }
            .EasyMDEContainer .CodeMirror-wrap{
            overflow-y: scroll;
            height: 400px;
            }
        </style>
        <script th:inline="javascript">
            //# sourceURL=click.js
            var contentCount = [[${#lists.size(slideContents)}]];
            var markDown = null;
            var defaultValue;
            
            $(function () {
            	  $('[data-toggle="tooltip"]').tooltip()
            });
            
            function createImageBlock(reader, width) {
                var imageblock = $('<div id="current" class="valueDiv tab row"><img src="#" style="imgDiv tab row"/><input type="hidden" id="deleteImageId" /><a class="btn deleteImage col-md-1" href="javascript:;" style="position:absolute; right:25px;"><span class="icon-trash error"></span></a></div>');
                imageblock.find('img').attr('src', reader.result);
                if(width > 800)
                	imageblock.find('img').attr('width', '800px');
                return imageblock;
            }
            
            function createImageBlockWithExistingImage(src, width) {
                var imageblock = $('<div id="current" class="valueDiv tab row"><img src="#" style="imgDiv tab row"/><input type="hidden" id="deleteImageId" /><a class="btn deleteImage col-md-1" href="javascript:;" style="position:absolute; right:25px;"><span class="icon-trash error"></span></a></div>');
                imageblock.find('img').attr('src', src);
                if(width > 800)
                	imageblock.find('img').attr('width', '800px');
                return imageblock;
            }
            
            function onMouseEnter(e){
                var target = $( e.target );
               
                $(".hova").removeClass("hova");
                $(e.target).addClass("hova");
                // This is needed to prevent only the p tag from being highlighted
                if(target.is('p')){
                    $(e.target).parent().addClass("hova");
                }
                //prevent normal hover actions
                e.preventDefault();
            }
            function onMouseLeave(e) {
                $(this).removeClass("hova");
            }
            
            function onDoubleClick(e){
                // get to the nearest divs class attribute
                $(".EasyMDEContainer").remove();
                var divName = $(e.target).closest('div').attr('class');
                //if the div is a text content block 
                if(divName.includes("textDivStaff")){
                	$(e.target).closest('.textDivStaff').addClass("open");
                    var description = $("div.open p:eq(0)").text();
                	defaultValue = description;
            
                    $("#editTextAlert").show();
                    markDown = new EasyMDE({element: $('#editTextBlock')[0]});
                    markDown.value(description.trim());
                    //remove card border
                    $(".open").css('display', 'none');
                    $(".open").css('overflow-y', 'scroll');
                    $(".open").css('height', '400px');
                } 
                else if(divName.includes("biblioDivStaff")){
                	$(e.target).closest('.biblioDivStaff').addClass("open");
                	var description = $("div.open p:eq(0)").text();
                	defaultValue = description;
                	var title = $("div.open p span:eq(0)").text();
                	var desc = $("div.open p span:eq(1)").text();
                	var refListDiv = $(".open div").html();
                	
                	//showing the edit bibliography form with all the respective values
                	$("#editBiblioAlert").show();
                	$("#editTitleBiblio").val(title);
                	$("#editDescBiblio").val(desc);
    		
			formDataCancel = new FormData();
			formDataCancel.append('biblioTitle', title);
			formDataCancel.append('description', desc);
			formDataCancel.append('refListDiv', refListDiv);
    	    		//remove card border
			$(".open").css('display', 'none');
			$(".open").css('overflow-y', 'scroll');
          	
		} else if(divName.includes("referenceDivStaff")){
			$(e.target).closest('.referenceDivStaff').addClass("open");
			var description = $("div.open p:eq(0)").text();
			defaultValue = description;
			var refBlockId = $(".open").attr("id");
			var biblioBlockId = $(e.target).closest('.biblioDivStaff').attr("id");
    	   
			$.ajax({
				url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/biblio/'})]" + biblioBlockId + ['/reference/'] + refBlockId ,
				type: 'GET',
    	          		cache: false,
    	          		contentType : 'application/json; charset=utf-8',
    	          		processData : false,
    	          		headers: {
    	              		'X-CSRF-Token': [[${_csrf.token}]] 
    	         		},
    	          		success: function(data) {
    	        			//showing the edit bibliography form with all the respective values
    	      	    			$("#editReferenceAlert").show();
    	      	    			var alert = $('<input type="hidden" id="currentBiblioId">');
    	      				$(alert).attr( 'value', biblioBlockId);
    	      				$('.modal-footer').append(alert); 
    	      	
    	      	    			$("#editTitleRef").val(data.title);
	              			$("#editAuthorRef").val(data.author);
					$("#editYearRef").val(data.year);
					$("#editJournalRef").val(data.journal);
					$("#editUrlRef").val(data.url);
					$("#editVolumeRef").val(data.volume);
					$("#editIssueRef").val(data.issue);
					$("#editPagesRef").val(data.pages);
					$("#editEditorsRef").val(data.editors);
					$("#editTypeRef").val(data.type);
					$("#editNoteRef").val(data.note);
	              
				},
				error: function(data) {
					if (data.status == 403) {
						$("#loginAlert").show();
					}
					else {
						var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
						$('.errorMsg').append(alert);
					}
				}
			});
    	
			//remove card border
			$(".open").css('display', 'none');
			$(".open").css('overflow-y', 'scroll');
			$(".open").css('max-height', '200px');
    		}
                else {
                	// store image ID selected by the user to replace, onDoubleClick
                	var imgBlockID = $(e.target).attr('id'); 
                	if(imgBlockID != ''){
                    	$("#uploadImage").data('value', imgBlockID); // sets image ID value
                    	$("#addImgAlert").show();
                	}
            	
                }
            }
                
            function uploadImage() {
            	var imgBlockID = $("#uploadImage").data('value') // gets image ID
            	var file = $('#file')[0].files[0];
            	var reader  = new FileReader();
            	var formData = new FormData();
            	var chooseFromExisting = true;
            	if (typeof(file) != "undefined"){
            		chooseFromExisting = false;
            		formData.append('file', file);
            	}
            	var imageSource = $('#selectedImage').find('img').attr('src');
            	var imageId = "";
            	if(typeof(imageSource) != "undefined"){
            		imageId = imageSource.split("/").pop().split(".")[0];
            	}
            	var imageblock = "";
            	var oldImageBlock = "";
            			    
            	// Ashmi changes for Story VSPC-64
            			    
            	// checks if image ID is present to replace
            	if (imgBlockID != '') {
            			oldImageBlock = $("#" + imgBlockID);
            			var imageBlockId = imgBlockID;
            			formData.append('imageBlockId',imageBlockId);
            			var url = "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/image/'})]" + imageBlockId + '?[(${_csrf.parameterName})]=[(${_csrf.token})]';
            			if(!chooseFromExisting){
            				reader.onload = function (theFile)
            				{
            					var image = new Image();
            					image.src = theFile.target.result;
            					image.onload = function ()
            					{
            						imageblock = createImageBlock(reader, this.width);
            						$("#" + imageBlockId).replaceWith(imageblock);	
            						$(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
            					};
            				}
            			}
            			else{
            				var image = new Image();
            				image.src = $('#selectedImage').find('img').attr('src');
            				formData.append('imageId',imageId);
            				imageblock = createImageBlockWithExistingImage($('#selectedImage').find('img').attr('src'),image.width);
            				$("#" + imageBlockId).replaceWith(imageblock);	
            				$(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
            			}
            			// Reset data-attribute to get current selected image ID
            			$("#uploadImage").data('value', '');
            	}
            	else {
            		var url = "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/image/?'+${_csrf.parameterName}+'='+${_csrf.token}})]";
            		if(!chooseFromExisting){
            			reader.onload = function (theFile) 
            			{        	
            			var image = new Image();
            			image.src = theFile.target.result;
            			image.onload = function() 
            			{
            				imageblock = createImageBlock(reader, this.width);  
            				$('#slideSpace').append(imageblock); 
            				$(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
            			};          
            			} 
            		}
            		else
            		{
            			var image = new Image();
            			image.src = $('#selectedImage').find('img').attr('src');
            			formData.append('imageId',imageId);
            			imageblock = createImageBlockWithExistingImage($('#selectedImage').find('img').attr('src'),image.width);  
            			$('#slideSpace').append(imageblock); 
            			$(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
            		}
            	}
            	if (!chooseFromExisting)
            	{
            		reader.readAsDataURL(file)
            	}
            	$.ajax({
            		enctype: 'multipart/form-data',
            		// ------------- creating image content blocks ------------
            		url: url,
            		type: 'POST',
            		cache       : false,
            		contentType : false,
            		processData : false,
            		data: formData,    
            		success: function(data) {
            			$(".open").removeClass("open");
            			var img = imageblock.find('img');
            			if(data != ''){
            				img.attr('id', data);
            				$("#current").find('#deleteImageId').val(data);
            				$("#current").attr('id', data);
            			}
            			else{
            				img.attr('id', imgBlockID);
            				$("#current").find('#deleteImageId').val(imgBlockID);
            				$("#current").attr('id', imgBlockID);
            			}
            		},
            		error: function(data) {
            		if (imgBlockID == '') {
            			$("#current").remove();
            		}
            		else {
            			$("#current").replaceWith(oldImageBlock);
            		}
            		if (data.status == 403) {
            			$("#loginAlert").show();
            		}
            		}
            	});
            	// Reset the image file name 
            	$('#file').val('');
            	if(chooseFromExisting)
            	{
            		$("#selectedImage").empty();
            		$('#imageId').prop('selectedIndex',0).trigger( "change" );
            	}
            }
            
            function guidedTour() {
            	const tour = new Shepherd.Tour({
            		  defaultStepOptions: {
            		    cancelIcon: {
            		      enabled: true
            		    },
            		    classes: '',
            		    scrollTo: { behavior: 'smooth', block: 'center' },
            		  },
            		  useModalOverlay: true,
            		});
            
            	tour.addStep({
            	  title: 'Welcome to the slide editor!',
            	  text: `Add or edit the content you want to show on your slides.`,
            	  buttons: [
            	    {
            	      action() {
            	        return this.next();
            	      },
            	      text: 'Next'
            	    }
            	  ],
            	  id: 'creating1'
            	});
            	
            	tour.addStep({
            	  title: 'Easy navigation',
            	  text: `Keep track of your location in the module or navigate back.`,
            	  attachTo: {
            	    element: '.breadcrumb',
            	    on: 'bottom'
            	  },
            	  buttons: [
            	    {
            	      action() {
            	        return this.back();
            	      },
            	      classes: 'shepherd-button-secondary',
            	      text: 'Back'
            	    },
            	    {
            	      action() {
            	        return this.next();
            	      },
            	      classes: 'btn primary-btn',
            	      text: 'Next'
            	    }
            	  ],
            	  id: 'creating2'
            	});
            	
            	tour.addStep({
            	  title: 'Adding content',
            	  text: `Add content to your slide. The content will be shown in the exhibition in the order you define here.`,
            	  attachTo: {
            	    element: '.content-btns',
            	    on: 'bottom'
            	  },
            	  buttons: [
            	    {
            	      action() {
            	        return this.back();
            	      },
            	      classes: 'shepherd-button-secondary',
            	      text: 'Back'
            	    },
            	    {
            	      action() {
            	        return this.next();
            	      },
            	      text: 'Done'
            	    }
            	  ],
            	  id: 'creating3'
            	});
            	tour.start();
            }

			$(document).ready(function() {
            	if (localStorage.getItem("newSlide") == null) {
            		guidedTour();
            		localStorage.setItem("newSlide", false);
            	}
            	$('#imageId').prop("disabled",true);
            	$('#chooseFromLocal').click(function() {
            		$("#selectedImage").empty();
            		$('#imageId').prop('selectedIndex',0).trigger( "change" );
            		$('#imageId').prop("disabled",true);
            		$('#file').prop("disabled",false);
            		
            	  });
            	
            	$('#chooseFromExisting').click(function() {
            		$('#file').val('');
            		$('#file').prop("disabled",true);
            		$('#imageId').prop("disabled",false);
            	  });
                [# th:if="${#strings.equals(slide['class'].simpleName,'BranchingPoint')}"]
            		$('#addChoice').show();
            		$('#choiceSpace').show();
            	[/]
            	
            
                //-------- edit contentblock description --------
            
                $("#submitDescription").hide()
                $("#cancelEditDescription").hide()
                var description = $("#description").text()
                $("#editDescription").click(function() {
                    $('<textarea id="newDescription" style="margin-top: 1%;" class="form-control" type="text">'+description+'</textarea>').insertBefore( "#description" );
                    $("#description").remove()
                    $("#editDescription").hide()
                    $("#submitDescription").show()
                    $("#cancelEditDescription").show()
                    
                });
            
                $("#submitDescription").click(function() {
                    var formData = new FormData();
                    formData.append('description', $("#newDescription").val());
                    $.ajax({ 
            	        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/edit/description?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
            	        type: 'POST',
            	        cache       : false,
            	        contentType : false,
            	        processData : false,
            	        data: formData,
            	        enctype: 'multipart/form-data',
            	        success: function(data) {
            	            // replace text box with new description
            	            $("#submitDescription").hide()
            	            $("#cancelEditDescription").hide()
            	            $("#editDescription").show()
            	            var val = $("#newDescription").val();
            	            $('<p id="description"style="margin-top: .5rem; margin-bottom: .5rem;"></p>').insertBefore( "#newDescription" );
            	            $("#newDescription").remove();
            	            $("#description").text(val)
            	        },
            	        error: function(data) {
            	            $(".open").removeClass("open");
            	                var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            	                $('.error').append(alert);
            	        }
                     });       
                  });
                
                $("#cancelEditDescription").click(function(){
                    $("#submitDescription").hide()
                    $("#editDescription").show()
                    $("#cancelEditDescription").hide()
                    $('<p id="description" style="margin-top: .5rem; margin-bottom: .5rem;"></p>').insertBefore( "#newDescription" );
                    $("#newDescription").remove()
                    $("#description").text(description)
                    
                });
                
                //------- edit title --------
                $("#submitTitle").hide();
                $("#cancelEditTitle").hide();
                var getTitleText = $("#title").text().split(": ")[1]
                $("#editTitle").click(function() {
                    $('<div class="col-4"><input id="newTitle" class="form-control" type="text"></div>').insertAfter( "#title" );
                    $('#title').text('Slide: ')
                    $("#newTitle").val(getTitleText)
                    $("#editTitle").hide()
                    $("#submitTitle").show()
                    $("#cancelEditTitle").show()       
                });
                
                $("#submitTitle").click(function() {
                    var formData = new FormData();
                    formData.append('title', $("#newTitle").val());
                    $.ajax({
                        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/edit/title?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
                        type: 'POST',
                        cache       : false,
                        contentType : false,
                        processData : false,
                        data: formData,
                        enctype: 'multipart/form-data',
                        success: function(data) {
                            // replace text box with new description
                            $("#submitTitle").hide()
                            $("#cancelEditTitle").hide();
                            $("#editTitle").show()
                            var val = $("#newTitle").val();
                            $("#newTitle").closest('div').remove();
                            $("#title").text("Silde: " + val)
                            
                        },
                        error: function(data) {
                            var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                            $('.error').append(alert);
                        }
                    });
                  });
               $("#cancelEditTitle").click(function(){
                    $("#submitTitle").hide()
                    $("#editTitle").show()
                    $("#cancelEditTitle").hide()
                    $("#newTitle").closest('div').remove();
                    $("#title").text("Silde: " + getTitleText);
               });
               
                $("#addText").click(function() {
                    $(".EasyMDEContainer").remove();
                	markDown = new EasyMDE({element: $('#textBlockText')[0]});
                    $("#addTextAlert").show();
                });
                
                $("#addImage").click(function() {
                    $("#addImgAlert").show();
                });
                
                $("#uploadImage").click(function(e) {
                    e.preventDefault();
                    $("#addImgAlert").hide();
                    uploadImage();
                    $('#chooseFromLocal').trigger( "click" );
                });
                
                $("#addChoice").click(function() {
                    $("#addChoiceAlert").show();
                });
                
                $(document).on("click", ".deleteText", function(e) {
            		$("#confirmDeleteTextAlert").show();
            		var alert = $('<input type="hidden" id="deleteTextId">');
            		$(alert).attr( 'value', $(this).siblings('input').val());
            		$('.modal-footer').append(alert); 
              	});
            	
            	$(document).on("click", ".deleteImage", function(e) {
            		$("#confirmDeleteImageAlert").show();
            		var alert = $('<input type="hidden" id="deleteImageId">');
            		$(alert).attr( 'value', $(this).siblings('input').val());
            		$('.modal-footer').append(alert); 
              	});
              	
              	$("#addBibliography").click(function() {
              		$("#addBiblioAlert").show();
              	});
              	
              	$(document).on("click", ".addReference", function(e) {
					$("#addReferenceAlert").show();
					var alert = $('<input type="hidden" id="currentBiblioId">');
					$(alert).attr( 'value', $(this).closest("div").attr("id"));
					$('.modal-footer').append(alert); 
				});
				
				$(document).on("click", ".deleteBiblio", function(e) {
					$("#confirmDeleteBiblioAlert").show();
					var alert = $('<input type="hidden" id="deleteBiblioId">');
					$(alert).attr( 'value', $(this).siblings('input').val());
					$('.modal-footer').append(alert); 
				});
				
				$(document).on("click", ".deleteReference", function(e) {
					$("#confirmDeleteRefAlert").show();
					var alert = $('<input type="hidden" id="deleteReferenceId">');
					$(alert).attr( 'value', $(this).siblings('input').val());
					$('.modal-footer').append(alert);
					var alert2 = $('<input type="hidden" id="currentBiblioId">');
					$(alert2).attr( 'value', $(e.target).closest('.biblioDivStaff').attr("id"));
					$('.modal-footer').append(alert2);
				});
				
            	$(document).on("click", ".deleteChoiceBlock", function(e) {
            		$("#confirmDeleteChoiceBlockAlert").show();
            		var alert = $('<input type="hidden" id="deleteChoiceBlockId">');
            		$(alert).attr( 'value', $(this).siblings('input').val());
            		$('.modal-footer').append(alert); 
              	});
                
                $("#cancelSubmitText").click(function() {
            		$("#addTextAlert").hide();	
            	});
            	
            	$("#cancelDeleteText").click(function() {
            		$("#confirmDeleteTextAlert").find('input').remove();
            		$("#confirmDeleteBiblioAlert").find('input').remove();
			$("#confirmDeleteRefAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
            		$("#confirmDeleteTextAlert").hide();
            	});
            	
            	$("#cancelDeleteImage").click(function() {
            		$("#confirmDeleteImageAlert").hide();
            	});
            	
            	$("#cancelSubmitBiblio").click(function() {
			$("#addBiblioAlert").hide();	
		});
	
		$("#cancelSubmitReference").click(function() {
			$("#addReferenceAlert").hide();	
		});
	
		$("#cancelDeleteBiblio").click(function() {
			$("#confirmDeleteTextAlert").find('input').remove();
			$("#confirmDeleteBiblioAlert").find('input').remove();
			$("#confirmDeleteRefAlert").find('input').remove();
			$("#confirmDeleteImageAlert").find('input').remove();
			$("#confirmDeleteChoiceBlockAlert").find('input').remove();
			$("#confirmDeleteBiblioAlert").hide();
		});
	
		$("#cancelDeleteReference").click(function() {
			$("#confirmDeleteTextAlert").find('input').remove();
			$("#confirmDeleteBiblioAlert").find('input').remove();
			$("#confirmDeleteRefAlert").find('input').remove();
			$("#confirmDeleteImageAlert").find('input').remove();
			$("#confirmDeleteChoiceBlockAlert").find('input').remove();
			$("#confirmDeleteRefAlert").hide();
		});
            	
            	$("#cancelDeleteChoiceBlock").click(function() {
            	    $("#confirmDeleteChoiceBlockAlert").find('input').remove();
            	    $("#confirmDeleteTextAlert").find('input').remove();
            	    $("#confirmDeleteBiblioAlert").find('input').remove();
		    $("#confirmDeleteRefAlert").find('input').remove();
            	    $("#confirmDeleteImageAlert").find('input').remove();
            	    $("#confirmDeleteChoiceBlockAlert").hide();
            	});
            	
            	$("#cancelDelete").click(function() {
            		$("#confirmDeleteTextAlert").find('input').remove();
            		$("#confirmDeleteBiblioAlert").find('input').remove();
			$("#confirmDeleteRefAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").hide();	
            	});
				
			// ---------- Delete Text Block -------------
				
			$("#deleteText").on("click", function(e) {
            		e.preventDefault();
            		$("#confirmDeleteBiblioAlert").find('input').remove();
            		$("#confirmDeleteRefAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
            		$("#confirmDeleteTextAlert").hide();
            		var blockId = $('#deleteTextId').attr('value');
            		$('#deleteTextId').remove()
            		
            		// ------------- delete text content blocks ------------
            		$.ajax({
            		    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/text/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
            		    type: 'DELETE',
            		    success: function(result) {
            		        $('#' + blockId).remove();
            		        
            		    },
            			error: function(data) {
            				var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            				$('.error').append(alert); 
            				$(".error").delay(4000).slideUp(500, function(){
            				    $(".error").empty();
            				});
            			}
            		});
            	});
    	
		// ---------- Delete Bibliography Block -------------

		$("#deleteBiblio").on("click", function(e) {
			e.preventDefault();
			$("#confirmDeleteTextAlert").find('input').remove();
			$("#confirmDeleteImageAlert").find('input').remove();
			$("#confirmDeleteRefAlert").find('input').remove();
			$("#confirmDeleteChoiceBlockAlert").find('input').remove();
			$("#confirmDeleteBiblioAlert").hide();
			var blockId = $('#deleteBiblioId').attr('value');
			$('#deleteBiblioId').remove();

			// ------------- delete Bibliography content blocks ------------
			$.ajax({
			url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/biblio/'})]"+blockId,
			type: 'DELETE',
			headers: {
			'X-CSRF-Token': [[${_csrf.token}]]
			},
			success: function(result) {
				$('#' + blockId).remove();
			},
				error: function(data) {
					var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
					$('.errorMsg').append(alert); 
					$(".errorMsg").delay(4000).slideUp(500, function(){
					$(".errorMsg").empty();
					});
				}
			});
		});

		// ---------- Delete Reference -------------

		$("#deleteReference").on("click", function(e) {
			e.preventDefault();
			$("#confirmDeleteTextAlert").find('input').remove();
			$("#confirmDeleteImageAlert").find('input').remove();
			$("#confirmDeleteBiblioAlert").find('input').remove();
			$("#confirmDeleteChoiceBlockAlert").find('input').remove();
			$("#confirmDeleteRefAlert").hide();
			var refId = $('#deleteReferenceId').attr('value');
			$('#deleteReferenceId').remove();
			var biblioBlockId = $('#currentBiblioId').attr('value');
			$('#currentBiblioId').remove();

			// ------------- delete Reference ------------
			$.ajax({
			url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/biblio/'})]" + biblioBlockId + ['/reference/'] + refId,
			type: 'DELETE',
			headers: {
			'X-CSRF-Token': [[${_csrf.token}]]
			},
			success: function(result) {
				$('#' + refId).remove();
			},
				error: function(data) {
					var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
					$('.errorMsg').append(alert); 
					$(".errorMsg").delay(4000).slideUp(500, function(){
					$(".errorMsg").empty();
					});
				}
			});
		});
            	
            	// ---------- Delete Image Block -----------
            	
            	$("#deleteImage").on("click", function(e) {
            		e.preventDefault();
            		$("#confirmDeleteTextAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").hide();
            		var blockId = $('#deleteImageId').attr('value');
            		if(blockId == null || blockId == ''){
            			var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            			$('.error').append(alert); 
            			$(".error").delay(4000).slideUp(500, function(){
            			    $(".error").empty();
            			});
            		} else{
            			$('#deleteImageId').remove()
            			// ------------- delete image content blocks ------------
            			$.ajax({
            			    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/image/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
            			    type: 'DELETE',
            			    success: function(result) {
            			    	$('#' + blockId).remove();
            			    },
            				error: function(data) {
            					var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            					$('.error').append(alert); 
            					$(".error").delay(4000).slideUp(500, function(){
            					    $(".error").empty();
            					});
            				}
            			});
            		}
            	});
            	
            	$("#deleteChoiceBlock").on("click", function(e) {
            	    e.preventDefault();
            	    $("#confirmDeleteTextAlert").find('input').remove();
            	    $("#confirmDeleteBiblioAlert").find('input').remove();
            	    $("#confirmDeleteRefAlert").find('input').remove();
            	    $("#confirmDeleteImageAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").hide();
            		var blockId = $('#deleteChoiceBlockId').attr('value');
            		if(blockId == null || blockId == ''){
            			var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            			$('.errorMsg').append(alert); 
            			$(".errorMsg").delay(4000).slideUp(500, function(){
            			    $(".errorMsg").empty();
            			});
            		} else{
            			$('#deleteChoiceBlockId').remove()
            			// ------------- delete choices content blocks ------------
            			$.ajax({
            			    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/choiceBlock/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
            			    type: 'DELETE',
            			    success: function(result) {
            			    	$('#' + blockId).remove();
            			    },
            				error: function(data) {
            					var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            					$('.errorMsg').append(alert); 
            					$(".errorMsg").delay(4000).slideUp(500, function(){
            					    $(".errorMsg").empty();
            					});
            				}
            			});
            		}
            	});
            	$("#cancelSubmitChoice").click(function() {
                    $("#addChoiceAlert").hide();	
                });
            	
                $("#cancelImageBtn").click(function() {
                	$('#chooseFromLocal').trigger( "click" );
                	// Initialize selected image ID to blank, on clicking cancel button
                	$("#uploadImage").data('value', '');
                    $("#addImgAlert").hide();
                    $(".open").removeClass("open");
                });
                
                $("#file").click(function() {
                	$("#selectedImage").empty();
                	$('#imageId').prop('selectedIndex',0).trigger( "change" );
                });
                
                $("#submitText").on("click", function(e) {
                    $("#addTextAlert").hide();
                    e.preventDefault();
                    // ------------- creating text content blocks ------------
                    
                    var formData = new FormData();
                    var text = markDown.value();
                    formData.append('content', text);
                    markDown.value('');
                    $.ajax({
                        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/textcontent?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
                        type: 'POST',
                        cache       : false,
                        contentType : false,
                        processData : false,
                        data: formData,
                        enctype: 'multipart/form-data',
                        success: function(data) {
            
                            var textblock = $('<div style="word-break:break-word;" id="'+ data +'" class="textDivStaff tab row"><p class="col-md-10">'+text+'</p>'+'<input type="hidden" id="deleteTextId" value="'+data+'" /><a class="btn deleteText col-md-1" href="javascript:;" style="position: absolute; right: 0px;"><span class="icon-trash error"></span></a></div>');
                            $(textblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
                            $('#slideSpace').append(textblock);             
                        },
                        error: function(data) {
                        	if (data.status == 403){
                        		$("#loginAlert").show();
                        	}
                        	else {
                            	var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                            	$('.error').append(alert);
                        	}
                        }
                    });
                });

    
	    $("#submitBiblio").on("click", function(e) {
		e.preventDefault();
		// ------------- creating Bibliography content blocks ------------

		var formData = new FormData();
		var biblioTitle = $("#titleBiblio").val();
		var description = $("#descriptionBiblio").val();

		formData.append('biblioTitle', biblioTitle);
		formData.append('description', description);

		$("#titleBiblio").val('');
		$("#descriptionBiblio").val('');
		$("#addBiblioAlert").hide();

		var object = {};
		formData.forEach((value, key) => object[key] = value);
		var jsonData = JSON.stringify(object);

		$.ajax({
		    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/bibliography'})]",
		    type: 'POST',
		    cache       : false,
		    contentType : 'application/json; charset=utf-8',
		    processData : false,
		    headers: {
			'X-CSRF-Token': [[${_csrf.token}]]
			},
		    data: jsonData,
		    success: function(data) {
			var biblioblock = $('<div><div id="'+ data.id +'" class="biblioDivStaff tab row"><p class="col-md-10"> Bibliography Title: <span>' + data.biblioTitle + '</span>, Description: <span>' + data.description + '</span></p>'
					+ '<input type="hidden" id="deleteBiblioId" value="'+ data.id +'" /><a class="btn deleteBiblio col-md-1" href="javascript:;" style="position: absolute; right:2.3%;"><span class="icon-trash error"></span></a>'
					+ '<a class="btn addReference col-md-1" style="padding-top: 8px;" data-toggle="tooltip" title="Add Reference"><span class="icon-circle-add"></span></a><div id="referenceSpace" class="col-md-10"></div></div></div>');

			$(biblioblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
			$('#slideSpace').append(biblioblock);             
		    },
		    error: function(data) {
			if (data.status == 403){
				$("#loginAlert").show();
			}
			else {
				var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
				$('.errorMsg').append(alert);
			}
		    }

		});
	    });

	    $("#submitReference").on("click", function(e) {
		e.preventDefault();
		// ------------- creating reference ------------

		var formData = new FormData();
		var title = $("#titleRef").val();
		var author = $("#authorRef").val();
		var year = $("#yearRef").val();
		var journal = $("#journalRef").val();
		var url = $("#urlRef").val();
		var volume = $("#volumeRef").val();
		var issue = $("#issueRef").val();
		var pages = $("#pagesRef").val();
		var editors = $("#editorsRef").val();
		var type = $("#typeRef").val();
		var note = $("#noteRef").val();

		formData.append('title', title);
		formData.append('author', author);
		formData.append('year', year);
		formData.append('journal', journal);
		formData.append('url', url);
		formData.append('volume', volume);
		formData.append('issue', issue);
		formData.append('pages', pages);
		formData.append('editors', editors);
		formData.append('type', type);
		formData.append('note', note);
		var biblioBlockId = $('#currentBiblioId').attr('value');

		$("#titleRef").val('');
		$("#authorRef").val('');
		$("#yearRef").val('');
		$("#journalRef").val('');
		$("#urlRef").val('');
		$("#volumeRef").val('');
		$("#issueRef").val('');
		$("#pagesRef").val('');
		$("#editorsRef").val('');
		$("#typeRef").val('');
		$("#noteRef").val('');
		$("#addReferenceAlert").hide();

		var object = {};
		formData.forEach((value, key) => object[key] = value);
		var jsonData = JSON.stringify(object);

		$.ajax({
		    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/biblio/'})]" + biblioBlockId + ['/reference/add'],
		    type: 'POST',
		    cache       : false,
		    contentType : 'application/json; charset=utf-8',
		    processData : false,
		    headers: {
			'X-CSRF-Token': [[${_csrf.token}]]
			},
		    data: jsonData,
		    success: function(data) {
			var referenceblock = $('<div id="'+ data.reference.id +'" class="referenceDivStaff row" style="padding-left: 25px;"><p class="col-md-10" >' + data.refDisplayText
					+ '</p><input type="hidden" id="deleteReferenceId" value="'+ data.id +'" /><a class="btn deleteReference col-md-1" href="javascript:;"><span class="icon-trash error"></span></a></div>');

			$(referenceblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
			var elem = $('#' + biblioBlockId).find('#referenceSpace');
			elem.append(referenceblock);             
		    },
		    error: function(data) {
			if (data.status == 403){
				$("#loginAlert").show();
			}
			else {
				var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
				$('.errorMsg').append(alert);
			}
		    }

		});
	    });
                
                $('input:checkbox').click(function() {
                    if ($(this).is(':checked')) {
                    	$('#submitChoices').prop("disabled", false);
                    } else {
                    if ($('.choiceOptions').filter(':checked').length < 1){
                    	$('#submitChoices').attr('disabled',true);}
                    }
                });
                
                $("#submitChoices").on("click", function(e) {
                    e.preventDefault();
                    $("#addChoiceAlert").hide();
                    var selectedChoice = [];
                    var showsAll = false;
                    $('#selectChoices :checked').each(function() {
                    	selectedChoice.push($(this).attr("id"));
                      });
                    // ------------- creating choice content blocks ------------
                    if ($('#showAllChoices').is(':checked')) {
                        showsAll = true;
                    }
                    var formData = new FormData();
                    formData.append('selectedChoices', selectedChoice);
                    formData.append('showsAll', showsAll);
                    $.ajax({
                        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/choice/content?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
                        type: 'POST',
                        cache       : false,
                        contentType : false,
                        processData : false,
                        data: formData,
                        enctype: 'multipart/form-data',
                        success: function(data) {
                            var choiceblock = $('<div id="'+ data['choiceBlock'].id +'" class="choiceDiv tab row" style="display:block;">');
                            if (data['choiceBlock'].showsAll == false){
                                $.each(data['selectedSequences'], function(index, sequence) {
                                    choiceblock.append('<a style="color:var(--primary);  display:block;" href="/vspace/staff/module/[(${module.id})]/sequence/'+sequence.id+'">'+sequence.name+'</a>');
                        	});
                            }else{
                            	$(function() {
                                    var links = $("#choiceSpaceData a").map(function(e) {
                                        text = '<a style="color:var(--primary); display:block;" href='+this.href+'>'+this.name+'</a>';
                                        return text;
                                    }).get();
                                    $(links).each(function(index, choice) {
                                        choiceblock.append(choice);
                                    });
                               });
                            }
                            choiceblock.append('<input type="hidden" class="col-md-8" id="deleteChoiceBlockId" value="'+ data['choiceBlock'].id +'"><a class="btn deleteChoiceBlock col-md-1" href="javascript:;" style="position: absolute; right: 0; top: 0;"><span class="icon-trash error"></span></a></div>')
                        	$(choiceblock).css({
                                'display': "block"
                            });
                            $('#slideSpace').append(choiceblock);
                        },
                        error: function(data) {
                            var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                            $('.error').append(alert);
                        }
                    });
                    $('#choiceForm')[0].reset();
                });
            
                
                function updateTextBox(blockId, text) {
                    // clear text box and buttons
                    $(".open").empty();
                    $(".open").append('<p class="col-md-10">'+text+'</p><input type="hidden" id="deleteTextId" value="'+blockId+'" /><a class="btn deleteText col-md-1" href="javascript:;" style="position: absolute; right:0;"><span class="icon-trash error"></span></a>');
                    // reset border of the card
                    //rebind event handlers
                    $('.textDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
                    //resetting the height and overflow-y so that the TextBlock doesn't expand
                    $('.textDivStaff').css('height', 'auto');
                    $('.textDivStaff').css('overflow-y', 'visible');
                    $(".open").css('display', 'flex');
                    // remove id from storage so its not there on refresh
                    $(".open").removeClass("open");
                }
                
                // must add the event to the document since the buttons are added dynamically
                $('#cancelTextBlock').on('click',function(){
                	$("#editTextAlert").hide();
                	var blockId = $(this).closest(".open").attr("id");
                	updateTextBox(blockId, defaultValue);
                });

		function updateBiblioBox(blockId, formData) {
			// clear biblio box and buttons
			$(".open").empty();
			$(".open").append('<p class="col-md-10">Bibliography Title: <span>' + formData.get('biblioTitle')+ '</span>, Description: <span>' + formData.get('description')
					+ '</span></p><input type="hidden" id="deleteBiblioId" value="'+blockId+'" /><a class="btn deleteBiblio col-md-1" href="javascript:;" style="position: absolute; right:2.3%;"><i style="color: var(--error);" class="icon-trash error"></i></a>');

			$(".open").append('<div id="referenceSpace" class="col-md-10">'+formData.get('refListDiv')) + '</div>';

			//reset border of the card
			//rebind event handlers
			$('.biblioDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
			$(".open").css('display', 'flex');
			// remove id from storage so its not there on refresh
			$(".open").removeClass("open");
		}

		// must add the event to the document since the buttons are added dynamically
		$('#cancelBiblioBlock').on('click',function(){
			$('#currentBiblioId').remove();
			$("#editBiblioAlert").hide();
			var blockId = $(".open").attr("id");
			updateBiblioBox(blockId, formDataCancel);
		});

		function updateReferenceBox(blockId, refContent) {
			// clear biblio box and buttons
			$(".open").empty();
			$(".open").append('<p class="col-md-10">' + refContent 
					+ '</p><input type="hidden" id="deleteReferenceId" value="'+blockId+'" /><a class="btn deleteReference col-md-1" href="javascript:;"> <span class="icon-trash error"></span></a>');

			//reset border of the card
			//rebind event handlers
			$('.referenceDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
			$(".open").css('display', 'flex');
			// remove id from storage so its not there on refresh
			$(".open").removeClass("open");
		}

	 	// must add the event to the document since the buttons are added dynamically
		$('#cancelRefBlock').on('click',function(){
			$('#currentBiblioId').remove();
			$("#editReferenceAlert").hide();
			var refId = $(".open").attr("id");
			updateReferenceBox(refId, defaultValue);
		});
            
                $('.valueDiv').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
                $('.textDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
                $('.biblioDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
                $('.referenceDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);

            
                $("#submitTextBlock").on("click", function(e){
                	e.preventDefault();
                    // ------------- editting text content blocks ------------
                    
                    var formData = new FormData();
                    var text = markDown.value();
                    markDown.value('');
                    var formData = new FormData();
                    var blockId = $(".open").attr("id");
                    formData.append('textBlockDesc', text);
                    formData.append('textBlockId', blockId);
                	$("#editTextAlert").hide();
                    $.ajax({
                        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/text/edit?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
                        type: 'POST',
                        cache       : false,
                        contentType : false,
                        processData : false,
                        data: formData,
                        enctype: 'multipart/form-data',
                        success: function(data) {
                            // replace text box with new description
                           updateTextBox(blockId, text)
                           $(".open").removeClass("open");
                       },
                       error: function(data) {
                    		if (data.status == 403) {
                       			$("#loginAlert").show();
                       		}
                       		else {
                           		var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                           		$('.error').append(alert);
                       		}
                       }
                   });
                });    
    
	    $("#submitBiblioBlock").on("click", function(e){
			e.preventDefault();
		// ------------- editting Bibliography content blocks ------------

		var formData = new FormData();
		var title = $("#editTitleBiblio").val();
		var desc = $("#editDescBiblio").val();
		var blockId = $(".open").attr("id");
		formData.append('biblioTitle', title);
		formData.append('description', desc);
		formData.append('id', blockId);

		$("#editBiblioAlert").hide();

		var object = {};
		formData.forEach((value, key) => object[key] = value);
		var jsonData = JSON.stringify(object);

		var refListDiv = $(".open div:eq(0)").html();
		formData.append('refListDiv', refListDiv);
		$.ajax({
		    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/biblio/'})]" + blockId + ['/edit'],
		    type: 'POST',
		    cache       : false,
		    contentType : 'application/json; charset=utf-8',
		    processData : false,
		    headers: {
			'X-CSRF-Token': [[${_csrf.token}]] 
			},
		    data: jsonData,
		    success: function(data) {
			//replace Biblio box with new values
			updateBiblioBox(blockId, formData)
			$(".open").removeClass("open");
			var alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert"><p>Bibliography Successfully Updated!</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
				$('.errorMsg').append(alert);
			$(".errorMsg").delay(4000).slideUp(500, function(){
				$(".errorMsg").empty();
			});
		   },
		   error: function(data) {
		       if (data.status == 403) {
			   $("#loginAlert").show();
		       }
		       else {
			   var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
			   $('.errorMsg').append(alert);
		       }
		   }
	       });
	    });

	    $("#submitRefBlock").on("click", function(e){
			e.preventDefault();
			// ------------- editting Ref blocks ------------

			var formData = new FormData();
			var title = $("#editTitleRef").val();
			var author = $("#editAuthorRef").val();
			var year = $("#editYearRef").val();
			var journal = $("#editJournalRef").val();
			var url = $("#editUrlRef").val();
			var volume = $("#editVolumeRef").val();
			var issue = $("#editIssueRef").val();
			var pages = $("#editPagesRef").val();
			var editors = $("#editEditorsRef").val();
			var type = $("#editTypeRef").val();
			var note = $("#editNoteRef").val();
			var refBlockId = $(".open").attr("id");

			formData.append('title', title);
			formData.append('author', author);
			formData.append('year', year);
			formData.append('journal', journal);
			formData.append('url', url);
			formData.append('volume', volume);
			formData.append('issue', issue);
			formData.append('pages', pages);
			formData.append('editors', editors);
			formData.append('type', type);
			formData.append('note', note);

			$("#editReferenceAlert").hide();
			var biblioBlockId = $('#currentBiblioId').attr('value');

			var object = {};
			formData.forEach((value, key) => object[key] = value);
			var jsonData = JSON.stringify(object);

			$.ajax({
				url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/biblio/'})]" + biblioBlockId + ['/reference/'] + refBlockId + ['/edit'],
				type: 'POST',
				cache       : false,
				contentType : 'application/json; charset=utf-8',
				processData : false,
				headers: {
					'X-CSRF-Token': [[${_csrf.token}]] 
				},
				data: jsonData,
				success: function(data) {
					//replace Reference box with new values
					updateReferenceBox(refBlockId, data.refDisplayText);
					$(".open").removeClass("open");
					var alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert"><p>Reference Successfully Updated!</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
					$('.errorMsg').append(alert);
					$(".errorMsg").delay(4000).slideUp(500, function(){
						$(".errorMsg").empty();
					});
				},
				error: function(data) {
					if (data.status == 403) {
						$("#loginAlert").show();
					}
					else {
						var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
						$('.errorMsg').append(alert);
					}
				 }
			 });
		});

                $("#imageId").select2({
            		ajax: {
            		    url: function (params) {
            		  		var imageURL = [[@{|/staff/images/search|}]];
            		  		return imageURL;
            		    },
            		    dataType: 'json',
            		    processResults: function (data) {
            		        return {
            		          results: data,
            		        };
            		      },
            		},
            		templateResult: formatImage,
            		templateSelection: formatSelection
                });
                
                function formatImage (image) {
                	if (!image.id) {
                		return image.text;
                	}
                	var tbaseUrl = [[@{|/api/image/|}]];
                	var $image = $(
                			'<span><img src="' + tbaseUrl + image.id + '" class="img-thumbnail" /> ' + image.text + '</span>'
                	);
                	return $image;
                };
                
                function formatSelection(image) {
                	if (!image.id) {
                        return image.text;
                    }
                	var tbaseUrl = [[@{|/api/image/|}]];
                    var $image = $(
                            '<span>' + image.text + '</span>'
                    );
                    $("#selectedImage").empty();
                    $("#selectedImage").append('<img width="200px" src="' + tbaseUrl + image.id + '" class="img-thumbnail" />');
                    return $image;
                }
            });
            
            $(window).on('load', function () {	
            	var divWindow = $(".valueDiv");
            	$(".deleteText").css('position', 'absolute');
            	$(".deleteText").css('right', '0');
            	var images = $(".imgDiv");
            	resizeImage(images);
            	
            	function resizeImage(images) {
            		for(var i =0; i < images.length; i++) {
            			if (images[i].width > divWindow.width() || images[i].width >= 800) {
            				$(".valueDiv").find("#"+images[i].id).css("width", 800);
            				images[i].width = 800;
            			} else {
            				$(".valueDiv").find("#"+images[i].id).css("width", images[i].width);
            			}
            		}
            	}
            });
            
        </script>
    </head>
    <body>
        <div class="main-content" layout:fragment="content">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a th:href="@{/staff/dashboard}">Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a th:href="@{/staff/module/list}">Modules</a>
                </li>
                <li class="breadcrumb-item">
                    <a th:href="@{'/staff/module/'+${module.id}}">[[${module.name}]]</a>
                </li>
                <li class="breadcrumb-item" th:each="slideSequence: ${slideSequences}">
                    <a th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${slideSequence.id}}" th:name="${slideSequence.name}">[[${slideSequence.name}]]</a>
                </li>
                <li class="breadcrumb-item active">[[${slide.name}]]</li>
            </ol>
            <div class="errorMsg"></div>
            <div class="dropdown" style="float: right;" th:if="${#strings.equals(slide['class'].simpleName,'BranchingPoint')}">
                <button class="btn branchbtn dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="icon-branch"></span> This Branching Point links to the following Sequences
                </button>
                <div id="choiceSpaceData" class="dropdown-menu" aria-labelledby="dropdownMenu2">
                    <a  th:each="choice: ${choices}" class="dropdown-item" 
                        th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${choice.sequence.id}}"
                        th:name="${choice.sequence.name}" style="color:var(--primary);">[[${choice.sequence.name}]]</a>
                </div>
            </div>
            <div style="display: flex">
                <div style="margin-right: 20px">
                    <h2 class="heading"><span style="color: var(--dark-grey);">Slide:</span> [[${slide.name}]]</h2>
                    <p id="description">[[${slide.description}]]</p>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-dark" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span class="icon-caret-down" style="font-size: 16px"></span>
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" data-toggle="tooltip" data-html="true" data-placement="top" 
                            th:title="|Created on <span class='date'>${slide.creationDate}</span> by ${slide.createdBy}|"><span class="icon-info-circle"></span>&emsp; Slide info</a>
                        <a class="dropdown-item" th:href="@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/edit'}">
                        <span class="icon-edit"></span>&emsp; Edit slide</a>
                        <a class="dropdown-item" style="cursor: pointer" th:onclick="guidedTour()"><span class="icon-map"></span>&emsp; Start tour</a>
                    </div>
                </div>
            </div>
            <div style="margin: 40px 0 20px; width: fit-content" class="content-btns">
                <button type="button" id="addText" class="btn pill-btn" data-toggle="tooltip" title="Add Text Block" data-placement="top">
                +&nbsp;<span class="icon-text"></span></button>&nbsp;
                <button type="button" id="addImage" class="btn pill-btn" data-toggle="tooltip" title="Add Image" data-placement="top">
                +&nbsp;<span class="icon-image"></span></button>&nbsp;
                <button type="button" id="addBibliography" class="btn pill-btn" data-toggle="tooltip" title="Add Bibliography block" data-placement="top">
        		+&nbsp;<span class="icon-book-open-alt"></span></button>&nbsp;
                <button type="button" id="addChoice" style="display: none;" class="btn pill-btn" data-toggle="tooltip" title="Add Sequence Choice" data-placement="top">
                +&nbsp;<span class="icon-checkmark"></span></button>
            </div>
            <p style="margin-top: 0.5rem;">Double Click on a Block to Edit it</p>
            <!-- Delete Text Modal -->
            <div id="confirmDeleteTextAlert" class="modal" tabindex="-1"
                role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h6>Are you sure you want to delete this
                                text block?
                            </h6>
                        </div>
                        <div class="modal-footer">
                            <button id="cancelDeleteText" type="reset"
                                class="btn light">Cancel</button>
                            <button type="submit" id="deleteText"
                                class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            
	    <!-- Delete Bibliography Modal -->
	    <div id="confirmDeleteBiblioAlert" class="modal" tabindex="-1"
		role="dialog" th:draggable="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Confirm Delete</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<h6>Are you sure you want to delete this bibliography block?</h6>
				</div>
				<div class="modal-footer">
					<button id="cancelDeleteBiblio" type="reset" class="btn light">Cancel</button>
					<button type="submit" id="deleteBiblio" class="btn btn-primary">Submit</button>
				</div>
			</div>
		</div>
	    </div>

	    <!-- Delete Reference Modal -->
	    <div id="confirmDeleteRefAlert" class="modal" tabindex="-1"
		role="dialog" th:draggable="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Confirm Delete</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<h6>Are you sure you want to delete this reference?</h6>
				</div>
				<div class="modal-footer">
					<button id="cancelDeleteReference" type="reset" class="btn light">Cancel</button>
					<button type="submit" id="deleteReference" class="btn btn-primary">Submit</button>
				</div>
			</div>
		</div>
	    </div>
		
            <!-- Delete Image Modal -->
            <div id="confirmDeleteImageAlert" class="modal" tabindex="-1"
                role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h6>Are you sure you want to delete this
                                image block?
                            </h6>
                        </div>
                        <div class="modal-footer">
                            <button id="cancelDelete" type="reset"
                                class="btn light">Cancel</button>
                            <button type="submit" id="deleteImage"
                                class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Delete ChoiceBlock Modal -->
            <div id="confirmDeleteChoiceBlockAlert" class="modal"
                tabindex="-1" role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h6>Are you sure you want to delete this
                                choices Block?
                            </h6>
                        </div>
                        <div class="modal-footer">
                            <button id="cancelDeleteChoiceBlock"
                                type="reset" class="btn light">Cancel</button>
                            <button type="submit" id="deleteChoiceBlock"
                                class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="addTextAlert" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document" th:draggable="true">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add new Text Block</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="textForm" id="textUploadForm"
                            enctype="multipart/form-data" method="post">
                            <div class="modal-body">
                                <h6>
                                    <small>Enter Text: </small>
                                </h6>
                                <textarea class="form-control"
                                    id="textBlockText" rows="3"></textarea>
                            </div>
                            <div class="modal-footer">
                                <button id="cancelSubmitText" type="reset"
                                    class="btn light">Cancel</button>
                                <button type="submit" id="submitText"
                                    class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="editTextAlert" class="modal" tabindex="-1"
                role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Text Block</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="textForm" id="textEditUploadForm"
                            enctype="multipart/form-data" method="post">
                            <div class="modal-body">
                                <h6>
                                    <small>Edit Text: </small>
                                </h6>
                                <textarea class="form-control"
                                    id="editTextBlock" rows="3"></textarea>
                            </div>
                            <div class="modal-footer">
                                <button id="cancelTextBlock" type="reset"
                                    class="btn light">Cancel</button>
                                <button type="submit" id="submitTextBlock"
                                    class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="addImgAlert" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document" th:draggable="true">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add new Image Block</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="photoForm" id="imageUploadForm"
                            enctype="multipart/form-data" method="post">
                            <div class="modal-body">
                                <input type="radio" id="chooseFromLocal" name ="uploadRadioBtn" checked/>
                                <h6>
                                    <small>Upload Image: </small>
                                </h6>
                                <input class="form-control" type="file"
                                    name="file" rows="5" cols="500"
                                    id="file" />
                                <input type="radio" id="chooseFromExisting" name ="uploadRadioBtn" />       
                                <div>
                                    <h6>
                                        <small>Or choose an existing image: </small>
                                    </h6>
                                    <select id="imageId" name="imageId"
                                        class="form-control-xs target"
                                        style="height: 50px; width: 200px;">
                                        <option selected value="">Choose from existing</option>
                                    </select>
                                </div>
                                <div>
                                    <span id="selectedImage" width="200px"></span>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button id="cancelImageBtn" type="reset"
                                    class="btn light">Cancel</button>
                                <button type="submit" id="uploadImage"
                                    class="btn btn-primary" data-value="">Upload
                                Image</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
		
	    <div id="addBiblioAlert" class="modal" tabindex="-1" role="dialog" style="overflow-y: scroll;">
		<div class="modal-dialog" role="document" th:draggable="true">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Add new Bibliography Block</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<form name="sendBiblioForm" id="sendBiblioForm">
					<div class="modal-body">
						<div class="form-group row">
						<label for="name" class="col-md-3 col-form-label">Title: </label>
						<input type="text" class="form-control col-md-8"
										id="titleBiblio" name="titleBiblio" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Description: </label>
									<textarea rows="3" class="form-control col-md-8"
										id="descriptionBiblio" name="descriptionBiblio" ></textarea>
						</div>

					</div>
					<div class="modal-footer">
						<button id="cancelSubmitBiblio" type="reset" class="btn light">Cancel</button>
						<button type="submit" id="submitBiblio" class="btn btn-primary">Submit</button>
					</div>
				</form>
			</div>
		</div>
	    </div>
		
	    <div id="addReferenceAlert" class="modal" tabindex="-1" role="dialog" style="overflow-y: scroll;">
		<div class="modal-dialog" role="document" th:draggable="true">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Add new Reference</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<form name="sendReferenceForm" id="sendReferenceForm">
					<div class="modal-body">
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Type:</label>
							<select class="form-control col-md-8" name="referenceType" id="typeRef">
						     <option th:each="refType: ${referenceTypes}" th:value="${refType}"
						     th:selected="${referenceTypes[0]}">
								[[${@environment.getProperty('reference_type_' + refType)}]]
						     </option>
						</select>
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Title:</label>
							<input type="text" class="form-control col-md-8" id="titleRef" name="titleRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Author:</label>
							<input type="text" class="form-control col-md-8" id="authorRef" name="authorRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Year:</label>
							<input type="text" class="form-control col-md-8" id="yearRef" name="yearRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Journal:</label>
							<input type="text" class="form-control col-md-8" id="journalRef" name="journalRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Url:</label>
							<input type="text" class="form-control col-md-8" id="urlRef" name="urlRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Volume:</label>
							<input type="text" class="form-control col-md-8" id="volumeRef" name="volumeRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Issue:</label>
							<input type="text" class="form-control col-md-8" id="issueRef" name="issueRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Pages:</label>
							<input type="text" class="form-control col-md-8" id="pagesRef" name="pagesRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Editors:</label>
							<input type="text" class="form-control col-md-8" id="editorsRef" name="editorsRef" />
						</div>
						
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Note:</label>
							<input type="text" class="form-control col-md-8" id="noteRef" name="noteRef" />
						</div>
					</div>
					<div class="modal-footer">
						<button id="cancelSubmitReference" type="reset" class="btn light">Cancel</button>
						<button type="submit" id="submitReference" class="btn btn-primary">Submit</button>
					</div>
				</form>
			</div>
		</div>
	    </div>

	    <div id="editBiblioAlert" class="modal" tabindex="-1" role="dialog" style="overflow-y: scroll;">
		<div class="modal-dialog" role="document" th:draggable="true">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Edit Bibliography Block</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<form name="sendBiblioForm" id="sendEditBiblioForm">
					<div class="modal-body">
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Title:</label>
							<input type="text" class="form-control col-md-8" id="editTitleBiblio" name="editTitleBiblio" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Description:</label>
							<textarea type="text" rows="3" class="form-control col-md-8" id="editDescBiblio" name="editDescBiblio" ></textarea>
						</div>
					</div>
					<div class="modal-footer">
						<button id="cancelBiblioBlock" type="reset" class="btn light">Cancel</button>
						<button type="submit" id="submitBiblioBlock"
							class="btn btn-primary">Submit</button>
					</div>
				</form>
			</div>
		</div>
	    </div>

	    <div id="editReferenceAlert" class="modal" tabindex="-1" role="dialog" style="overflow-y: scroll;">
		<div class="modal-dialog" role="document" th:draggable="true">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">Edit Reference</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<form name="sendReferenceForm" id="sendEditReferenceForm">
					<div class="modal-body">
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Type:</label>
							<select class="form-control col-md-8" name="editTypeRef" id="editTypeRef">
						     <option th:each="refType: ${referenceTypes}" th:value="${refType}"
							th:selected="${referenceTypes[0]}">
								[[${@environment.getProperty('reference_type_' + refType)}]]
						     </option>
						</select>
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Title:</label>
							<input type="text" class="form-control col-md-8" id="editTitleRef" name="ediTitleRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Author:</label>
							<input type="text" class="form-control col-md-8" id="editAuthorRef" name="editAuthorRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Year:</label>
							<input type="text" class="form-control col-md-8" id="editYearRef" name="editYearRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Journal:</label>
							<input type="text" class="form-control col-md-8" id="editJournalRef" name="editJournalRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Url:</label>
							<input type="text" class="form-control col-md-8" id="editUrlRef" name="editUrlRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Volume:</label>
							<input type="text" class="form-control col-md-8" id="editVolumeRef" name="editVolumeRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Issue:</label>
							<input type="text" class="form-control col-md-8" id="editIssueRef" name="editIssueRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Pages:</label>
							<input type="text" class="form-control col-md-8" id="editPagesRef" name="editPagesRef" />
						</div>
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Editors:</label>
							<input type="text" class="form-control col-md-8" id="editEditorsRef" name="editEditorsRef" />
						</div>
						
						<div class="form-group row">
							<label for="name" class="col-md-3 col-form-label">Note:</label>
							<input type="text" class="form-control col-md-8" id="editNoteRef" name="editNoteRef" />
						</div>
					</div>
					<div class="modal-footer">
						<button id="cancelRefBlock" type="reset" class="btn light">Cancel</button>
						<button type="submit" id="submitRefBlock"
							class="btn btn-primary">Submit</button>
					</div>
				</form>
			</div>
		</div>
	    </div>

            <div id="loginAlert" class="modal" tabindex="-1" role="dialog"
                backdrop="static"
                style="display: none; background-color: rgba(0, 0, 0, 0.5);">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Login</h5>
                        </div>
                        <div class="modal-body">
                            <h6>You are not logged in, please login.</h6>
                        </div>
                        <div class="modal-footer">
                            <a class="btn btn-primary" style="color: white;"
                                onClick="window.location.reload();">Login</a>
                        </div>
                    </div>
                </div>
            </div>

            <div id="addChoiceAlert" class="modal" tabindex="-1"
                role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select from the
                                Choices
                            </h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="choiceForm" id="choiceForm"
                            enctype="multipart/form-data" method="post">
                            <div id="choiceDiv" class="modal-body">
                                <input class="choiceOptions"
                                    id="showAllChoices" type="checkbox"
                                    name="showAll" value="showAll"
                                    checked="true" /> <label for="showAll">Always
                                show all choices</label><br />
                                <div id="selectChoices">
                                    <div th:each="choice: ${choices}">
                                        <input class="choiceOptions"
                                            th:id="${choice.id}"
                                            type="checkbox"
                                            th:name="${choice.sequence.name}"
                                            th:value="${choice.sequence.name}" />
                                        <label th:for="${choice.id}">[[${choice.sequence.name}]]</label>
                                        <br />
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button id="cancelSubmitChoice" type="reset"
                                    class="btn light">Cancel</button>
                                <button type="submit" id="submitChoices"
                                    class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="slideSpace">
                <div th:each="contents: ${slideContents}">
                    <div th:id="${contents.id}" class="valueDiv tab row" th:if="${#strings.equals(contents['class'].simpleName,'ImageBlock')}">
                        <img th:id="${contents.id}" class="imgDiv" th:src="@{'/api/image/'+${contents.image.id}}" />
                        <input type="hidden" id="deleteImageId" th:value="${contents.id}"> 
                        <a class="btn deleteImage col-md-1" href="javascript:;" style="position:absolute; right:25px;"> 
                        <span class="icon-trash error"></span>
                        </a>
                    </div>
                    <div style="word-break:break-word;" th:id="${contents.id}" class="textDivStaff tab row" th:if="${#strings.equals(contents['class'].simpleName,'TextBlock')}">
                        <p class="col-md-10"> [[${contents.text}]]</p>
                        <input type="hidden" id="deleteTextId" th:value="${contents.id}" />
                        <a class="btn deleteText col-md-1" href="javascript:;"> 
                        <span class="icon-trash error"></span>
                        </a>
                    </div>
                    <div th:id="${contents.id}" class="biblioDivStaff tab row"
				th:if="${#strings.equals(contents['class'].simpleName,'BiblioBlock')}">
				<p class="col-md-10">
					Bibliography Title: <span>[[${contents.biblioTitle}]]</span>, Description: <span>[[${contents.description}]]</span>
				</p>
				<input type="hidden" id="deleteBiblioId" th:value="${contents.id}" />
				<a class="btn addReference col-md-1" style="padding-top: 8px;" data-toggle="tooltip" title="Add Reference"><span
					class="icon-circle-add"></span></a>
				<a class="btn deleteBiblio col-md-1" href="javascript:;"> <span
					class="icon-trash error"></span>
				</a>

				<div id="referenceSpace" class="col-md-10">
					<div th:each="contentRef: ${contents.references}">
						<div th:id="${contentRef.id}" class="referenceDivStaff row" style="padding-left: 25px;">
							<p class="col-md-10" th:text='${@referenceDisplayDefault.getReferenceDisplayText(contentRef)}'></p>
							<input type="hidden" id="deleteReferenceId" th:value="${contentRef.id}" />
							<a class="btn deleteReference col-md-1" href="javascript:;"> <span
								class="icon-trash error"></span>
							</a>
						</div>
					</div>
				</div>
		    </div>
                    <div th:id="${contents.id}" class="choiceDiv tab row" th:if="${#strings.equals(contents['class'].simpleName,'ChoiceBlock')}" style="display:block;">
                        <a th:if="${contents.showsAll}" th:each="choice: ${choices}" style="display:block; color: var(--primary);"
                            th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${choice.sequence.id}}">[[${choice.sequence.name}]]</a>
                        <a th:if="!${contents.showsAll}" th:each="choice: ${contents.choices}" style="display:block; color: var(--primary);"
                            th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${choice.sequence.id}}">[[${choice.sequence.name}]]</a>
                        <input type="hidden" class="col-md-8" id="deleteChoiceBlockId" th:value="${contents.id}"> 
                        <a class="btn deleteChoiceBlock col-md-1" href="javascript:;" style="position:absolute; right:0; top: 0;">
                        <span class="icon-trash error"></span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
