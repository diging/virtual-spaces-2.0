<html layout:decorate="~{layouts/main_staff}">
    <head>
        <link rel="stylesheet"
            href="https://unpkg.com/easymde/dist/easymde.min.css">
        <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
		<script th:src="@{/resources/jquery/jquery-ui.min_custom_sortable.js}"></script>
		<script src="//use.fontawesome.com/releases/v5.8.1/js/all.js"
    	data-auto-replace-svg="nest"></script>
        <style type="text/css">
            .hova {
            background-color: #f2f2f2;
            }
            .EasyMDEContainer .CodeMirror-wrap{
            overflow-y: scroll;
            height: 400px;
            }
            .fixed {
		    position: fixed;
		    top:0; left:0;
		    width: 100%;
		    z-index:100;
     		}
     		
     		li.active>a{
			background: solid var(--primary);
			color: #fff;
			font-size: 15px;
			}
			
			a.nav-link.active.show {
			border-color: transparent;
			border-bottom: 4px solid var(--primary);
			color: var(--primary) !important;
			background: transparent;
			}
			
			
        </style>
        <script th:inline="javascript">
            //# sourceURL=click.js
            var contentCount = [[${#lists.size(slideContents)}]];
            var markDown = null;
            var defaultValue;
            var addVideoClk=0;
            var editVideoClk=0;
            $(window).on("load", function() {
                $( window ).resize(function() {
                    drawLinks();
                });
                drawLinks();
            });
            //store where a user clicked on an image
            var storeX;
            var storeY;
            var selectedModuleLinkId;
            var selectedSpaceLinkId;
            var selectedExternalLinkId;
            var selectedTextBlockId;
            const displaceUnpublishedOnX = 25;
            const displaceUnpublishedOnY = 13;
            const displaceUnpublishedOnXModal = 50;
            const displaceUnpublishedOnYModal = 13;
            const displaceLableOnX = 10;
            const displaceLableOnY = 35;
            var modalBgImageHeight;
            var modalBgImageWidth;
            
            var externalLinkIconReader = new FileReader();
            var externalLinkIcon;
            externalLinkIconReader.onload = function(e) {
                externalLinkIcon = e.target.result;
                showExternalLinks(createExternalLinkInfo());
            }

            
            $(function () {
            	  $('[data-toggle="tooltip"]').tooltip()
            });
            
            $(window).scroll(function(){
            	  var sticky = $('.sticky'),
            	      scroll = $(window).scrollTop();
            	  if (scroll >= 100) sticky.addClass('fixed');
            	  else sticky.removeClass('fixed');
            });
            
            function createImageBlock(reader, width) {
                var imageblock = $('<div id="current" class="valueDiv tab row"><img src="#" style="imgDiv tab row"/><input type="hidden" id="deleteImageId" /><a class="btn deleteImage col-md-1" href="javascript:;" style="position:absolute; right:25px;"><span class="icon-trash error"></span></a></div>');
                imageblock.find('img').attr('src', reader.result);
                if(width > 800)
                	imageblock.find('img').attr('width', '800px');
                return imageblock;
            }
            
            function createImageBlockWithExistingImage(src, width) {
                var imageblock = $('<div id="current" class="valueDiv tab row"><img src="#" style="imgDiv tab row"/><input type="hidden" id="deleteImageId" /><a class="btn deleteImage col-md-1" href="javascript:;" style="position:absolute; right:25px;"><span class="icon-trash error"></span></a></div>');
                imageblock.find('img').attr('src', src);
                if(width > 800)
                	imageblock.find('img').attr('width', '800px');
                return imageblock;
            }
            
            function createVideoBlock(reader, videoSrc, title,isUrlProvided) {
                var videoBlock = $("<div></div>");
                videoBlock.attr('id',"currentVideo");
                videoBlock.attr('class',"tab vidDiv row");
                videoBlock.css('border','1px solid rgba(0, 0, 0, 0.125)');
                var innerDiv1 = $("<div></div>");
                var heading = $("<h3></h3>");
                heading.append($("<strong></strong>"));
                innerDiv1.append(heading);
                if (isUrlProvided) {
                	var iframe = $("<iframe></iframe>");
                	iframe.attr('width',"800");
                	iframe.attr('height',"530");
                	iframe.attr('src',videoSrc);
                	iframe.attr('frameborder',"0");
                	iframe.attr('allow',"accelerometer; clipboard-write; encrypted-media;gyroscope; picture-in-picture");
                	iframe.attr('allowFullScreen', '');
                	innerDiv1.append(iframe);
                }else{
                	var video = $("<video></video>");
                	video.attr('width',"800");
                	video.attr('height',"530");
                	video.attr('controls', true);
                	var source = $("<source></source>");
                	source.attr('src', videoSrc);
                	source.attr('type',"video/mp4");
                	video.append(source);
                	innerDiv1.append(video);
                }
                videoBlock.append(innerDiv1);
                var anchor1 = $("<a></a>");
                anchor1.attr('href',"javascript:;");
                anchor1.attr('class',"btn deleteVideo col-md-1");
                anchor1.attr('data-video-id',"");
                anchor1.css('position','absolute');
                anchor1.css('right','25px');
                var span1 = $("<span></span>");
                span1.attr('class',"icon-trash error");
                anchor1.append(span1);
                videoBlock.append(anchor1);
                var anchor2 = $("<a></a>");
                anchor2.attr('href',"javascript:;");
                anchor2.attr('class',"btn editVideo col-md-1");
                anchor2.attr('data-editvideo-id',"");
                anchor2.css('position','absolute');
                anchor2.css('top','60px');
                anchor2.css('right','25px');
                var span2 = $("<span></span>");
                span2.attr('class',"icon-edit");
                anchor2.append(span2);
                videoBlock.append(anchor2);
                videoBlock.find('h3 strong').html(title);
                return videoBlock;
            }
            
            function onMouseEnter(e){
                var target = $( e.target );
               
                $(".hova").removeClass("hova");
                $(e.target).addClass("hova");
                // This is needed to prevent only the p tag from being highlighted
                if(target.is('p')){
                    $(e.target).parent().addClass("hova");
                }
                //prevent normal hover actions
                e.preventDefault();
            }
            function onMouseLeave(e) {
                $(this).removeClass("hova");
            }
            
            function onDoubleClick(e){
                // get to the nearest divs class attribute
                $(".EasyMDEContainer").remove();
                var divName = $(e.target).closest('div').attr('class');
                //if the div is a text content block 
                if(divName.includes("textDivStaff")){
                	$(e.target).closest('.textDivStaff').addClass("open");
                    var description = $("div.open p:eq(0)").text();
                	defaultValue = description;
            
                    $("#editTextAlert").show();
                    markDown = new EasyMDE({element: $('#editTextBlock')[0]});
                    markDown.value(description.trim());
                    //remove card border
                    $(".open").css('display', 'none');
                    $(".open").css('overflow-y', 'scroll');
                    $(".open").css('height', '400px');
                } else {
                	// store image ID selected by the user to replace, onDoubleClick
                	var imgBlockID = $(e.target).attr('id'); 
                	if(imgBlockID != ''){
                    	$("#uploadImage").data('value', imgBlockID); // sets image ID value
                    	$("#addImgAlert").show();
                	}
            	
                }
            }
                
            function uploadImage() {
            	var imgBlockID = $("#uploadImage").data('value') // gets image ID
            	var file = $('#file')[0].files[0];
            	var reader  = new FileReader();
            	var formData = new FormData();
            	var chooseFromExisting = true;
            	if (typeof(file) != "undefined"){
            		chooseFromExisting = false;
            		formData.append('file', file);
            	}
            	var imageSource = $('#selectedImage').find('img').attr('src');
            	var imageId = "";
            	if(typeof(imageSource) != "undefined"){
            		imageId = imageSource.split("/").pop().split(".")[0];
            	}
            	var imageblock = "";
            	var oldImageBlock = "";
            			    
            	// Ashmi changes for Story VSPC-64
            			    
            	// checks if image ID is present to replace
            	if (imgBlockID != '') {
            			oldImageBlock = $("#" + imgBlockID);
            			var imageBlockId = imgBlockID;
            			formData.append('imageBlockId',imageBlockId);
            			var url = "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/image/'})]" + imageBlockId + '?[(${_csrf.parameterName})]=[(${_csrf.token})]';
            			if(!chooseFromExisting){
            				reader.onload = function (theFile)
            				{
            					var image = new Image();
            					image.src = theFile.target.result;
            					image.onload = function ()
            					{
            						imageblock = createImageBlock(reader, this.width);
            						$("#" + imageBlockId).replaceWith(imageblock);	
            						$(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
            					};
            				}
            			}
            			else{
            				var image = new Image();
            				image.src = $('#selectedImage').find('img').attr('src');
            				formData.append('imageId',imageId);
            				imageblock = createImageBlockWithExistingImage($('#selectedImage').find('img').attr('src'),image.width);
            				$("#" + imageBlockId).replaceWith(imageblock);	
            				$(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
            			}
            			// Reset data-attribute to get current selected image ID
            			$("#uploadImage").data('value', '');
            	}
            	else {
            		var url = "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/image/?'+${_csrf.parameterName}+'='+${_csrf.token}})]";
            		if(!chooseFromExisting){
            			reader.onload = function (theFile) 
            			{        	
            			var image = new Image();
            			image.src = theFile.target.result;
            			image.onload = function() 
            			{
            				imageblock = createImageBlock(reader, this.width);  
            				$('#slideSpace').append(imageblock); 
            				$(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
            			};          
            			} 
            		}
            		else
            		{
            			var image = new Image();
            			image.src = $('#selectedImage').find('img').attr('src');
            			formData.append('imageId',imageId);
            			imageblock = createImageBlockWithExistingImage($('#selectedImage').find('img').attr('src'),image.width);  
            			$('#slideSpace').append(imageblock); 
            			$(imageblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
            		}
            	}
            	if (!chooseFromExisting)
            	{
            		reader.readAsDataURL(file)
            	}
            	$.ajax({
            		enctype: 'multipart/form-data',
            		// ------------- creating image content blocks ------------
            		url: url,
            		type: 'POST',
            		cache       : false,
            		contentType : false,
            		processData : false,
            		data: formData,    
            		success: function(data) {
            			$(".open").removeClass("open");
            			var img = imageblock.find('img');
            			if(data != ''){
            				img.attr('id', data);
            				$("#current").find('#deleteImageId').val(data);
            				$("#current").attr('id', data);
            			}
            			else{
            				img.attr('id', imgBlockID);
            				$("#current").find('#deleteImageId').val(imgBlockID);
            				$("#current").attr('id', imgBlockID);
            			}
            		},
            		error: function(data) {
            		if (imgBlockID == '') {
            			$("#current").remove();
            		}
            		else {
            			$("#current").replaceWith(oldImageBlock);
            		}
            		if (data.status == 403) {
            			$("#loginAlert").show();
            		}
            		}
            	});
            	// Reset the image file name 
            	$('#file').val('');
            	if(chooseFromExisting)
            	{
            		$("#selectedImage").empty();
            		$('#imageId').prop('selectedIndex',0).trigger( "change" );
            	}
            }
            
            function embedVideo() {
				var videoID = $("#saveVideo").data('value'); // gets video ID
				var oldUrl = $("#saveVideo").data('url');
				var url = $("#videoLink").val();
				var title = $("#videoTitle").val();
				var vidFile = $("#videoFile")[0].files[0];
				var reader = new FileReader();
				var videoBlock = "";
				var ajaxUrl = '';
				var oldVideoBlock = '';
				var formData = new FormData();
				if (url) {
					if(url.startsWith("https://www.youtube.com/watch?v="))
					{
						videoId = url.substring(url.indexOf("v=")+2);
						url = "https://www.youtube.com/embed/"+videoId;
					}
					formData.append('url', url);
					videoBlock = createVideoBlock(reader, url, title,true);
				}
				if (vidFile) {
					formData.append('videoFile', vidFile);
				}
				if (videoID) {
					oldVideoBlock = $("#" + videoID);
					ajaxUrl = "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/video/'})]" + videoID + '?[(${_csrf.parameterName})]=[(${_csrf.token})]';
					formData.append('videoBlockId', videoID);
					if (url) {
						$("#" + videoID).replaceWith(videoBlock);
					}
					if (vidFile) {
						reader.onload = function (theFile) {
							videoBlock = createVideoBlock(reader, theFile.target.result,title,false);
							$("#" + videoID).replaceWith(videoBlock);
						};
					}
				}
				else {
					if (url) {
						$('#slideSpace').append(videoBlock);
					}
					if (vidFile) {
						reader.onload = function (theFile) {
							videoBlock = createVideoBlock(reader, theFile.target.result,title,false);
							$('#slideSpace').append(videoBlock);
						}
					}
					ajaxUrl = "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/video?'+${_csrf.parameterName}+'='+${_csrf.token}})]";
				}
				// Reset data-attribute to get current selected image ID
				$("#videoFile").val('');
				$("#videoLink").val('');
				$(videoBlock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave);//.dblclick(onDoubleClick);
				if (vidFile) {
					reader.readAsDataURL(vidFile);
				}
				formData.append('videoTitle', title);
				$.ajax({
					enctype: 'multipart/form-data',
					// ------------- creating video content blocks ------------
					url: ajaxUrl,
					type: 'POST',
					cache: false,
					contentType: false,
					processData: false,
					data: formData,
					success: function (data) {
					    if(videoBlock){
							var videoBlk = "";
							if(url){
								videoBlk = videoBlock.find('iframe');
							}
							else{
								videoBlk = videoBlock.find('video');
							}
							if (data != '') {
								videoBlk.attr('id', data);
								$("#currentVideo >.deleteVideo").attr('data-video-id', data);
								$("#currentVideo >.editVideo").attr('data-editvideo-id', data);
								$("#currentVideo").attr('id', data);
							}
							else {
								videoBlk.attr('id', videoID);
								$("#currentVideo >.deleteVideo").find('a:first').attr('data-video-id', videoID);
								$("#currentVideo >.editVideo").attr('data-editvideo-id', videoID);
								$("#currentVideo").attr('id', videoID);
							}
					    }
					    else{
					        if(videoID){
					        	$("#" + videoID).find('h3 strong').html(title);
					        }
					    }
					},
					error: function (data) {
						if (videoID == '') {
							$("#current").remove();
						}
						else {
							$("#current").replaceWith(oldVideoBlock);
						}
						if (data.status == 403) {
							$("#loginAlert").show();
						}
						else{
							var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>Please try again.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
							$('.error').append(alert);
						}
					}
				});
			}
            function drawLinks(){
        	    $(".Info_cz_Class").remove();
        	    $(".imageLink").remove();
        	    $(".alertLink").remove();
        	    $(".ellipse_class").remove();
        	    $(".unpublishedSpaceClass").remove();
        	    $(".textBlockClass").remove();
        	    $(".deletedSpaceClass").remove();
        	    
        	    $.ajax({
        	        type: "GET",
        	        url: "[(@{'/staff/space/'+${space?.id}+'/links'})]",
        	        cache       : false,
        	        contentType : false,
        	        processData : false,
        	        beforeSend: function () {
        	            $("#loader").show();
        	            },
        	       	complete: function () {
        	            $("#loader").hide();
        	            },
        	        success: function(data) {
        	            var spaceLinks = data['spaceLinks'];
        	            var externalLinks = data['externalLinks'];
        	            var moduleLinks = data['moduleLinks'];
        	            var textBlocks = data['textBlocks'];
        	            
        	            var posXModal = $("#bgImage").position().left;
        	            var posYModal = $("#bgImage").position().top;
        	            var posX = $("#main-bgImage").position().left;
        	            var posY = $("#main-bgImage").position().top;
        	            
        	            spaceLinks.forEach(function(link,index){
        	                var spanId= "spacelinkModalId-";
        	                var divId = "#space"
        	                generateSpaceLinks(link,spanId,divId,true, posX, posY, posXModal, posYModal);
        	            })
        	            spaceLinks.forEach(function(link,index){
        	                var spanId= "spacelinkId-";
        	                var divId = "#main-space";
        	                generateSpaceLinks(link,spanId,divId,false, posX, posY, posXModal, posYModal);
        	            })
        	            
        	            moduleLinks.forEach(function(link,index){
        	                var spanId= "moduleModallinkId-";
        	                var divId = "#space";
        	                generateModuleLinks(link,spanId,divId,true, posX, posY, posXModal, posYModal);
        	            })
        	            moduleLinks.forEach(function(link,index){
        	                var spanId= "modulelinkId-";
        	                var divId = "#main-space";
        	                generateModuleLinks(link,spanId,divId,false, posX, posY, posXModal, posYModal);
        	            })
        	            
        	            externalLinks.forEach(function(link,index){
        	                var spanId= "externalModallinkId-";
        	                var divId = "#space";
        	                generateExternalLinks(link,spanId,divId,true, posX, posY, posXModal, posYModal);
        	            })
        	            
        	            externalLinks.forEach(function(link,index){
        	                var spanId= "externallinkId-";
        	                var divId = "#main-space";
        	                generateExternalLinks(link,spanId,divId,false, posX, posY, posXModal, posYModal);
        	            })
        	            
        	            textBlocks.forEach(function(block,index){
        	                var spanId= "textModalBlockId-";
        	                var divId = "#space";
        	                var imageHeight = modalBgImageHeight;
        	                var imageWidth = modalBgImageWidth;
        	                generateTextBlock(block,spanId,divId,true, posX, posY, posXModal, posYModal, imageHeight, imageWidth);
        	            })
        	            
        	            textBlocks.forEach(function(block,index){
        	                var spanId= "textBlockId-";
        	                var divId = "#main-space";
        	                var imageHeight = parseInt($("#main-bgImage").css("height"));
        	                var imageWidth = parseInt($("#main-bgImage").css("width"));
        	                generateTextBlock(block,spanId,divId,false, posX, posY, posXModal, posYModal, imageHeight, imageWidth);
        	            })
        	        }
        	    });
        	}
        	
        	function displayForms(formToShow){
        	    drawLinks();
        	    $("#space").css("display", "-webkit-box");
        	    $(formToShow).css("display", "flex");
        	    modalBgImageHeight = parseInt($("#bgImage").css("height"));
        	    modalBgImageWidth = parseInt($("#bgImage").css("width"));
        	}



        	function updateContentOrder(jsonObj,token){
            		$.ajax({
            		 // ------------- adjusting content order of blocks if their position changed after dragging ----------
	            		url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/blocks/order/update'})]",
	            		type: 'POST',
	            		beforeSend: function(){
		            		$(".loader").remove();
		            		$('#contOrdUpdStatus').empty();
		            		$('#contOrdUpdStatus').append($('<div class="loader" style="font-size: 30px;display: none; text-align: center;"><i class="icon-spinner" aria-hidden="true">Saving...</i></div>'));
		            		$(".loader").show();
	            		},
	            		complete: function(){
		            		$(".loader").hide();
		            		timeout = null;
	            		},
	            		cache       : false,
	            		contentType: 'application/json; charset=utf-8',
	            		processData :false,
	            		headers:{
	            			'X-CSRF-Token':token
	            		},
	            		data: JSON.stringify(jsonObj),
	            		success: function(data) {
		            		$(".save").remove();
		            		for(let i=0;i<data.length;i++) {
			            		$('#'+data[i].id).attr('data-position',data[i].contentOrder);
		            		} 
		            		var successDiv = $('<div style="width: 100%;height: 50px;" class="save alert alert-success alert-dismissible fade show" role="alert">');
		            		successDiv.append('<p>Successfully Saved.</p>');
		            		successDiv.append('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>');
		            		successDiv.append('</div>');
		            		$('#contOrdUpdStatus').empty();
		            		$('#contOrdUpdStatus').append(successDiv);
	            		},
	            		error: function(data) {
		            		$(".errInSave").remove();
		            		var errorDiv = $('<div style="width: 100%;height: 50px;" class="errInSave alert alert-danger alert-dismissible fade show" role="alert">');
		            		errorDiv.append('<p>We are sorry but something went wrong. Please try again later.</p>');
		            		errorDiv.append('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>');
		            		errorDiv.append('</div>');
		            		$('#contOrdUpdStatus').empty();
		            		$('#contOrdUpdStatus').append(errorDiv);
	            		}
            		});
        		}
            [# th:if="${#strings.equals(slide['class'].simpleName,'BranchingPoint')}"]
        		$('#addChoice').show();
        		$('#choiceSpace').show();
        	[/]
        	
            function guidedTour() {
            	const tour = new Shepherd.Tour({
            		  defaultStepOptions: {
            		    cancelIcon: {
            		      enabled: true
            		    },
            		    classes: '',
            		    scrollTo: { behavior: 'smooth', block: 'center' },
            		  },
            		  useModalOverlay: true,
            		});
            
            	tour.addStep({
            	  title: 'Welcome to the slide editor!',
            	  text: `Add or edit the content you want to show on your slides.`,
            	  buttons: [
            	    {
            	      action() {
            	        return this.next();
            	      },
            	      text: 'Next'
            	    }
            	  ],
            	  id: 'creating1'
            	});
            	
            	tour.addStep({
            	  title: 'Easy navigation',
            	  text: `Keep track of your location in the module or navigate back.`,
            	  attachTo: {
            	    element: '.breadcrumb',
            	    on: 'bottom'
            	  },
            	  buttons: [
            	    {
            	      action() {
            	        return this.back();
            	      },
            	      classes: 'shepherd-button-secondary',
            	      text: 'Back'
            	    },
            	    {
            	      action() {
            	        return this.next();
            	      },
            	      classes: 'btn primary-btn',
            	      text: 'Next'
            	    }
            	  ],
            	  id: 'creating2'
            	});
            	
            	tour.addStep({
            	  title: 'Adding content',
            	  text: `Add content to your slide. The content will be shown in the exhibition in the order you define here.`,
            	  attachTo: {
            	    element: '.content-btns',
            	    on: 'bottom'
            	  },
            	  buttons: [
            	    {
            	      action() {
            	        return this.back();
            	      },
            	      classes: 'shepherd-button-secondary',
            	      text: 'Back'
            	    },
            	    {
            	      action() {
            	        return this.next();
            	      },
            	      text: 'Done'
            	    }
            	  ],
            	  id: 'creating3'
            	});
            	tour.start();
            }
            $(document).ready(function() {
            	if (localStorage.getItem("newSlide") == null) {
            		guidedTour();
            		localStorage.setItem("newSlide", false);
            	}
            	$('#imageId').prop("disabled",true);
            	$('#chooseFromLocal').click(function() {
            		$("#selectedImage").empty();
            		$('#imageId').prop('selectedIndex',0).trigger( "change" );
            		$('#imageId').prop("disabled",true);
            		$('#file').prop("disabled",false);
            		
            	  });
            	
            	$('#chooseFromExisting').click(function() {
            		$('#file').val('');
            		$('#file').prop("disabled",true);
            		$('#imageId').prop("disabled",false);
            	  });
            	var timeout=null;
            	$('#slideSpace').sortable({
	            	update: function(event,ui) {
		            	var jsonObj = [];
		            	var blockId;
		            	$(this).children().each(function(index,element){
			            	if(typeof($(element.innerHTML).filter('div').attr('data-position'))=="undefined") {
			            		blockId=$(element).attr('id');
			            	}else {
			            		blockId = $(element.innerHTML).filter('div').attr('id');
			            	}
			            	item = {}
			            	item ["id"] = blockId;
			            	item ["contentOrder"] = index;
			            	jsonObj.push(item);
			            	$(element.innerHTML).filter('div').attr('data-position',index);
		            	});
		            	var token = [[${_csrf.token}]];
		            	if (jsonObj.length != 0){
			            	if (timeout != null){
			            		clearTimeout(timeout);
			            	}
			            	timeout = setTimeout(updateContentOrder(jsonObj,token), 1000);
		            	}
	            	}
            	});
            	
            	function showExternalLinkEdit(externalLink, show, posX, posY) {
            	    externalLink["x"]=storeX;
            	    externalLink["y"]=storeY;
            	    var selectedLinkClass = '#externalModallinkId-'+selectedExternalLinkId;
            	    var selectedLabelClass = '.label-'+selectedExternalLinkId;
            	    updateLinkProperties(selectedLinkClass,selectedLabelClass,externalLink["rotation"],posX,posY,externalLink["externalLinkLabel"]);
            	}

            	function updateLinkProperties(selectedLinkClass,selectedLabelClass,rotation,x,y,linkLabel, show){
            	    var posX, posY;
            	    if(show) {
            	        posX = $("#main-bgImage").position().left;
            	        posY = $("#main-bgImage").position().top;
            	    }
            	    else{
            	        posX = $("#bgImage").position().left;
            	        posY = 0
            	    }
            	    $(selectedLinkClass).css({ 'transform': 'rotate(' + rotation + 'deg)'});
            	    $(selectedLinkClass).css({ 'position': 'absolute'});
            	    $(selectedLinkClass).css({ 'left': x + posX});
            	    $(selectedLinkClass).css({ 'top': y + posY});
            	    $(selectedLabelClass+' span').remove();
            	    $(selectedLabelClass).append('<span class = "tooltiptext" style="fill: grey;">' + linkLabel + '</span>');
            	    feather.replace();    
            	}

            	function hideLinkInfoTabs(){
            	    $("#editExternalLinkInfo").hide();
            	    $("#editSpaceLinkInfo").hide();
            	    $("#editModuleLinkInfo").hide();
            	    $("#editTextBlockInfo").hide();
            	    $("#createExternalLinkAlert").hide();
            	    $("#createSpaceLinkAlert").hide();
            	    $("#createModuleLinkAlert").hide();
            	    $("#errorMsg").text("");
            	    $('#errorAlert').hide();
            	}

            	function showExternalLinks(externalLink, show, x, y) {
            	    $("#ext_label").remove();
            	    $("#link").remove();
            	    $("#undefined").remove();
            	    var posX = $("#bgImage").position().left;
            	    var posY = $("#bgImage").position().top;
            	    var ext_label = $("<p id='ext_label' class='tooltiptext'></p>");
            	    ext_label.text(externalLink["externalLinkLabel"]);

            	    var link;
            	    if(externalLink["type"] == "IMAGE" && externalLinkIcon) {
            	        link = $('<div id="link" data-link-id="' + externalLink["id"] + '"><img src="' + externalLinkIcon + '"></div>');
            	    } else {
            	        $(ext_label).css({
            	            'position': 'absolute',
            	            'font-size': "12px",
            	            'transform': 'rotate(0deg)',
            	            'color': 'blue'
            	        });
            	        link = $('<span id="' + externalLink["id"] +'" data-link-id="' + externalLink["id"] + '"  class="externalLink-' + externalLink["id"] + '"><div id="link" class="Info_cz_Class"><svg class="Ellipse_8_c ellipse_class"><ellipse fill="rgba(222,222,222,1)" class="Ellipse_8_c_Class" rx="14.5" ry="14.5" cx="14.5" cy="14.5"></ellipse></svg><svg class="Ellipse_10_c ellipse_class"><ellipse fill="rgba(240,240,240,1)" class="Ellipse_10_c_Class" rx="12.5" ry="12.5" cx="12.5" cy="12.5"></ellipse></svg><svg class="Ellipse_9_c ellipse_class"><ellipse fill="rgba(255,255,255,1)" class="Ellipse_9_c_Class" rx="10.5" ry="10.5" cx="10.5" cy="10.5"></ellipse></svg><span class="icon-ext-link Icon_awesome_info_staff_e"></span></div></span>');
            	    }
            	    
            	    if(show) {
            	        link.css('top', externalLink["y"] + posY);
            	    } else {
            	    	link.css('top', externalLink["y"]);
            	    }

            	    link.css('position', 'absolute');
            	    link.css('left', externalLink["x"] + posX);
            	    link.css('color', 'blue');
            	    link.css('font-size', "12px");

            	    if (externalLink["id"]) {
            			link.attr("data-link-id", externalLink["id"]);
            			link.css('cursor', 'pointer');
            			link.attr('href', externalLink["url"]);
            			link.click(function(e) {
            				makeExternalLinksEditable(externalLink["externalLinkLabel"], externalLink["id"], externalLink["externalLinkURL"], externalLink["x"], externalLink["y"], externalLink["displayId"], externalLink["type"],externalLink["howToOpen"],externalLink["tabOpen"]);
            			});
            			
            			ext_label.attr("data-link-id", externalLink["id"]);
            			ext_label.css('cursor', 'pointer');
            			ext_label.attr("class", "label-"+externalLink["id"]);
            			ext_label.click(function(e) {
            				makeExternalLinksEditable(externalLink["externalLinkLabel"], externalLink["id"], externalLink["externalLinkURL"], externalLink["x"], externalLink["y"], externalLink["displayId"], externalLink["type"],externalLink["howToOpen"],externalLink["tabOpen"]);
            			});
            	    }

            	    $("#space").append(link);
            	    $("#link").append(ext_label);
            	    $("#external-link").remove();

            	}
            	
            	function editExternalLinkInfo() {
            		var info = {};
            		info["x"] = storeX;
            		info["y"] = storeY;
            		info["tabOpen"] = $("#extTabOpenEdit").val();
            		info["type"] = $("#extTypeEdit").val();
            		info["externalLinkLabel"] = $("#externalLinkLabelEdit").val();
            		info["externalLinkURL"] = $("#externalLinkURLEdit").val();
            		return info;
            	}
            	
            	function makeExternalLinksEditable(linkName, linkId, externalLinkURL, posXEdit, posYEdit, displayLinkId, linkType,tabOpenType) {
            	    selectedExternalLinkId=linkId;
            	    storeX=posXEdit;
            	    storeY=posYEdit;
            	    $("#externalLinkInfoLabel").text(linkName);
            	    $("#externalLinkId").val(linkId);
            	    $("#externalLinkDisplayId").val(displayLinkId);
            	    $("#externalLinkInfoLabelEdit").text(linkName);
            	    $("#externalLinkLabelEdit").val(linkName);
            	    $("#externalLinkIdValueEdit").val(linkId);
            	    $("#externalLinkURLEdit").val(externalLinkURL);
            	    $('#extTypeEdit option[value="'+linkType+'"]').prop("selected", true);
            	    $('#extTabOpenEdit option[value="'+tabOpenType+'"]').prop("selected",true);
            	    
            	    resetHighlighting();

            	    $('[data-link-id="' + linkId + '"]').css("color", "#c1bb88");
            	    $('div[data-link-id="' + linkId + '"]').removeClass("alert-primary");
            	    $('div[data-link-id="' + linkId + '"]').addClass("alert-warning");
            	    $('img[data-link-id="' + linkId + '"]').css("border", "solid 1px #c1bb88");

            	    $("#bgImage").on("click", function(e){
            	        e.preventDefault();
            	        var posX = $(this).position().left;
            	        var posY = $(this).position().top;    
            	        storeX = e.pageX - $(this).offset().left;
            	        storeY = e.pageY - $(this).offset().top + 25;
            	        showExternalLinkEdit(editExternalLinkInfo(), false, storeX,storeY);
            	    });
            	    hideLinkInfoTabs();
            	    displayForms("#editExternalLinkInfo");
            	}
            	
            	function generateExternalLinks(link,spanId,divId,isModal, posX, posY, posXModal, posYModal){
            		if(link != null){
            			var externalLink;
            			if(link.type=="IMAGE" && link.image != null){
            				var imageURL = [[@{/api/image/}]]+link.image.id;
            				externalLink = $('<img id="'+spanId+link.externalLink.id+'" data-linkTarget="'+link.externalLink.externalLink+'" data-linkType="'+link.type+'"  data-howToOpen="'+ link.howToOpen+'" data-linkLabel="'+link.externalLink.name+'" class="externalLink-'+link.externalLink.id+' imageLink" data-link-id="'+link.externalLink.id+'" src="'+imageURL+'" />');
            			}else{
            				externalLink = $('<span id="'+spanId+link.externalLink.id+'" data-link-id="'+link.externalLink.id+'" data-linkTarget="'+link.externalLink.externalLink+'" data-linkType="'+link.type+'"  data-howToOpen="'+ link.howToOpen+'" data-linkLabel="'+link.externalLink.name+'" class="externalLink-'+link.externalLink.id+' Info_cz_Class"><svg class="Ellipse_8_c ellipse_class"><ellipse fill="rgba(222,222,222,1)" class="Ellipse_8_c_Class" rx="14.5" ry="14.5" cx="14.5" cy="14.5"></ellipse></svg><svg class="Ellipse_10_c ellipse_class"><ellipse fill="rgba(240,240,240,1)" class="Ellipse_10_c_Class" rx="12.5" ry="12.5" cx="12.5" cy="12.5"></ellipse></svg><svg class="Ellipse_9_c ellipse_class"><ellipse fill="rgba(255,255,255,1)" class="Ellipse_9_c_Class" rx="10.5" ry="10.5" cx="10.5" cy="10.5"></ellipse></svg><span class="icon-ext-link Icon_awesome_info_staff_e"></span><p class="label-'+link.externalLink.id+'" data-link-id="'+link.externalLink.id+'"><span class="tooltiptext">'+link.externalLink.name+'</span></p></span>');
            			}
            			setLinkPosition(externalLink,link,false,isModal,true, posX, posY, posXModal, posYModal);
            			$(divId).append(externalLink);
            			if(spanId === "externallinkId-"){
            				$('#'+spanId+link.externalLink.id).css('cursor', 'pointer');
            				$('#'+spanId+link.externalLink.id).click(function(e) {
            					var linkData = $('#'+spanId+link.externalLink.id).data();
            					makeExternalLinksEditable(linkData["linklabel"],link.externalLink.id,linkData["linktarget"],link.positionX,link.positionY,link.id,linkData["linktype"],linkData["howtoopen"]);
            				});
            			}
            		}
            	}
            	
            
                //-------- edit contentblock description --------
            
                $("#submitDescription").hide()
                $("#cancelEditDescription").hide()
                var description = $("#description").text()
                $("#editDescription").click(function() {
                    $('<textarea id="newDescription" style="margin-top: 1%;" class="form-control" type="text">'+description+'</textarea>').insertBefore( "#description" );
                    $("#description").remove()
                    $("#editDescription").hide()
                    $("#submitDescription").show()
                    $("#cancelEditDescription").show()
                    
                });
            
                $("#submitDescription").click(function() {
                    var formData = new FormData();
                    formData.append('description', $("#newDescription").val());
                    $.ajax({ 
            	        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/edit/description?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
            	        type: 'POST',
            	        cache       : false,
            	        contentType : false,
            	        processData : false,
            	        data: formData,
            	        enctype: 'multipart/form-data',
            	        success: function(data) {
            	            // replace text box with new description
            	            $("#submitDescription").hide()
            	            $("#cancelEditDescription").hide()
            	            $("#editDescription").show()
            	            var val = $("#newDescription").val();
            	            $('<p id="description"style="margin-top: .5rem; margin-bottom: .5rem;"></p>').insertBefore( "#newDescription" );
            	            $("#newDescription").remove();
            	            $("#description").text(val)
            	        },
            	        error: function(data) {
            	            $(".open").removeClass("open");
            	                var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            	                $('.error').append(alert);
            	        }
                     });       
                  });
                
                $("#cancelEditDescription").click(function(){
                    $("#submitDescription").hide()
                    $("#editDescription").show()
                    $("#cancelEditDescription").hide()
                    $('<p id="description" style="margin-top: .5rem; margin-bottom: .5rem;"></p>').insertBefore( "#newDescription" );
                    $("#newDescription").remove()
                    $("#description").text(description)
                    
                });
                
                //------- edit title --------
                $("#submitTitle").hide();
                $("#cancelEditTitle").hide();
                var getTitleText = $("#title").text().split(": ")[1]
                $("#editTitle").click(function() {
                    $('<div class="col-4"><input id="newTitle" class="form-control" type="text"></div>').insertAfter( "#title" );
                    $('#title').text('Slide: ')
                    $("#newTitle").val(getTitleText)
                    $("#editTitle").hide()
                    $("#submitTitle").show()
                    $("#cancelEditTitle").show()       
                });
                
                $("#submitTitle").click(function() {
                    var formData = new FormData();
                    formData.append('title', $("#newTitle").val());
                    $.ajax({
                        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/edit/title?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
                        type: 'POST',
                        cache       : false,
                        contentType : false,
                        processData : false,
                        data: formData,
                        enctype: 'multipart/form-data',
                        success: function(data) {
                            // replace text box with new description
                            $("#submitTitle").hide()
                            $("#cancelEditTitle").hide();
                            $("#editTitle").show()
                            var val = $("#newTitle").val();
                            $("#newTitle").closest('div').remove();
                            $("#title").text("Silde: " + val)
                            
                        },
                        error: function(data) {
                            var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                            $('.error').append(alert);
                        }
                    });
                  });
               $("#cancelEditTitle").click(function(){
                    $("#submitTitle").hide()
                    $("#editTitle").show()
                    $("#cancelEditTitle").hide()
                    $("#newTitle").closest('div').remove();
                    $("#title").text("Silde: " + getTitleText);
               });
               
                $("#addText").click(function() {
                    $(".EasyMDEContainer").remove();
                	markDown = new EasyMDE({element: $('#textBlockText')[0]});
                    $("#addTextAlert").show();
                });
                
                $("#addImage").click(function() {
                    $("#addImgAlert").show();
                });
                
                $("#addVideo").click(function() {
                    $("#videoTitle").value = "";
                    $("#addVideoAlert").show();
                    addVideoClk =1;
                    editVideoClk=0;
                });
                
                $("#addExternalLinkButton").click(function(e) {
                    $("#bgImage").off("click");
                    $("#bgImage").on("click", function(e){
                        e.preventDefault();
                        $("#link").remove();
                        $("#external-arrow").remove();
                        $("#ext_label").remove();
                        var icon;
                        var posX = $(this).position().left
                        var posY = $(this).position().top;
                        storeX = e.pageX - $(this).offset().left;
                        storeY = e.pageY - $(this).offset().top + 25;
                        showExternalLinks(createExternalLinkInfo(), false, storeX, storeY);
                    });
                    hideLinkInfoTabs();
                    displayForms("#createExternalLinkAlert");
                });

                
                $("#uploadImage").click(function(e) {
                    e.preventDefault();
                    $("#addImgAlert").hide();
                    uploadImage();
                    $('#chooseFromLocal').trigger( "click" );
                });
                
                $("#saveVideo").click(function(e) {
                    e.preventDefault();
                    $("#addVideoAlert").hide();
                    embedVideo();
                    $("#saveVideo").data('value', '');
                    $("#saveVideo").data('url', '');
                    $("#uploadTab").addClass("active");
                    $("#urlTab").removeClass("active");
                    $("#urlLink").removeClass("active show");
                    $("#urlLink>a").removeClass("active show");
                    $("#uploadLink").addClass("active show");
                    $("#uploadLink>a").addClass("active show");
                });
                
                $("#addChoice").click(function() {
                    $("#addChoiceAlert").show();
                });
                
                $(document).on("click", ".deleteText", function(e) {
            		$("#confirmDeleteTextAlert").show();
            		var alert = $('<input type="hidden" id="deleteTextId">');
            		$(alert).attr( 'value', $(this).siblings('input').val());
            		$('.modal-footer').append(alert); 
              	});
            	
            	$(document).on("click", ".deleteImage", function(e) {
            		$("#confirmDeleteImageAlert").show();
            		var alert = $('<input type="hidden" id="deleteImageId">');
            		$(alert).attr( 'value', $(this).siblings('input').val());
            		$('.modal-footer').append(alert); 
              	});
            	
            	$(document).on("click", ".deleteVideo", function(e) {
            		$("#videoIdToDelete").attr( 'value', $(this).attr('data-video-id'));
            		$(".load").remove();
            		$("#"+$(this).attr('data-video-id')).append($('<div class="load" style="font-size: 30px;display: none; text-align: center;"><i class="fa fa-spinner fa-spin" aria-hidden="true"></i></div>'));
            		$(".load").show();
            		setTimeout(function() {
            		    //code to be executed after 3 second
            		    $(".load").hide();
            		    $("#confirmDeleteVideoAlert").show();
            		  }, 3000);
              	});
            	
            	$(document).on("click", ".deleteChoiceBlock", function(e) {
            		$("#confirmDeleteChoiceBlockAlert").show();
            		var alert = $('<input type="hidden" id="deleteChoiceBlockId">');
            		$(alert).attr( 'value', $(this).siblings('input').val());
            		$('.modal-footer').append(alert); 
              	});
                
                $("#cancelSubmitText").click(function() {
            		$("#addTextAlert").hide();	
            	});
            	
            	$("#cancelDeleteText").click(function() {
            		$("#confirmDeleteTextAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
            		$("#confirmDeleteTextAlert").hide();
            	});
            	
            	$("#cancelDeleteImage").click(function() {
            		$("#confirmDeleteImageAlert").hide();
            	});
            	
            	$("#cancelDeleteVideo").click(function() {
            		$("#confirmDeleteVideoAlert").find('input').remove();
            		$("#confirmDeleteVideoAlert").hide();	
            	});
            	
            	$("#cancelDeleteChoiceBlock").click(function() {
            	    $("#confirmDeleteChoiceBlockAlert").find('input').remove();
            	    $("#confirmDeleteTextAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").hide();
            	});
            	
            	$("#cancelDelete").click(function() {
            		$("#confirmDeleteTextAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").hide();	
            	});
            	
                	// ---------- Delete Text Block -------------
            	
            		$("#deleteText").on("click", function(e) {
            		e.preventDefault();
            		$("#confirmDeleteImageAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
            		$("#confirmDeleteTextAlert").hide();
            		var blockId = $('#deleteTextId').attr('value');
            		$('#deleteTextId').remove()
            		
            		// ------------- delete text content blocks ------------
            		$.ajax({
            		    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/text/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
            		    type: 'DELETE',
            		    success: function(result) {
            		        $('#' + blockId).remove();
            		        
            		    },
            			error: function(data) {
            				var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            				$('.error').append(alert); 
            				$(".error").delay(4000).slideUp(500, function(){
            				    $(".error").empty();
            				});
            			}
            		});
            	});
            	
            	// ---------- Delete Image Block -----------
            	
            	$("#deleteImage").on("click", function(e) {
            		e.preventDefault();
            		$("#confirmDeleteTextAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
            		$("#confirmDeleteImageAlert").hide();
            		var blockId = $('#deleteImageId').attr('value');
            		if(blockId == null || blockId == ''){
            			var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            			$('.error').append(alert); 
            			$(".error").delay(4000).slideUp(500, function(){
            			    $(".error").empty();
            			});
            		} else{
            			$('#deleteImageId').remove()
            			// ------------- delete image content blocks ------------
            			$.ajax({
            			    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/image/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
            			    type: 'DELETE',
            			    success: function(result) {
            			    	$('#' + blockId).remove();
            			    },
            				error: function(data) {
            					var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            					$('.error').append(alert); 
            					$(".error").delay(4000).slideUp(500, function(){
            					    $(".error").empty();
            					});
            				}
            			});
            		}
            	});
            	
            	// ---------- Delete Video Block -----------
            	
				$("#deleteVideo").on("click", function(e) {
            		e.preventDefault();
            		$("#confirmDeleteTextAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").find('input').remove();
            		$("#confirmDeleteVideoAlert").hide();
            		var blockId = $('#videoIdToDelete').attr('value');
            		$('#videoIdToDelete').val("");
            		if(blockId == null || blockId == ''){
            			var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            			$('.error').append(alert); 
            			$(".error").delay(4000).slideUp(500, function(){
            			    $(".error").empty();
            			});
            		} else{
            		    // ------------- delete video content blocks ------------
            			$.ajax({
            			    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/video/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
            			    type: 'DELETE',
            			    success: function(result) {
            			    	$('#' + blockId).remove();
            			    },
            				error: function(data) {
            					var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            					$('.error').append(alert); 
            					$(".error").delay(4000).slideUp(500, function(){
            					    $(".error").empty();
            					});
            				}
            			});
            		}
            	});
            	
            	$("#deleteChoiceBlock").on("click", function(e) {
            	    e.preventDefault();
            	    $("#confirmDeleteTextAlert").find('input').remove();
            	    $("#confirmDeleteImageAlert").find('input').remove();
            		$("#confirmDeleteChoiceBlockAlert").hide();
            		var blockId = $('#deleteChoiceBlockId').attr('value');
            		if(blockId == null || blockId == ''){
            			var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            			$('.error').append(alert); 
            			$(".error").delay(4000).slideUp(500, function(){
            			    $(".error").empty();
            			});
            		} else{
            			$('#deleteChoiceBlockId').remove()
            			// ------------- delete choices content blocks ------------
            			$.ajax({
            			    url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/choiceBlock/'})]"+blockId+'?'+[[${_csrf.parameterName}]]+'='+[[${_csrf.token}]],
            			    type: 'DELETE',
            			    success: function(result) {
            			    	$('#' + blockId).remove();
            			    },
            				error: function(data) {
            					var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try to delete again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
            					$('.error').append(alert); 
            					$(".error").delay(4000).slideUp(500, function(){
            					    $(".error").empty();
            					});
            				}
            			});
            		}
            	});
            	$("#cancelSubmitChoice").click(function() {
                    $("#addChoiceAlert").hide();	
                });
            	
                $("#cancelImageBtn").click(function() {
                    $('#chooseFromLocal').trigger( "click" );
                    // Initialize selected image ID to blank, on clicking cancel button
                    $("#uploadImage").data('value', '');
                    $("#addImgAlert").hide();
                    $(".open").removeClass("open");
                });
                
                $("#cancelVideoBtn").click(function() {
                    // Initialize selected video ID to blank, on clicking cancel button
                    $("#videoTitle").val('');
                    $("#saveVideo").data('value', '');
                    $("#saveVideo").data('url', '');
                    $("#saveVideo").prop('disabled', true);
                    $("#videoFile").val('');
                    $("#videoLink").val('');
                    $("#addVideoAlert").hide();
                    $(".open").removeClass("open");
                    $("#uploadTab").addClass("active");
                    $("#urlTab").removeClass("active");
                    $("#urlLink").removeClass("active show");
                    $("#urlLink>a").removeClass("active show");
                    $("#uploadLink").addClass("active show");
                    $("#uploadLink>a").addClass("active show");
                    $("#saveVideo").html("Update Video"); 
                    $('#videoIdToDelete').val("");
                });
                
                $("#file").click(function() {
                    $("#selectedImage").empty();
                    $('#imageId').prop('selectedIndex',0).trigger( "change" );
                });
                
                $("#submitText").on("click", function(e) {
                    $("#addTextAlert").hide();
                    e.preventDefault();
                    // ------------- creating text content blocks ------------
                    
                    var formData = new FormData();
                    var text = markDown.value();
                    formData.append('content', text);
                    markDown.value('');
                    $.ajax({
                        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/textcontent?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
                        type: 'POST',
                        cache       : false,
                        contentType : false,
                        processData : false,
                        data: formData,
                        enctype: 'multipart/form-data',
                        success: function(data) {
            
                            var textblock = $('<div style="word-break:break-word;" id="'+ data +'" class="textDivStaff tab row"><p class="col-md-10">'+text+'</p>'+'<input type="hidden" id="deleteTextId" value="'+data+'" /><a class="btn deleteText col-md-1" href="javascript:;" style="position: absolute; right: 0px;"><span class="icon-trash error"></span></a></div>');
                            $(textblock[0]).mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
                            $('#slideSpace').append(textblock);             
                        },
                        error: function(data) {
                        	if (data.status == 403){
                        		$("#loginAlert").show();
                        	}
                        	else {
                            	var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                            	$('.error').append(alert);
                        	}
                        }
                    });
                });
                
                $('input:checkbox').click(function() {
                    if ($(this).is(':checked')) {
                    	$('#submitChoices').prop("disabled", false);
                    } else {
                    if ($('.choiceOptions').filter(':checked').length < 1){
                    	$('#submitChoices').attr('disabled',true);}
                    }
                });
                
                $("#submitChoices").on("click", function(e) {
                    e.preventDefault();
                    $("#addChoiceAlert").hide();
                    var selectedChoice = [];
                    var showsAll = false;
                    $('#selectChoices :checked').each(function() {
                    	selectedChoice.push($(this).attr("id"));
                      });
                    // ------------- creating choice content blocks ------------
                    if ($('#showAllChoices').is(':checked')) {
                        showsAll = true;
                    }
                    var formData = new FormData();
                    formData.append('selectedChoices', selectedChoice);
                    formData.append('showsAll', showsAll);
                    $.ajax({
                        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/choice/content?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
                        type: 'POST',
                        cache       : false,
                        contentType : false,
                        processData : false,
                        data: formData,
                        enctype: 'multipart/form-data',
                        success: function(data) {
                            var choiceblock = $('<div id="'+ data['choiceBlock'].id +'" class="choiceDiv tab row" style="display:block;">');
                            if (data['choiceBlock'].showsAll == false){
                                $.each(data['selectedSequences'], function(index, sequence) {
                                    choiceblock.append('<a style="color:var(--primary);  display:block;" href="/vspace/staff/module/[(${module.id})]/sequence/'+sequence.id+'">'+sequence.name+'</a>');
                        	});
                            }else{
                            	$(function() {
                                    var links = $("#choiceSpaceData a").map(function(e) {
                                        text = '<a style="color:var(--primary); display:block;" href='+this.href+'>'+this.name+'</a>';
                                        return text;
                                    }).get();
                                    $(links).each(function(index, choice) {
                                        choiceblock.append(choice);
                                    });
                               });
                            }
                            choiceblock.append('<input type="hidden" class="col-md-8" id="deleteChoiceBlockId" value="'+ data['choiceBlock'].id +'"><a class="btn deleteChoiceBlock col-md-1" href="javascript:;" style="position: absolute; right: 0; top: 0;"><span class="icon-trash error"></span></a></div>')
                        	$(choiceblock).css({
                                'display': "block"
                            });
                            $('#slideSpace').append(choiceblock);
                        },
                        error: function(data) {
                            var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                            $('.error').append(alert);
                        }
                    });
                    $('#choiceForm')[0].reset();
                });
            
                $("#urlLink").on("click", function (e) {
 				    if ($("#videoFile").val()) {
 						$("#videoTitle").prop('disabled', true);
 						$("#videoLink").prop('disabled', true);
 						$("#saveVideo").prop('disabled', true);
 					}
 					if (!$("#videoFile").val()) {
 						$("#videoTitle").prop('disabled', false);
 						$("#videoLink").prop('disabled', false);
 						$("#saveVideo").prop('disabled', false);
 					}
 					if (!$("#videoTitle").val() && !$("#videoLink").val()) {
 						$("#saveVideo").prop('disabled', true);
 					}
 					if (!$("#videoTitle").val() && $("#videoLink").val()) {
 						$("#saveVideo").prop('disabled', true);
 					}
 					$("#urlLink").addClass("active show");
 					$("#uploadLink").removeClass("active show");
                    if(addVideoClk==1 && editVideoClk==0){
                        $("#saveVideo").html("Embed Video"); 
                        if (!$("#videoTitle").val() || !$("#videoLink").val()) {
     						$("#saveVideo").prop('disabled', true);
     					}
                    }
                    if(addVideoClk==0 && editVideoClk==1){
                        $("#saveVideo").html("Update Video");  
                        if ($("#videoTitle").val() && !$("#videoLink").val()) {
     						$("#saveVideo").prop('disabled', false);
     					}
                        if (!$("#videoTitle").val() && $("#videoLink").val()) {
     						$("#saveVideo").prop('disabled', true);
     					}
                    }
                    
 				});

 				$("#uploadLink").on("click", function (e) {
 				    if ($("#videoLink").val()) {
 						$("#videoTitle").prop('disabled', true);
 						$("#videoFile").prop('disabled', true);
 						$("#saveVideo").prop('disabled', true);
 					}else {
 						$("#videoTitle").prop('disabled', false);
 						$("#videoFile").prop('disabled', false);
 						$("#saveVideo").prop('disabled', false);
 					}
 					
 					if (!$("#videoTitle").val() && !$("#videoFile").val()) {
 						$("#saveVideo").prop('disabled', true);
 					}
 					$("#urlLink").removeClass("active show");
 					$("#uploadLink").addClass("active show");
 				   if(addVideoClk==1 && editVideoClk==0){
                       $("#saveVideo").html("Upload Video");   
                       if (!$("#videoTitle").val() || !$("#videoFile").val()) {
    						$("#saveVideo").prop('disabled', true);
    					}
                   }
                   if(addVideoClk==0 && editVideoClk==1){
                       $("#saveVideo").html("Update Video");  
                       if ($("#videoTitle").val() && !$("#videoFile").val()) {
    						$("#saveVideo").prop('disabled', false);
    					}
                       if (!$("#videoTitle").val() && $("#videoFile").val()) {
    						$("#saveVideo").prop('disabled', true);
    					}
                   }
 				});
 				
 				$("#videoLink").on("input", function (e) {
 				    if (!$("#videoLink").val()) {
 						$("#saveVideo").prop('disabled', true);
 					}else {
 						$("#saveVideo").prop('disabled', false);
 					}
 				});
 				
 				$("#videoFile").on("input", function (e) {
 				    if (!$("#videoFile").val()) {
 						$("#saveVideo").prop('disabled', true);
 					}else {
 						$("#saveVideo").prop('disabled', false);
 					}
 				});
 				
 				$("#videoTitle").on("input", function (e) {
 				    if ($("#videoFile").val() || $("#videoLink").val()) {
 						$("#saveVideo").prop('disabled', false);
 					}
 				}); 
                
                function updateTextBox(blockId, text) {
                    // clear text box and buttons
                    $(".open").empty();
                    $(".open").append('<p class="col-md-10">'+text+'</p><input type="hidden" id="deleteTextId" value="'+blockId+'" /><a class="btn deleteText col-md-1" href="javascript:;" style="position: absolute; right:0;"><span class="icon-trash error"></span></a>');
                    // reset border of the card
                    //rebind event handlers
                    $('.textDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
                    //resetting the height and overflow-y so that the TextBlock doesn't expand
                    $('.textDivStaff').css('height', 'auto');
                    $('.textDivStaff').css('overflow-y', 'visible');
                    $(".open").css('display', 'flex');
                    // remove id from storage so its not there on refresh
                    $(".open").removeClass("open");
                }
                
                // must add the event to the document since the buttons are added dynamically
                $('#cancelTextBlock').on('click',function(){
                	$("#editTextAlert").hide();
                	var blockId = $(this).closest(".open").attr("id");
                	updateTextBox(blockId, defaultValue);
                });
            
                $('.valueDiv').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
                $('.textDivStaff').mouseenter(onMouseEnter).mouseleave(onMouseLeave).dblclick(onDoubleClick);
                $('.vidDiv').mouseenter(onMouseEnter).mouseleave(onMouseLeave);//.dblclick(onDoubleClick);
            
                $("#submitTextBlock").on("click", function(e){
                	e.preventDefault();
                    // ------------- editting text content blocks ------------
                    
                    var formData = new FormData();
                    var text = markDown.value();
                    markDown.value('');
                    var formData = new FormData();
                    var blockId = $(".open").attr("id");
                    formData.append('textBlockDesc', text);
                    formData.append('textBlockId', blockId);
                	$("#editTextAlert").hide();
                    $.ajax({
                        url: "[(@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/text/edit?'+${_csrf.parameterName}+'='+${_csrf.token}})]",
                        type: 'POST',
                        cache       : false,
                        contentType : false,
                        processData : false,
                        data: formData,
                        enctype: 'multipart/form-data',
                        success: function(data) {
                            // replace text box with new description
                           updateTextBox(blockId, text)
                           $(".open").removeClass("open");
                       },
                       error: function(data) {
                    		if (data.status == 403) {
                       			$("#loginAlert").show();
                       		}
                       		else {
                           		var alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><p>We are sorry but something went wrong. Please try again later.</p><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
                           		$('.error').append(alert);
                       		}
                       }
                   });
                });    
                $("#imageId").select2({
            		ajax: {
            		    url: function (params) {
            		  		var imageURL = [[@{|/staff/images/search|}]];
            		  		return imageURL;
            		    },
            		    dataType: 'json',
            		    processResults: function (data) {
            		        return {
            		          results: data,
            		        };
            		      },
            		},
            		templateResult: formatImage,
            		templateSelection: formatSelection
                });
                
                function formatImage (image) {
                	if (!image.id) {
                		return image.text;
                	}
                	var tbaseUrl = [[@{|/api/image/|}]];
                	var $image = $(
                			'<span><img src="' + tbaseUrl + image.id + '" class="img-thumbnail" /> ' + image.text + '</span>'
                	);
                	return $image;
                };
                
                function formatSelection(image) {
                	if (!image.id) {
                        return image.text;
                    }
                	var tbaseUrl = [[@{|/api/image/|}]];
                    var $image = $(
                            '<span>' + image.text + '</span>'
                    );
                    $("#selectedImage").empty();
                    $("#selectedImage").append('<img width="200px" src="' + tbaseUrl + image.id + '" class="img-thumbnail" />');
                    return $image;
                }
            });
            
            $(window).on('load', function () {	
            	var divWindow = $(".valueDiv");
            	$(".deleteText").css('position', 'absolute');
            	$(".deleteText").css('right', '0');
            	var images = $(".imgDiv");
            	resizeImage(images);
            	
            	function resizeImage(images) {
            		for(var i =0; i < images.length; i++) {
            			if (images[i].width > divWindow.width() || images[i].width >= 800) {
            				$(".valueDiv").find("#"+images[i].id).css("width", 800);
            				images[i].width = 800;
            			} else {
            				$(".valueDiv").find("#"+images[i].id).css("width", images[i].width);
            			}
            		}
            	}
            });
            
            
			// editing video block
            $(document).on("click", ".editVideo", function(e) {
                addVideoClk =0;
                editVideoClk=1;
                $("#saveVideo").html("Update Video");
                $("#saveVideo").prop('disabled', false);
            	var id = $(this).attr('data-editvideo-id');
            	var vidId = $('div#'+id).attr('id');
            	var title = $('div#'+id).find('h3 strong').html();
            	if (vidId != '') {
                    var url="";
                    if($('div#'+id).find('iframe')!=null && typeof($('div#'+id).find('iframe')) != "undefined"
					&& $('div#'+id).find('iframe').attr('src')!=null && typeof($('div#'+id).find('iframe').attr('src')) != "undefined")
					{
            			url = $('div#'+id).find('iframe').attr('src');
					}
                	if (url.length > 0) {
            			$("#saveVideo").data('url', url);
            			$("#videoLink").val(url);
            			$("#urlTab").addClass("active");
            			$("#urlLink").addClass("active  show");
            			$("#uploadTab").removeClass("active show");
            			$("#uploadLink").removeClass("active show");
            			$("#urlLink>a").addClass("active show");
            			$("#uploadLink").removeClass("active show");
            			$("#uploadLink>a").removeClass("active show");
					} 
                    $("#videoTitle").val(title);
                    $("#saveVideo").data('value', vidId);
                    $("#addVideoAlert").show();
            	}
            });
        </script>
    </head>
    <body>
        <div class="main-content" layout:fragment="content">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a th:href="@{/staff/dashboard}">Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                    <a th:href="@{/staff/module/list}">Modules</a>
                </li>
                <li class="breadcrumb-item">
                    <a th:href="@{'/staff/module/'+${module.id}}">[[${module.name}]]</a>
                </li>
                <li class="breadcrumb-item" th:each="slideSequence: ${slideSequences}">
                    <a th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${slideSequence.id}}" th:name="${slideSequence.name}">[[${slideSequence.name}]]</a>
                </li>
                <li class="breadcrumb-item active">[[${slide.name}]]</li>
            </ol>
            <div class="error"></div>
            <div class="dropdown" style="float: right;" th:if="${#strings.equals(slide['class'].simpleName,'BranchingPoint')}">
                <button class="btn branchbtn dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="icon-branch"></span> This Branching Point links to the following Sequences
                </button>
                <div id="choiceSpaceData" class="dropdown-menu" aria-labelledby="dropdownMenu2">
                    <a  th:each="choice: ${choices}" class="dropdown-item" 
                        th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${choice.sequence.id}}"
                        th:name="${choice.sequence.name}" style="color:var(--primary);">[[${choice.sequence.name}]]</a>
                </div>
            </div>
            <div style="display: flex">
                <div style="margin-right: 20px">
                    <h2 class="heading"><span style="color: var(--dark-grey);">Slide:</span> [[${slide.name}]]</h2>
                    <p id="description">[[${slide.description}]]</p>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-dark" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span class="icon-caret-down" style="font-size: 16px"></span>
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                        <a class="dropdown-item" data-toggle="tooltip" data-html="true" data-placement="top" 
                            th:title="|Created on <span class='date'>${slide.creationDate}</span> by ${slide.createdBy}|"><span class="icon-info-circle"></span>&emsp; Slide info</a>
                        <a class="dropdown-item" th:href="@{'/staff/module/'+${module.id}+'/slide/'+${slide.id}+'/edit'}">
                        <span class="icon-edit"></span>&emsp; Edit slide</a>
                        <a class="dropdown-item" style="cursor: pointer" th:onclick="guidedTour()"><span class="icon-map"></span>&emsp; Start tour</a>
                    </div>
                </div>
            </div>
            <div style="margin: 40px 0 20px; width: fit-content" class="content-btns">
                <button type="button" id="addText" class="btn pill-btn" data-toggle="tooltip" title="Add Text Block" data-placement="top">
                +&nbsp;<span class="icon-text"></span></button>&nbsp;
                <button type="button" id="addImage" class="btn pill-btn" data-toggle="tooltip" title="Add Image" data-placement="top">
                +&nbsp;<span class="icon-image"></span></button>&nbsp;
                <button type="button" id="addVideo" class="btn pill-btn" data-toggle="tooltip" title="Add Video" data-placement="top">
                +&nbsp;<span class="icon-video"></span></button>&nbsp;
                <button type="button" id="addExternalLinkButton" class="btn pill-btn" data-toggle="tooltip" title="Add Link to External" data-placement="top">
                +&nbsp;<span class="fa fa-external-link-alt"></span></button>&nbsp;
                <button type="button" id="addChoice" style="display: none;" class="btn pill-btn" data-toggle="tooltip" title="Add Sequence Choice" data-placement="top">
                +&nbsp;<span class="icon-checkmark"></span></button>
            </div>
            <p style="margin-top: 0.5rem;">Double click on a block to edit it. Drag and drop blocks to change their order.</p>
            <div class="sticky" id="contOrdUpdStatus"></div>
            <!-- Delete Text Modal -->
            <div id="confirmDeleteTextAlert" class="modal" tabindex="-1"
                role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h6>Are you sure you want to delete this
                                text block?
                            </h6>
                        </div>
                        <div class="modal-footer">
                            <button id="cancelDeleteText" type="reset"
                                class="btn light">Cancel</button>
                            <button type="submit" id="deleteText"
                                class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Delete Image Modal -->
            <div id="confirmDeleteImageAlert" class="modal" tabindex="-1"
                role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h6>Are you sure you want to delete this
                                image block?
                            </h6>
                        </div>
                        <div class="modal-footer">
                            <button id="cancelDelete" type="reset"
                                class="btn light">Cancel</button>
                            <button type="submit" id="deleteImage"
                                class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Delete Video Modal -->
            <div id="confirmDeleteVideoAlert" class="modal"
                tabindex="-1" role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h6>Are you sure you want to delete this video block?</h6>
                        </div>
                        <input type="hidden" id="videoIdToDelete" />
                        <div class="modal-footer">
                            <button id="cancelDeleteVideo" type="reset"
                                class="btn light">Cancel</button>
                            <button type="submit" id="deleteVideo"
                                class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Delete ChoiceBlock Modal -->
            <div id="confirmDeleteChoiceBlockAlert" class="modal"
                tabindex="-1" role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h6>Are you sure you want to delete this
                                choices Block?
                            </h6>
                        </div>
                        <div class="modal-footer">
                            <button id="cancelDeleteChoiceBlock"
                                type="reset" class="btn light">Cancel</button>
                            <button type="submit" id="deleteChoiceBlock"
                                class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="addTextAlert" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document" th:draggable="true">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add new Text Block</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="textForm" id="textUploadForm"
                            enctype="multipart/form-data" method="post">
                            <div class="modal-body">
                                <h6>
                                    <small>Enter Text: </small>
                                </h6>
                                <textarea class="form-control"
                                    id="textBlockText" rows="3"></textarea>
                            </div>
                            <div class="modal-footer">
                                <button id="cancelSubmitText" type="reset"
                                    class="btn light">Cancel</button>
                                <button type="submit" id="submitText"
                                    class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="editTextAlert" class="modal" tabindex="-1"
                role="dialog" th:draggable="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Text Block</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="textForm" id="textEditUploadForm"
                            enctype="multipart/form-data" method="post">
                            <div class="modal-body">
                                <h6>
                                    <small>Edit Text: </small>
                                </h6>
                                <textarea class="form-control"
                                    id="editTextBlock" rows="3"></textarea>
                            </div>
                            <div class="modal-footer">
                                <button id="cancelTextBlock" type="reset"
                                    class="btn light">Cancel</button>
                                <button type="submit" id="submitTextBlock"
                                    class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="addImgAlert" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document" th:draggable="true">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add new Image Block</h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="photoForm" id="imageUploadForm"
                            enctype="multipart/form-data" method="post">
                            <div class="modal-body">
                                <input type="radio" id="chooseFromLocal" name ="uploadRadioBtn" checked/>
                                <h6>
                                    <small>Upload Image: </small>
                                </h6>
                                <input class="form-control" type="file"
                                    name="file" rows="5" cols="500"
                                    id="file" />
                                <input type="radio" id="chooseFromExisting" name ="uploadRadioBtn" />       
                                <div>
                                    <h6>
                                        <small>Or choose an existing image: </small>
                                    </h6>
                                    <select id="imageId" name="imageId"
                                        class="form-control-xs target"
                                        style="height: 50px; width: 200px;">
                                        <option selected value="">Choose from existing</option>
                                    </select>
                                </div>
                                <div>
                                    <span id="selectedImage" width="200px"></span>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button id="cancelImageBtn" type="reset"
                                    class="btn light">Cancel</button>
                                <button type="submit" id="uploadImage"
                                    class="btn btn-primary" data-value="">Upload
                                Image</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div id="createExternalLinkAlert" class="custom_form_style" style="z-index: 1;">
	        <div class="divider"></div>
	        <form id="createExternalLinkForm" style="z-index: 1;">
	            <div role="alert" style="margin-top: 30px;">
                    <div class = "saveLoader" style="font-size: 30px; display: none; text-align: center;">
                        <i class="fa fa-spinner fa-spin" aria-hidden="true"></i>
                    </div>
	            	<div class="row">	
	            		<div class="col">
	            			<h5 class="alert-heading">Create new External Link</h5>
			                <p>Please click on the image where you
			                   want to place the new external link. Then click
			                   "Create External Link".</p>
	            		</div>
	                </div>
	
	                <input type="hidden" name="x" id="externalLinkX" /> 
	                <input type="hidden" name="y" id="externalLinkY" /> 
	                
	                <div class="row">
	                	<div class="col-sm-4">
	                		<label>Label</label>
	                	</div>
	                	<div class="col-sm-8">
	                		<input class="form-control-sm extlink-target" type="text" style="width: inherit; background: var(--base-grey)"
	                			 name="externalLinkLabel" id="externalLinkLabel">	
	                	</div>
	                </div>
	                 
	                <div class="row">
	                	<div class="col-sm-4">
	                		<label>External Link</label>
	                	</div>
	                	<div class="col-sm-8">
	                		<input class="form-control-sm extlink-target" type="text" style="width: inherit; background: var(--base-grey)"
	                    		size="15" name="url" id="externalLink">	
	                	</div>
	                </div>               
					<div class="row">
	                    <div class="col-sm-4">
	                        <label>How To Open:</label>
	                    </div>
	                    <div class="col-sm-8">
	                        <select id="extTabOpen" name="tabOpen" class="form-control-sm extlink-target" style="width: inherit; background: var(--base-grey)">
	                            <option th:selected>Choose...</option>
	                            <option th:value="NEWWINDOW">New Window</option>
	                            <option th:value="SAMEWINDOW">Same Window</option>
	                        </select>
	                    </div>
	                </div>
	                <div class="row">
	                    <div class="col-sm-4">
	                        <label>Type</label>
	                    </div>
	                    <div class="col-sm-8">
	                        <select id="extType" name="type" class="form-control-sm extlink-target" style="width: inherit; background: var(--base-grey)">
	                            <option th:selected>Choose...</option>
	                            <option th:value="IMAGE">Image</option>
	                            <option th:value="ARROW">Link</option>
	                        </select>
	                    </div>
	                </div>
	
	                <div class="row">
	                    <div class="col-sm-4">
	                        <label>Image</label>
	                    </div>
	                    <div class="col-sm-8">
	                        <input type="file" class="form-control-sm" name="externalLinkImage" id="externalLinkImage" style="width: inherit">
	                    </div>
	                </div>
	                <p class="mt-5 text-center">
	                    <button type="reset" class="btn btn-light cancelExternalLinkBtn btn-sm">Cancel</button>
	                    <button id="createExternalLinkBtn" type="submit" class="btn primary-btn btn-sm">Create External Link</button>
	                </p>
	            </div>
	        </form>
		</div>
        
        <div id="editExternalLinkInfo" class="custom_form_style" style="z-index: 1;">
            <div class="divider"></div>
            <form id="editExternalLinkForm" style="z-index: 1;">
                <p class="float-right">
                    <a href="#" id="closeEditExternalLinkInfo" class="icon-circle-close"></a>
                </p>
                <div role="alert" style="margin-top: 30px;">
                    <div class = "saveLoader" style="font-size: 30px; display: none; text-align: center;">
                        <i class="fa fa-spinner fa-spin" aria-hidden="true"></i>
                    </div>
                    <div class="row">
                        <div class="col">
                            <h6 class="alert-heading">
                                <span style="color: var(--dark-grey)">Modify External
                                    Link: </span><span
                                    id="externalLinkInfoLabelEdit"></span>
                            </h6>
                            <p>Please click on the image where you
                                want to place the existing external
                                link. Then click "Edit External Link".</p>
                        </div>
                    </div>
                    <input type="hidden" name="externalLinkIdValueEdit"
                        id="externalLinkIdValueEdit" />
                    <input type="hidden" name="x" id="externalLinkXEdit" />
                    <input type="hidden" name="y" id="externalLinkYEdit" />
                    <input type="hidden" name="externalLinkDisplayId"
                        id="externalLinkDisplayId" />

                    <div class="row">
                        <div class="col-sm-4">
                            <label>Label:</label>
                        </div>
                        <div class="col-sm-8">
                            <input
                                class="form-control-sm externallink-targetEdit"
                                type="text" name="externalLinkLabel"
                                id="externalLinkLabelEdit"
                                style="width: inherit; background: var(--base-grey)"><br>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-4" style="padding-right: 0;">
                            <label>External Link
                            </label>
                        </div>
                        <div class="col-sm-8">
                            <input
                                class="form-control-sm externallink-targetEdit"
                                type="text" name="url"
                                id="externalLinkURLEdit"
                                style="width: inherit; background: var(--base-grey)">
                        </div>
                    </div>
					<div class="row">
	                    <div class="col-sm-4">
	                        <label>How To Open:</label>
	                    </div>
	                    <div class="col-sm-8">
	                        <select id="extTabOpenEdit" name="tabOpen" class="form-control-sm extlink-target" style="width: inherit; background: var(--base-grey)">
	                            <option th:value="NEWWINDOW">New Window</option>
	                            <option th:value="SAMEWINDOW">Same Window</option>
	                        </select>
	                    </div>
	                </div>
                    <div class="row">
                        <div class="col-sm-4">
                            <label>Type:</label>
                        </div>
                        <div class="col-sm-8">
                            <select id="extTypeEdit" name="type"
                                class="form-control-sm externallink-targetEdit">
                                <option th:value="IMAGE">Image</option>
                                <option th:value="ARROW">Link</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-3" style="padding-right: 0;">
                            <label>Image:</label>
                        </div>
                        <div class="col-sm-9">
                            <input type="file" class="form-control-sm"
                                name="externalLinkImage"
                                id="externalLinkImageEdit" style="width: inherit" />
                        </div>
                    </div>
                    
                    <p class="mt-5 text-center">
                        <button id="deleteExternalLinkButton" type="reset" class="btn delete-btn btn-sm"><i class="fa fa-trash"></i>Delete</button>
                        <button id="editExternalLinkBtn" type="reset" class="btn primary-btn btn-sm">Save External Link</button>
                    </p>
                    
                </div>
            </form>
        </div>
        
            <div id="addVideoAlert" class="modal" tabindex="-1" role="dialog" aria-hidden="true">
				<div class="modal-dialog" role="document" draggable="true">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">Add New Video Block</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<form name="videoForm" id="videoUploadForm" enctype="multipart/form-data" method="post">
							<div class="modal-body" style="background: var(--base-grey)">
								<div role="tabpanel">
									<ul class="nav nav-tabs" role="tablist">
										<li role="presentation" id="uploadLink" class="active show"><a class="active show nav-link" href="#uploadTab"
												aria-controls="uploadTab" role="tab" data-toggle="tab">Upload</a></li>
										<li role="presentation" id="urlLink"><a class="nav-link" href="#urlTab" aria-controls="urlTab" role="tab"
												data-toggle="tab">Link</a></li>
									</ul>
									<!-- Tab panes -->
									<div class="tab-content">
									<br/>
										<label for="videoFile">Video Title:</label><input class="form-control" id="videoTitle" type="text" name="videoTitle"/>
										<div role="tabpanel" class="tab-pane active" id="uploadTab"><br />
											<label for="videoFile">Upload Video in any of these format ( MP4, MOV, WEBM, MKV )<br>Note that not all encodings are supported. For .mov files make sure the encoding is H.264</label><input  id="videoFile" class="form-control-file" type="file" name="videoFile"/>
										</div>
										<div role="tabpanel" class="tab-pane" id="urlTab"><br />
											<label for="videoLink">Enter URL: </label><input class="form-control" type="text" placeholder="Use Video Embed Link..." name="videoLink" rows="5" cols="500"
												id="videoLink" />
										</div>
									</div>
								</div>
							</div>
							<div class="modal-footer">
								<button id="cancelVideoBtn" type="reset" class="btn light">Cancel</button>
								<button type="submit" id="saveVideo" class="btn btn-primary" disabled>Upload
									Video</button>
							</div>
						</form>
					</div>
				</div>
			</div>
            <div id="loginAlert" class="modal" tabindex="-1" role="dialog"
                backdrop="static"
                style="display: none; background-color: rgba(0, 0, 0, 0.5);">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Login</h5>
                        </div>
                        <div class="modal-body">
                            <h6>You are not logged in, please login.</h6>
                        </div>
                        <div class="modal-footer">
                            <a class="btn btn-primary" style="color: white;"
                                onClick="window.location.reload();">Login</a>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <div id="addChoiceAlert" class="modal" tabindex="-1"
                role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select from the
                                Choices
                            </h5>
                            <button type="button" class="close"
                                data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form name="choiceForm" id="choiceForm"
                            enctype="multipart/form-data" method="post">
                            <div id="choiceDiv" class="modal-body">
                                <input class="choiceOptions"
                                    id="showAllChoices" type="checkbox"
                                    name="showAll" value="showAll"
                                    checked="true" /> <label for="showAll">Always
                                show all choices</label><br />
                                <div id="selectChoices">
                                    <div th:each="choice: ${choices}">
                                        <input class="choiceOptions"
                                            th:id="${choice.id}"
                                            type="checkbox"
                                            th:name="${choice.sequence.name}"
                                            th:value="${choice.sequence.name}" />
                                        <label th:for="${choice.id}">[[${choice.sequence.name}]]</label>
                                        <br />
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button id="cancelSubmitChoice" type="reset"
                                    class="btn light">Cancel</button>
                                <button type="submit" id="submitChoices"
                                    class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div id="slideSpace">
                <div th:each="contents: ${slideContents}">
                    <div th:attr="data-position=${contents.contentOrder}" th:id="${contents.id}" class="valueDiv tab row" th:if="${#strings.equals(contents['class'].simpleName,'ImageBlock')}">
                        <img th:id="${contents.id}" class="imgDiv" th:src="@{'/api/image/'+${contents.image.id}}" />
                        <input type="hidden" id="deleteImageId" th:value="${contents.id}"> 
                        <a class="btn deleteImage col-md-1" href="javascript:;" style="position:absolute; right:25px;"> 
                        <span class="icon-trash error"></span>
                        </a>
                    </div>
                     <div th:attr="data-position=${contents.contentOrder}" class="tab vidDiv row" th:id="${contents.id}" th:if="${#strings.equals(contents['class'].simpleName,'VideoBlock')}">
	                    <div>
	                    	<h3><strong>[[${contents.video.title}]]</strong></h3>
	                    	<br/>
	                    	<iframe th:id="${contents.id}" width="800" height="530" th:src="${contents.video.url}" th:if="${contents.video.url}" frameborder="0"
								allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
								allowfullscreen ></iframe>
							<video th:id="${contents.id}" width="800" height="530" th:if="${contents.video.url == null}" controls >
							  <source th:src="@{'/api/video/'+${contents.video.id}}" type="video/mp4"/>
							</video>
	                    </div>
	                    
	                    <a class="btn deleteVideo col-md-1" href="javascript:;" th:attr="data-video-id=${contents.id}" style="position:absolute; right:25px;"> 
	                        <span class="icon-trash error"></span>
	                    </a>
	                    <a class="btn editVideo col-md-1" href="javascript:;" th:attr="data-editvideo-id=${contents.id}" style="position:absolute; top:60px;right:25px;"> 
	                        <span class="icon-edit"></span>
	                    </a>
                	</div>
                    <div th:attr="data-position=${contents.contentOrder}" style="word-break:break-word;" th:id="${contents.id}" class="textDivStaff tab row" th:if="${#strings.equals(contents['class'].simpleName,'TextBlock')}">
                        <p class="col-md-10"> [[${contents.text}]]</p>
                        <input type="hidden" id="deleteTextId" th:value="${contents.id}" />
                        <a class="btn deleteText col-md-1" href="javascript:;"> 
                        <span class="icon-trash error"></span>
                        </a>
                    </div>
                    <div th:attr="data-position=${contents.contentOrder}" th:id="${contents.id}" class="choiceDiv tab row" th:if="${#strings.equals(contents['class'].simpleName,'ChoiceBlock')}" style="display:block;">
                        <a th:if="${contents.showsAll}" th:each="choice: ${choices}" style="display:block; color: var(--primary);"
                            th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${choice.sequence.id}}">[[${choice.sequence.name}]]</a>
                        <a th:if="!${contents.showsAll}" th:each="choice: ${contents.choices}" style="display:block; color: var(--primary);"
                            th:href="@{'/staff/module/'+${module.id}+'/sequence/'+${choice.sequence.id}}">[[${choice.sequence.name}]]</a>
                        <input type="hidden" class="col-md-8" id="deleteChoiceBlockId" th:value="${contents.id}"> 
                        <a class="btn deleteChoiceBlock col-md-1" href="javascript:;" style="position:absolute; right:0; top: 0;">
                        <span class="icon-trash error"></span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>